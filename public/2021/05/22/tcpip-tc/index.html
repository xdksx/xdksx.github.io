<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.7.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xdksx.github.io","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="流量控制概述linux下通过tc traffic control 框架及系列实现和工具来实现对出口，甚至入口流量的控制，所谓的控制，就是进行包延迟传输，丢包，包损坏，带宽限制，针对某个ip规则进行限制等等，来达到模拟网络异常状况，包优先级传输，或者更多功能；">
<meta name="keywords" content="tcpip_tc">
<meta property="og:type" content="article">
<meta property="og:title" content="tcpip_tc">
<meta property="og:url" content="https://xdksx.github.io/2021/05/22/tcpip-tc/index.html">
<meta property="og:site_name" content="追光者">
<meta property="og:description" content="流量控制概述linux下通过tc traffic control 框架及系列实现和工具来实现对出口，甚至入口流量的控制，所谓的控制，就是进行包延迟传输，丢包，包损坏，带宽限制，针对某个ip规则进行限制等等，来达到模拟网络异常状况，包优先级传输，或者更多功能；">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2021-05-23T02:38:45.644Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="tcpip_tc">
<meta name="twitter:description" content="流量控制概述linux下通过tc traffic control 框架及系列实现和工具来实现对出口，甚至入口流量的控制，所谓的控制，就是进行包延迟传输，丢包，包损坏，带宽限制，针对某个ip规则进行限制等等，来达到模拟网络异常状况，包优先级传输，或者更多功能；">

<link rel="canonical" href="https://xdksx.github.io/2021/05/22/tcpip-tc/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>tcpip_tc | 追光者</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">追光者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">小兴的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-观影">

    <a href="/movies/" rel="section"><i class="fa fa-fw fa-film"></i>观影</a>

  </li>
        <li class="menu-item menu-item-阅读">

    <a href="/read/" rel="section"><i class="fa fa-fw fa-book"></i>阅读</a>

  </li>
        <li class="menu-item menu-item-心理">

    <a href="/categories/心理/" rel="section"><i class="fa fa-fw fa-heart"></i>心理</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xdksx.github.io/2021/05/22/tcpip-tc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/headicon2.jpg">
      <meta itemprop="name" content="小兴">
      <meta itemprop="description" content="始于歧路，愿归于征途">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追光者">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          tcpip_tc
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-22 19:35:21" itemprop="dateCreated datePublished" datetime="2021-05-22T19:35:21+08:00">2021-05-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-23 10:38:45" itemprop="dateModified" datetime="2021-05-23T10:38:45+08:00">2021-05-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tcpip/" itemprop="url" rel="index"><span itemprop="name">tcpip</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="流量控制概述"><a href="#流量控制概述" class="headerlink" title="流量控制概述"></a>流量控制概述</h3><p>linux下通过tc traffic control 框架及系列实现和工具来实现对出口，甚至入口流量的控制，所谓的控制，就是进行包延迟传输，<br>丢包，包损坏，带宽限制，针对某个ip规则进行限制等等，来达到模拟网络异常状况，包优先级传输，或者更多功能；<a id="more"></a><br>从手册上看：主要提供一下几种控制：<br>SHAPING: 平滑突发流量，如限制传输速率，小于有效带宽，作用于出口<br>       When traffic is shaped, its rate of transmission is under<br>       control. Shaping may be more than lowering the available<br>       bandwidth - it is also used to smooth out bursts in<br>       traffic for better network behaviour. Shaping occurs on<br>       egress.<br>SCHEDULING : 作用于出口，调度数据包的传输，比如优先级等<br>       By scheduling the transmission of packets it is possible<br>       to improve interactivity for traffic that needs it while<br>       still guaranteeing bandwidth to bulk transfers. Reordering<br>       is also called prioritizing, and happens only on egress.<br>POLICING： 作用于入口流量<br>       Whereas shaping deals with transmission of traffic,<br>       policing pertains to traffic arriving. Policing thus<br>       occurs on ingress.<br>DROPPING： 当流量超过阈值，丢弃数据包，作用于入口和出口；<br>       Traffic exceeding a set bandwidth may also be dropped<br>       forthwith, both on ingress and on egress.<br><!--more--></p>
<h4 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h4><p>ref:  <a href="https://netbeez.net/blog/how-to-use-the-linux-traffic-control/" target="_blank" rel="noopener">https://netbeez.net/blog/how-to-use-the-linux-traffic-control/</a><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">查看：当前只有默认的先入先出规则</span><br><span class="line">think@think-VirtualBox:~$ tc qdisc</span><br><span class="line">qdisc noqueue <span class="number">0</span>: dev lo root refcnt <span class="number">2</span> </span><br><span class="line">qdisc pfifo_fast <span class="number">0</span>: dev eth0 root refcnt <span class="number">2</span> bands <span class="number">3</span> priomap  <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">准备设置延迟：</span><br><span class="line">think@think-VirtualBox:~$ ping www.baidu.com</span><br><span class="line">PING www.baidu.com (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of data.</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">56</span> time=<span class="number">9.13</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>: icmp_seq=<span class="number">2</span> ttl=<span class="number">56</span> time=<span class="number">9.38</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>: icmp_seq=<span class="number">3</span> ttl=<span class="number">56</span> time=<span class="number">9.09</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>: icmp_seq=<span class="number">4</span> ttl=<span class="number">56</span> time=<span class="number">9.68</span> ms</span><br><span class="line">^C</span><br><span class="line">--- www.baidu.com ping statistics ---</span><br><span class="line"><span class="number">4</span> packets transmitted, <span class="number">4</span> received, <span class="number">0</span>% packet loss, time <span class="number">7048</span>ms</span><br><span class="line">rtt min/avg/max/mdev = <span class="number">9.093</span>/<span class="number">9.324</span>/<span class="number">9.687</span>/<span class="number">0.256</span> ms</span><br><span class="line"></span><br><span class="line">添加延迟规则：</span><br><span class="line">think@think-VirtualBox:~$ sudo tc qdisc add dev eth0 root netem delay <span class="number">200</span>ms</span><br><span class="line"></span><br><span class="line">think@think-VirtualBox:~$ ping www.baidu.com</span><br><span class="line">PING www.baidu.com (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of data.</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">56</span> time=<span class="number">209</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>: icmp_seq=<span class="number">2</span> ttl=<span class="number">56</span> time=<span class="number">212</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>: icmp_seq=<span class="number">3</span> ttl=<span class="number">56</span> time=<span class="number">211</span> ms</span><br><span class="line"></span><br><span class="line">删除规则： sudo tc qdisc del dev eth0 root netem delay <span class="number">200</span>ms</span><br><span class="line">/ sudo tc qdisc del dev eth0 root </span><br><span class="line"></span><br><span class="line">设置丢包规则：</span><br><span class="line">think@think-VirtualBox:~$ sudo tc qdisc add dev eth0 root netem loss <span class="number">20</span>%</span><br><span class="line">[sudo] password <span class="keyword">for</span> think: </span><br><span class="line">think@think-VirtualBox:~$ ping www.baidu.com -c <span class="number">100</span></span><br><span class="line">PING www.baidu.com (<span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of data.</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">56</span> time=<span class="number">9.68</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>: icmp_seq=<span class="number">2</span> ttl=<span class="number">56</span> time=<span class="number">8.92</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>: icmp_seq=<span class="number">3</span> ttl=<span class="number">56</span> time=<span class="number">8.92</span> ms</span><br><span class="line">。。。</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">14.215</span><span class="number">.177</span><span class="number">.39</span>: icmp_seq=<span class="number">100</span> ttl=<span class="number">56</span> time=<span class="number">10.1</span> ms</span><br><span class="line"></span><br><span class="line">--- www.baidu.com ping statistics ---</span><br><span class="line"><span class="number">100</span> packets transmitted, <span class="number">80</span> received, <span class="number">20</span>% packet loss, time <span class="number">103846</span>ms</span><br><span class="line">rtt min/avg/max/mdev = <span class="number">8.510</span>/<span class="number">9.537</span>/<span class="number">23.505</span>/<span class="number">1.655</span> ms</span><br><span class="line">删除规则：</span><br><span class="line">think@think-VirtualBox:~$ sudo tc qdisc del dev eth0 root netem loss <span class="number">20</span>%</span><br><span class="line"></span><br><span class="line">设置带宽限制规则：</span><br><span class="line">tc qdisc add dev eth0 root tbf rate <span class="number">1</span>mbit burst <span class="number">32</span>kbit latency <span class="number">400</span>ms</span><br><span class="line"></span><br><span class="line">tbf: use the token buffer filter to manipulate traffic rates</span><br><span class="line">rate: sustained maximum rate</span><br><span class="line">burst: maximum allowed burst</span><br><span class="line">latency: packets with higher latency get dropped</span><br><span class="line"></span><br><span class="line">通过iperf测试：</span><br><span class="line">iperf -c <span class="number">172.31</span><span class="number">.0</span><span class="number">.142</span></span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Client connecting to <span class="number">172.31</span><span class="number">.0</span><span class="number">.142</span>, TCP port <span class="number">5001</span></span><br><span class="line">TCP window size: <span class="number">85.3</span> KByte (<span class="keyword">default</span>)</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">[  <span class="number">3</span>] local <span class="number">172.31</span><span class="number">.0</span><span class="number">.25</span> port <span class="number">40233</span> connected with <span class="number">172.31</span><span class="number">.0</span><span class="number">.142</span> port <span class="number">5001</span></span><br><span class="line">[ ID] Interval       Transfer     Bandwidth</span><br><span class="line">[  <span class="number">3</span>]  <span class="number">0.0</span><span class="number">-10.0</span> sec   <span class="number">113</span> MBytes  <span class="number">95.0</span> Mbits/sec ---&gt; <span class="number">1.1</span>Mbits/sec</span><br></pre></td></tr></table></figure></p>
<ul>
<li>指令解释：<br>qdisc: modify the scheduler (aka queuing discipline) 即实际的使用是依赖的qidsc机制<br>add: add a new rule 添加一个排队规则<br>dev eth0: rules will be applied on device eth0 排队规则作用对象一般是网卡<br>root: modify the outbound traffic scheduler (aka known as the egress qdisc) 修改出口流量调度程序<br>netem: use the network emulator to emulate a WAN property 使用wan网络模拟器<br>delay: the network property that is modified<br>200ms: introduce delay of 200 ms</li>
</ul>
<p>tc是系统如linux提供的用户层操作指令，这里用的是shell指令：<br>更多  <a href="https://man7.org/linux/man-pages/man8/tc.8.html" target="_blank" rel="noopener">https://man7.org/linux/man-pages/man8/tc.8.html</a> </p>
<h3 id="流量控制的基本实现原理"><a href="#流量控制的基本实现原理" class="headerlink" title="流量控制的基本实现原理"></a>流量控制的基本实现原理</h3><p>在linux内核中，流量控制用Qos实现，实际上使用了qdisc队列；主要是出口队列；（egress)<br>在链路层，每个数据包通过邻居子系统后，或者说离开协议栈后，都会由dev_queue_xmit(dev.c)来进一步调用相关设备驱动的发送函数<br>来发送出去； 而qdisc队列，和相关的排队规则即作用在dev_queue_xmit之后，设备驱动发送函数之前；</p>
<h3 id="流量控制的实现和基本流程："><a href="#流量控制的实现和基本流程：" class="headerlink" title="流量控制的实现和基本流程："></a>流量控制的实现和基本流程：</h3><h4 id="相关代码："><a href="#相关代码：" class="headerlink" title="相关代码："></a>相关代码：</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sch_generic.c</span><br><span class="line">sch_generic.h</span><br><span class="line">sch_api.c</span><br><span class="line">pkt_sched.h</span><br><span class="line">net/core/dev.c</span><br></pre></td></tr></table></figure>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><p>在内核中的整体处理流程，及位置：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">net/core/dev.c</span><br><span class="line">int dev_queue_xmit(struct sk_buff *skb) --发送函数</span><br><span class="line">    <span class="comment">// 1 从设备中拿到设备下的qdisc结构，每个设备net_device结构都有</span></span><br><span class="line">  	txq = netdev_pick_tx(dev, skb, accel_priv);</span><br><span class="line">	q = rcu_dereference_bh(txq-&gt;qdisc);</span><br><span class="line"></span><br><span class="line">	trace_net_dev_queue(skb);</span><br><span class="line">	<span class="keyword">if</span> (q-&gt;enqueue) &#123;</span><br><span class="line">		rc = __dev_xmit_skb(skb, q, dev, txq);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//2 插入根排队规则中，并启动运行：</span></span><br><span class="line">	rc = q-&gt;enqueue(skb, q, &amp;to_free) &amp; NET_XMIT_MASK; <span class="comment">//插入根排队规则</span></span><br><span class="line">		<span class="keyword">if</span> (qdisc_run_begin(q)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (unlikely(contended)) &#123;</span><br><span class="line">				spin_unlock(&amp;q-&gt;busylock);</span><br><span class="line">				contended = <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			__qdisc_run(q);<span class="comment">//会走netif_schedule来调度数据包输出软中断 net_tx_action,然后在合适的时机，比如延迟200ms，发送数据包；</span></span><br><span class="line">			在调度前会检查网络设备的启动情况，以及是否已经在调度了；</span><br><span class="line">			<span class="keyword">void</span> __qdisc_run(struct Qdisc *q)</span><br><span class="line">              &#123;</span><br><span class="line">              	<span class="keyword">int</span> quota = weight_p;</span><br><span class="line">              	<span class="keyword">int</span> packets;</span><br><span class="line">              </span><br><span class="line">              	<span class="keyword">while</span> (qdisc_restart(q, &amp;packets)) &#123;</span><br><span class="line">              		<span class="comment">/*</span></span><br><span class="line"><span class="comment">              		 * Ordered by possible occurrence: Postpone processing if</span></span><br><span class="line"><span class="comment">              		 * 1. we've exceeded packet quota</span></span><br><span class="line"><span class="comment">              		 * 2. another process needs the CPU;</span></span><br><span class="line"><span class="comment">              		 */</span></span><br><span class="line">              		quota -= packets;</span><br><span class="line">              		<span class="keyword">if</span> (quota &lt;= <span class="number">0</span> || need_resched()) &#123;</span><br><span class="line">              			__netif_schedule(q);</span><br><span class="line">              			<span class="keyword">break</span>;</span><br><span class="line">              		&#125;</span><br><span class="line">              	&#125;</span><br><span class="line">              </span><br><span class="line">              	qdisc_run_end(q);</span><br><span class="line">              &#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    dev.c:</span><br><span class="line">	net_tx_action:</span><br><span class="line">	smp_mb__before_atomic();</span><br><span class="line">			clear_bit(__QDISC_STATE_SCHED, &amp;q-&gt;state);</span><br><span class="line">			qdisc_run(q);</span><br><span class="line">			spin_unlock(root_lock);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//3 qdisc_run/ __qdisc_run都会调用qdisc_restart，当可以发送时</span></span><br><span class="line">	<span class="comment">//这个restart函数，将包从根排队规则中取出，然后调用设备发送函数发送：</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">qdisc_restart</span><span class="params">(struct Qdisc *q, <span class="keyword">int</span> *packets)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    	<span class="class"><span class="keyword">struct</span> <span class="title">netdev_queue</span> *<span class="title">txq</span>;</span></span><br><span class="line">    	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    	<span class="keyword">spinlock_t</span> *root_lock;</span><br><span class="line">    	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">    	<span class="keyword">bool</span> validate;</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">/* Dequeue packet */</span></span><br><span class="line">    	skb = dequeue_skb(q, &amp;validate, packets);</span><br><span class="line">    	<span class="keyword">if</span> (unlikely(!skb))</span><br><span class="line">    		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    	root_lock = qdisc_lock(q);</span><br><span class="line">    	dev = qdisc_dev(q);</span><br><span class="line">    	txq = skb_get_tx_queue(dev, skb);</span><br><span class="line">         <span class="comment">//4 发送</span></span><br><span class="line">    	<span class="keyword">return</span> sch_direct_xmit(skb, q, dev, txq, root_lock, validate);----&gt;ops-&gt;ndo_start_xmit(skb, dev);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="流量控制的结构："><a href="#流量控制的结构：" class="headerlink" title="流量控制的结构："></a>流量控制的结构：</h4><p>构成流量控制的基本元素有三种： 排队规则，类和过滤器<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">排队规则1:0</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>  <span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">根排队规则，提供两个外部接口，enqueue和dequeue</span></span><br><span class="line"><span class="comment"></span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">过滤器1</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">过滤器2</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">过滤器3</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span></span><br><span class="line"><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span></span><br><span class="line"><span class="literal">-</span><span class="literal">-</span><span class="comment">类1:1</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">(类</span>  <span class="comment">1:2</span>  <span class="comment">)</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span></span><br><span class="line"><span class="literal">-</span><span class="literal">-</span><span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">|</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span></span><br><span class="line"><span class="literal">-</span><span class="literal">-</span><span class="comment">排队规则2:0</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">排队规则3:0</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">内部规则</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>排队规则：<br>  在启用了流量控制的情况下，每个网络设备至少会配置一个排队规则；排队规则包括简单的fifo缓冲和令牌桶等，而精确的排队规则通常需要管理多个队列；<br>常见的排队规则由 fifo,令牌桶tbf(token bucket filter)等；</li>
<li>排队规则的分类：<br>排队规则至少有一个队列，可能简单，如fifo排队规则，也有复杂如令牌桶；通常排队规则分无类和有类两种，无类规则简单，内部不能包含可配置的子类及内部规则<br>而有类则可包含多个类，如上图，且每个类又可以包含一个排队规则，这里的排队规则叫内部规则，可以是有类和无类的；<br>无类规则不可被用户配置，而有类的可以；<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   分为可分类的qdisc和不可分类的qdisc实现：</span><br><span class="line">不可分类：pfifo ,pfifo_fast,<span class="built_in">red</span>,sfq,tbf</span><br><span class="line">可分类：cbq,htb,prio</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>如默认：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qdisc pfifo_fast <span class="number">0</span>: dev eth0 root refcnt <span class="number">2</span> bands <span class="number">3</span> priomap  <span class="number">1</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>在tc指令中，如下的，其中结尾的 qdisc [qdisc specific parameters] 就是指定具体的排队规则类型；<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line">创建qdisc 规则</span><br><span class="line">tc [ OPTIONS ] qdisc [ add | change | replace | link | <span class="keyword">delete</span> ]</span><br><span class="line">       dev DEV [ parent qdisc-id | root ] [ handle qdisc-id ] [</span><br><span class="line">       ingress_block BLOCK_INDEX ] [ egress_block BLOCK_INDEX ] qdisc [</span><br><span class="line">       qdisc specific parameters ]</span><br><span class="line">eg:</span><br><span class="line"></span><br><span class="line">目前支持的qdisc: 无类的：</span><br><span class="line">The classless qdiscs are:</span><br><span class="line"></span><br><span class="line">       <span class="function">choke  <span class="title">CHOKe</span> <span class="params">(CHOose <span class="keyword">and</span> Keep <span class="keyword">for</span> responsive flows, CHOose <span class="keyword">and</span></span></span></span><br><span class="line"><span class="function"><span class="params">              Kill <span class="keyword">for</span> unresponsive flows)</span> is a classless qdisc designed</span></span><br><span class="line"><span class="function">              to both identify <span class="keyword">and</span> penalize flows that monopolize the</span></span><br><span class="line">              queue. CHOKe is a variation of RED, and the configuration</span><br><span class="line">              is similar to RED.</span><br><span class="line"></span><br><span class="line">       codel  CoDel (pronounced "coddle") is an adaptive "no-knobs"</span><br><span class="line">              <span class="function">active <span class="built_in">queue</span> management <span class="title">algorithm</span> <span class="params">(AQM)</span> scheme that was</span></span><br><span class="line"><span class="function">              developed to address the shortcomings of RED <span class="keyword">and</span> its</span></span><br><span class="line">              variants.</span><br><span class="line"></span><br><span class="line">       [p|b]fifo</span><br><span class="line">              Simplest usable qdisc, pure First In, First Out behaviour.</span><br><span class="line">              Limited in packets <span class="keyword">or</span> in bytes.</span><br><span class="line"></span><br><span class="line">       fq     Fair Queue Scheduler realises TCP pacing <span class="keyword">and</span> scales to</span><br><span class="line">              millions of concurrent flows per qdisc.</span><br><span class="line"></span><br><span class="line">       fq_codel</span><br><span class="line">              Fair Queuing Controlled Delay is queuing discipline that</span><br><span class="line">              combines Fair Queuing with the CoDel AQM scheme. FQ_Codel</span><br><span class="line">              uses a stochastic model to classify incoming packets into</span><br><span class="line">              different flows <span class="keyword">and</span> is used to provide a fair share of the</span><br><span class="line">              bandwidth to all the flows <span class="keyword">using</span> the <span class="built_in">queue</span>. Each such flow</span><br><span class="line">              is managed by the CoDel queuing discipline. Reordering</span><br><span class="line">              within a flow is avoided since Codel internally uses a</span><br><span class="line">              FIFO <span class="built_in">queue</span>.</span><br><span class="line"></span><br><span class="line">       fq_pie FQ-PIE (Flow Queuing with Proportional Integral controller</span><br><span class="line">              Enhanced) is a queuing discipline that combines Flow</span><br><span class="line">              Queuing with the PIE AQM scheme. FQ-PIE uses a Jenkins</span><br><span class="line">              hash function to classify incoming packets into different</span><br><span class="line">              flows <span class="keyword">and</span> is used to provide a fair share of the bandwidth</span><br><span class="line">              to all the flows <span class="keyword">using</span> the qdisc. Each such flow is</span><br><span class="line">              managed by the PIE algorithm.</span><br><span class="line"></span><br><span class="line">       gred   Generalized Random Early Detection combines multiple RED</span><br><span class="line">              queues in order to achieve multiple drop priorities. This</span><br><span class="line">              is required to realize Assured Forwarding (RFC 2597).</span><br><span class="line"></span><br><span class="line">       hhf    Heavy-Hitter Filter differentiates between small flows <span class="keyword">and</span></span><br><span class="line">              the opposite, heavy-hitters. The goal is to <span class="keyword">catch</span> the</span><br><span class="line">              heavy-hitters <span class="keyword">and</span> move them to a separate <span class="built_in">queue</span> with less</span><br><span class="line">              priority so that bulk traffic does <span class="keyword">not</span> affect the latency</span><br><span class="line">              of critical traffic.</span><br><span class="line"></span><br><span class="line">       ingress</span><br><span class="line">              This is a special qdisc as it applies to incoming traffic</span><br><span class="line">              on an interface, allowing <span class="keyword">for</span> it to be filtered <span class="keyword">and</span></span><br><span class="line">              policed.</span><br><span class="line"></span><br><span class="line">       mqprio The Multiqueue Priority Qdisc is a simple queuing</span><br><span class="line">              discipline that allows mapping traffic flows to hardware</span><br><span class="line">              <span class="built_in">queue</span> ranges <span class="keyword">using</span> priorities <span class="keyword">and</span> a configurable priority</span><br><span class="line">              to traffic <span class="class"><span class="keyword">class</span> <span class="title">mapping</span>. <span class="title">A</span> <span class="title">traffic</span> <span class="title">class</span> <span class="title">in</span> <span class="title">this</span> <span class="title">context</span></span></span><br><span class="line"><span class="class">              <span class="title">is</span> <span class="title">a</span> <span class="title">set</span> <span class="title">of</span> <span class="title">contiguous</span> <span class="title">qdisc</span> <span class="title">classes</span> <span class="title">which</span> <span class="title">map</span> 1:</span><span class="number">1</span> to a</span><br><span class="line">              <span class="built_in">set</span> of hardware exposed queues.</span><br><span class="line"></span><br><span class="line">       multiq Multiqueue is a qdisc optimized <span class="keyword">for</span> devices with multiple</span><br><span class="line">              Tx queues. It has been added <span class="keyword">for</span> hardware that wishes to</span><br><span class="line">              avoid head-of-line blocking.  It will cycle though the</span><br><span class="line">              bands <span class="keyword">and</span> verify that the hardware <span class="built_in">queue</span> associated with</span><br><span class="line">              the band is <span class="keyword">not</span> stopped prior to dequeuing a packet.</span><br><span class="line"></span><br><span class="line">       netem  Network Emulator is an enhancement of the Linux traffic</span><br><span class="line">              control facilities that allow to add delay, packet loss,</span><br><span class="line">              duplication <span class="keyword">and</span> more other characteristics to packets</span><br><span class="line">              outgoing from a selected network interface.</span><br><span class="line"></span><br><span class="line">       pfifo_fast</span><br><span class="line">              Standard qdisc for 'Advanced Router' enabled kernels.</span><br><span class="line">              Consists of a three-band <span class="built_in">queue</span> which honors Type of</span><br><span class="line">              Service flags, as well as the priority that may be</span><br><span class="line">              assigned to a packet.</span><br><span class="line"></span><br><span class="line">       pie    Proportional Integral controller-Enhanced (PIE) is a</span><br><span class="line">              control theoretic active <span class="built_in">queue</span> management scheme. It is</span><br><span class="line">              based on the proportional integral controller but aims to</span><br><span class="line">              control delay.</span><br><span class="line"></span><br><span class="line">       red    Random Early Detection simulates physical congestion by</span><br><span class="line">              randomly dropping packets when nearing configured</span><br><span class="line">              bandwidth allocation. Well suited to very large bandwidth</span><br><span class="line">              applications.</span><br><span class="line"></span><br><span class="line">       rr     Round-Robin qdisc with support <span class="keyword">for</span> multiqueue network</span><br><span class="line">              devices. Removed from Linux since kernel version <span class="number">2.6</span><span class="number">.27</span>.</span><br><span class="line"></span><br><span class="line">       sfb    Stochastic Fair Blue is a classless qdisc to manage</span><br><span class="line">              congestion based on packet loss <span class="keyword">and</span> link utilization</span><br><span class="line">              history <span class="keyword">while</span> trying to prevent non-<span class="function">responsive <span class="title">flows</span> <span class="params">(i.e.</span></span></span><br><span class="line"><span class="function"><span class="params">              flows that <span class="keyword">do</span> <span class="keyword">not</span> react to congestion marking <span class="keyword">or</span> dropped</span></span></span><br><span class="line">              packets) from impacting performance of responsive flows.</span><br><span class="line">              Unlike RED, where the marking probability has to be</span><br><span class="line">              configured, BLUE tries to determine the ideal marking</span><br><span class="line">              probability automatically.</span><br><span class="line"></span><br><span class="line">       sfq    Stochastic Fairness Queueing reorders queued traffic so</span><br><span class="line">              each 'session' gets to send a packet in turn.</span><br><span class="line"></span><br><span class="line">       tbf    The Token Bucket Filter is suited <span class="keyword">for</span> slowing traffic down</span><br><span class="line">              to a precisely configured rate. Scales well to large</span><br><span class="line">              bandwidths.</span><br><span class="line">无类的，在添加规则时需要注意：</span><br><span class="line">In the absence of classful qdiscs, classless qdiscs can only be</span><br><span class="line">       attached at the root of a device. Full syntax:</span><br><span class="line">       tc qdisc add dev DEV root QDISC QDISC-PARAMETERS</span><br><span class="line">To remove, issue</span><br><span class="line">       tc qdisc del dev DEV root</span><br><span class="line"> The pfifo_fast qdisc is the automatic <span class="keyword">default</span> in the absence of a</span><br><span class="line">       configured qdisc.</span><br><span class="line">有类的：</span><br><span class="line"></span><br><span class="line">       ATM    Map flows to <span class="keyword">virtual</span> circuits of an underlying</span><br><span class="line">              asynchronous transfer mode device.</span><br><span class="line"></span><br><span class="line">       CBQ    Class Based Queueing implements a rich linksharing</span><br><span class="line">              hierarchy of classes.  It contains shaping elements as</span><br><span class="line">              well as prioritizing capabilities. Shaping is performed</span><br><span class="line">              <span class="keyword">using</span> link idle time calculations based on average packet</span><br><span class="line">              size <span class="keyword">and</span> underlying link bandwidth. The latter may be ill-</span><br><span class="line">              defined <span class="keyword">for</span> some interfaces.</span><br><span class="line"></span><br><span class="line">       DRR    The Deficit Round Robin Scheduler is a more flexible</span><br><span class="line">              replacement <span class="keyword">for</span> Stochastic Fairness Queuing. Unlike SFQ,</span><br><span class="line">              there are no built-in queues -- you need to add classes</span><br><span class="line">              <span class="keyword">and</span> then <span class="built_in">set</span> up filters to classify packets accordingly.</span><br><span class="line">              This can be useful e.g. <span class="keyword">for</span> <span class="keyword">using</span> RED qdiscs with</span><br><span class="line">              different settings <span class="keyword">for</span> particular traffic. There is no</span><br><span class="line">              <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> -- <span class="title">if</span> <span class="title">a</span> <span class="title">packet</span> <span class="title">cannot</span> <span class="title">be</span> <span class="title">classified</span>, <span class="title">it</span> <span class="title">is</span></span></span><br><span class="line"><span class="class">              <span class="title">dropped</span>.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">       <span class="title">DSMARK</span> <span class="title">Classify</span> <span class="title">packets</span> <span class="title">based</span> <span class="title">on</span> <span class="title">TOS</span> <span class="title">field</span>, <span class="title">change</span> <span class="title">TOS</span> <span class="title">field</span> <span class="title">of</span></span></span><br><span class="line"><span class="class">              <span class="title">packets</span> <span class="title">based</span> <span class="title">on</span> <span class="title">classification</span>.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">       <span class="title">ETS</span>    <span class="title">The</span> <span class="title">ETS</span> <span class="title">qdisc</span> <span class="title">is</span> <span class="title">a</span> <span class="title">queuing</span> <span class="title">discipline</span> <span class="title">that</span> <span class="title">merges</span></span></span><br><span class="line"><span class="class">              <span class="title">functionality</span> <span class="title">of</span> <span class="title">PRIO</span> <span class="title">and</span> <span class="title">DRR</span> <span class="title">qdiscs</span> <span class="title">in</span> <span class="title">one</span> <span class="title">scheduler</span>. <span class="title">ETS</span></span></span><br><span class="line"><span class="class">              <span class="title">makes</span> <span class="title">it</span> <span class="title">easy</span> <span class="title">to</span> <span class="title">configure</span> <span class="title">a</span> <span class="title">set</span> <span class="title">of</span> <span class="title">strict</span> <span class="title">and</span> <span class="title">bandwidth</span>-</span></span><br><span class="line"><span class="class">              <span class="title">sharing</span> <span class="title">bands</span> <span class="title">to</span> <span class="title">implement</span> <span class="title">the</span> <span class="title">transmission</span> <span class="title">selection</span></span></span><br><span class="line"><span class="class">              <span class="title">described</span> <span class="title">in</span> 802.1<span class="title">Qaz</span>.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">       <span class="title">HFSC</span>   <span class="title">Hierarchical</span> <span class="title">Fair</span> <span class="title">Service</span> <span class="title">Curve</span> <span class="title">guarantees</span> <span class="title">precise</span></span></span><br><span class="line"><span class="class">              <span class="title">bandwidth</span> <span class="title">and</span> <span class="title">delay</span> <span class="title">allocation</span> <span class="title">for</span> <span class="title">leaf</span> <span class="title">classes</span> <span class="title">and</span></span></span><br><span class="line"><span class="class">              <span class="title">allocates</span> <span class="title">excess</span> <span class="title">bandwidth</span> <span class="title">fairly</span>. <span class="title">Unlike</span> <span class="title">HTB</span>, <span class="title">it</span> <span class="title">makes</span></span></span><br><span class="line"><span class="class">              <span class="title">use</span> <span class="title">of</span> <span class="title">packet</span> <span class="title">dropping</span> <span class="title">to</span> <span class="title">achieve</span> <span class="title">low</span> <span class="title">delays</span> <span class="title">which</span></span></span><br><span class="line"><span class="class">              <span class="title">interactive</span> <span class="title">sessions</span> <span class="title">benefit</span> <span class="title">from</span>.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">       <span class="title">HTB</span>    <span class="title">The</span> <span class="title">Hierarchy</span> <span class="title">Token</span> <span class="title">Bucket</span> <span class="title">implements</span> <span class="title">a</span> <span class="title">rich</span> <span class="title">linksharing</span></span></span><br><span class="line"><span class="class">              <span class="title">hierarchy</span> <span class="title">of</span> <span class="title">classes</span> <span class="title">with</span> <span class="title">an</span> <span class="title">emphasis</span> <span class="title">on</span> <span class="title">conforming</span> <span class="title">to</span></span></span><br><span class="line"><span class="class">              <span class="title">existing</span> <span class="title">practices</span>. <span class="title">HTB</span> <span class="title">facilitates</span> <span class="title">guaranteeing</span> <span class="title">bandwidth</span></span></span><br><span class="line"><span class="class">              <span class="title">to</span> <span class="title">classes</span>, <span class="title">while</span> <span class="title">also</span> <span class="title">allowing</span> <span class="title">specification</span> <span class="title">of</span> <span class="title">upper</span></span></span><br><span class="line"><span class="class">              <span class="title">limits</span> <span class="title">to</span> <span class="title">inter</span>-<span class="title">class</span> <span class="title">sharing</span>. <span class="title">It</span> <span class="title">contains</span> <span class="title">shaping</span></span></span><br><span class="line"><span class="class">              <span class="title">elements</span>, <span class="title">based</span> <span class="title">on</span> <span class="title">TBF</span> <span class="title">and</span> <span class="title">can</span> <span class="title">prioritize</span> <span class="title">classes</span>.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">       <span class="title">PRIO</span>   <span class="title">The</span> <span class="title">PRIO</span> <span class="title">qdisc</span> <span class="title">is</span> <span class="title">a</span> <span class="title">non</span>-<span class="title">shaping</span> <span class="title">container</span> <span class="title">for</span> <span class="title">a</span></span></span><br><span class="line"><span class="class">              <span class="title">configurable</span> <span class="title">number</span> <span class="title">of</span> <span class="title">classes</span> <span class="title">which</span> <span class="title">are</span> <span class="title">dequeued</span> <span class="title">in</span></span></span><br><span class="line"><span class="class">              <span class="title">order</span>. <span class="title">This</span> <span class="title">allows</span> <span class="title">for</span> <span class="title">easy</span> <span class="title">prioritization</span> <span class="title">of</span> <span class="title">traffic</span>,</span></span><br><span class="line"><span class="class">              <span class="title">where</span> <span class="title">lower</span> <span class="title">classes</span> <span class="title">are</span> <span class="title">only</span> <span class="title">able</span> <span class="title">to</span> <span class="title">send</span> <span class="title">if</span> <span class="title">higher</span> <span class="title">ones</span></span></span><br><span class="line"><span class="class">              <span class="title">have</span> <span class="title">no</span> <span class="title">packets</span> <span class="title">available</span>. <span class="title">To</span> <span class="title">facilitate</span> <span class="title">configuration</span>,</span></span><br><span class="line"><span class="class">              <span class="title">Type</span> <span class="title">Of</span> <span class="title">Service</span> <span class="title">bits</span> <span class="title">are</span> <span class="title">honored</span> <span class="title">by</span> <span class="title">default</span>.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">       <span class="title">QFQ</span>    <span class="title">Quick</span> <span class="title">Fair</span> <span class="title">Queueing</span> <span class="title">is</span> <span class="title">an</span> <span class="title">O</span>(1) <span class="title">scheduler</span> <span class="title">that</span> <span class="title">provides</span></span></span><br><span class="line"><span class="class">              <span class="title">near</span>-<span class="title">optimal</span> <span class="title">guarantees</span>, <span class="title">and</span> <span class="title">is</span> <span class="title">the</span> <span class="title">first</span> <span class="title">to</span> <span class="title">achieve</span> <span class="title">that</span></span></span><br><span class="line"><span class="class">              <span class="title">goal</span> <span class="title">with</span> <span class="title">a</span> <span class="title">constant</span> <span class="title">cost</span> <span class="title">also</span> <span class="title">with</span> <span class="title">respect</span> <span class="title">to</span> <span class="title">the</span> <span class="title">number</span></span></span><br><span class="line"><span class="class">              <span class="title">of</span> <span class="title">groups</span> <span class="title">and</span> <span class="title">the</span> <span class="title">packet</span> <span class="title">length</span>. <span class="title">The</span> <span class="title">QFQ</span> <span class="title">algorithm</span> <span class="title">has</span> <span class="title">no</span></span></span><br><span class="line"><span class="class">              <span class="title">loops</span>, <span class="title">and</span> <span class="title">uses</span> <span class="title">very</span> <span class="title">simple</span> <span class="title">instructions</span> <span class="title">and</span> <span class="title">data</span></span></span><br><span class="line"><span class="class">              <span class="title">structures</span> <span class="title">that</span> <span class="title">lend</span> <span class="title">themselves</span> <span class="title">very</span> <span class="title">well</span> <span class="title">to</span> <span class="title">a</span> <span class="title">hardware</span></span></span><br><span class="line"><span class="class">              <span class="title">implementation</span>.</span></span><br><span class="line"><span class="class">			  </span></span><br><span class="line"><span class="class">#创建规则：</span></span><br><span class="line"><span class="class"><span class="title">tc</span> <span class="title">qdisc</span> <span class="title">add</span> <span class="title">dev</span> <span class="title">eth0</span> <span class="title">root</span> <span class="title">handle</span> 1:</span><span class="number">0</span> htb <span class="keyword">default</span> <span class="number">1</span> </span><br><span class="line">#添加一个tbf规则，绑定到eth0上，命名为<span class="number">1</span>:<span class="number">0</span> ，默认归类为<span class="number">1</span></span><br><span class="line"><span class="meta">#handle：为规则命名或指定某规则</span></span><br></pre></td></tr></table></figure></p>
<p>排队规则在内核中的表示结构：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">描述排队规则的结构：</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> 			(*enqueue)(struct sk_buff *skb,   --上面提到的两个函数</span><br><span class="line">					   struct Qdisc *sch,</span><br><span class="line">					   struct sk_buff **to_free);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *	(*<span class="title">dequeue</span>)(<span class="title">struct</span> <span class="title">Qdisc</span> *<span class="title">sch</span>);</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		flags;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">Qdisc_ops</span>	*<span class="title">ops</span>;</span><span class="comment">//队列操作的接口，每个排队规则都必须实现该接口，如pfifo,tbf</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">qdisc_size_table</span>	__<span class="title">rcu</span> *<span class="title">stab</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">list</span>;</span></span><br><span class="line">	u32			handle; <span class="comment">//和tc的handle对应 句柄，排队规则，类和过滤器都有一个32位的句柄标识；</span></span><br><span class="line">	u32			parent; <span class="comment">//父句柄</span></span><br><span class="line">	<span class="keyword">void</span>			*u32_node;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netdev_queue</span>	*<span class="title">dev_queue</span>;</span><span class="comment">//和netdevice挂钩</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span>	<span class="title">q</span>;</span><span class="comment">//队列当前的数据包数</span></span><br><span class="line">    ..</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Qdisc_ops</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Qdisc_ops</span>	*<span class="title">next</span>;</span><span class="comment">//用于链接已注册的各种排队规则的操作接口</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">Qdisc_class_ops</span>	*<span class="title">cl_ops</span>;</span><span class="comment">//所在规则提供的类操作接口</span></span><br><span class="line">	<span class="keyword">char</span>			id[IFNAMSIZ];</span><br><span class="line">	<span class="keyword">int</span>			priv_size;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> 			(*enqueue)(struct sk_buff *skb, <span class="comment">//将数据包加入排队规则的函数</span></span><br><span class="line">					   struct Qdisc *sch,</span><br><span class="line">					   struct sk_buff **to_free);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *	(*<span class="title">dequeue</span>)(<span class="title">struct</span> <span class="title">Qdisc</span> *);</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *	(*<span class="title">peek</span>)(<span class="title">struct</span> <span class="title">Qdisc</span> *);</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>			(*init)(struct Qdisc *, struct nlattr *arg);<span class="comment">//排队规则的初始化</span></span><br><span class="line">	<span class="keyword">void</span>			(*reset)(struct Qdisc *);</span><br><span class="line">	<span class="keyword">void</span>			(*destroy)(struct Qdisc *);</span><br><span class="line">	<span class="keyword">int</span>			(*change)(struct Qdisc *, struct nlattr *arg);</span><br><span class="line">	<span class="keyword">void</span>			(*attach)(struct Qdisc *);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>			(*dump)(struct Qdisc *, struct sk_buff *);</span><br><span class="line">	<span class="keyword">int</span>			(*dump_stats)(struct Qdisc *, struct gnet_dump *);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span>		*<span class="title">owner</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>类：<br>类： 定义在排队规则中，报文通过过滤器，过滤，分配到不同的类中；排队规则可以没有类，如fifo先进先出，也可以有多个类<br>类中也可以有内部的排队规则，包被过滤器过滤为某个类后，在这个类中通过fifo的排队规则出去，或者其他规则，这里的规则就是内部规则；<br>创建类：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> tc [ OPTIONS ] <span class="class"><span class="keyword">class</span> [ <span class="title">add</span> | <span class="title">change</span> | <span class="title">replace</span> | <span class="title">delete</span> ] <span class="title">dev</span> <span class="title">DEV</span></span></span><br><span class="line"><span class="class">       <span class="title">parent</span> <span class="title">qdisc</span>-<span class="title">id</span> [ <span class="title">classid</span> <span class="title">class</span>-<span class="title">id</span> ] <span class="title">qdisc</span> [ <span class="title">qdisc</span> <span class="title">specific</span></span></span><br><span class="line"><span class="class">       <span class="title">parameters</span> ]</span></span><br><span class="line"><span class="class"><span class="title">eg</span>:</span></span><br><span class="line">#创建分类</span><br><span class="line">tc <span class="class"><span class="keyword">class</span> <span class="title">add</span> <span class="title">dev</span> <span class="title">eth0</span> <span class="title">parent</span> 1:</span><span class="number">0</span> classid <span class="number">1</span>:<span class="number">1</span> htb rate <span class="number">10</span>Mbit burst <span class="number">15</span>k</span><br><span class="line">#为eth0下的root队列<span class="number">1</span>:<span class="number">0</span>添加一个分类并命名为<span class="number">1</span>:<span class="number">1</span>，类型为htb，带宽为<span class="number">10</span>M</span><br><span class="line"><span class="meta">#rate: 是一个类保证得到的带宽值.如果有不只一个类,请保证所有子类总和是小于或等于父类.</span></span><br><span class="line"><span class="meta">#ceil: ceil是一个类最大能得到的带宽值.</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>类的表示：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">在linux中，以xxx_class来表示，如htb:</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">htb_class</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Qdisc_class_common</span> <span class="title">common</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">psched_ratecfg</span>	<span class="title">rate</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">psched_ratecfg</span>	<span class="title">ceil</span>;</span></span><br><span class="line">	s64			buffer, cbuffer;<span class="comment">/* token bucket depth/rate */</span></span><br><span class="line">	s64			mbuffer;	<span class="comment">/* max wait time */</span></span><br><span class="line">	u32			prio;		<span class="comment">/* these two are used only by leaves... */</span></span><br><span class="line">	<span class="keyword">int</span>			quantum;	<span class="comment">/* but stored for parent-to-leaf return */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto</span> __<span class="title">rcu</span>	*<span class="title">filter_list</span>;</span>	<span class="comment">/* class attached filters */</span> 类的过滤器链</span><br><span class="line">	<span class="keyword">int</span>			filter_cnt;</span><br><span class="line">	<span class="keyword">int</span>			refcnt;		<span class="comment">/* usage count of this class */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span>			level;		<span class="comment">/* our level (see above) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		children;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">htb_class</span>	*<span class="title">parent</span>;</span>	<span class="comment">/* parent class */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gnet_stats_rate_est64</span> <span class="title">rate_est</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Written often fields</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gnet_stats_basic_packed</span> <span class="title">bstats</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tc_htb_xstats</span>	<span class="title">xstats</span>;</span>	<span class="comment">/* our special stats */</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>过滤器<br>过滤器： 具体的过滤规则，用来分类；包含若干个匹配条件，如果符合条件的包，被分类到具体的类中；</li>
</ul>
<p>一个类至少有一个过滤器，可能有多个过滤器，<br>tc指令：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">tc [ OPTIONS ] filter [ add | change | replace | <span class="keyword">delete</span> | get ]</span><br><span class="line">       dev DEV [ parent qdisc-id | root ] [ handle filter-id ] protocol</span><br><span class="line">       protocol prio priority filtertype [ filtertype specific</span><br><span class="line">       parameters ] flowid flow-id</span><br><span class="line">内核目前提供的过滤器有：</span><br><span class="line"> The available filters are:</span><br><span class="line"></span><br><span class="line">       basic  Filter packets based on an ematch expression. See</span><br><span class="line">              tc-ematch(<span class="number">8</span>) <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">       bpf    Filter packets using (e)BPF, see tc-bpf(8) for details.</span><br><span class="line"></span><br><span class="line">       cgroup Filter packets based on the control group of their</span><br><span class="line">              process. See tc-cgroup(<span class="number">8</span>) <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">       flow, flower</span><br><span class="line">              Flow-based classifiers, filtering packets based on their</span><br><span class="line">              flow (identified by selectable keys). See tc-flow(<span class="number">8</span>) <span class="keyword">and</span></span><br><span class="line">              tc-flower(<span class="number">8</span>) <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">       fw     Filter based on fwmark. Directly maps fwmark value to</span><br><span class="line">              traffic <span class="class"><span class="keyword">class</span>. <span class="title">See</span> <span class="title">tc</span>-<span class="title">fw</span>(8).</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">       <span class="title">route</span>  <span class="title">Filter</span> <span class="title">packets</span> <span class="title">based</span> <span class="title">on</span> <span class="title">routing</span> <span class="title">table</span>. <span class="title">See</span> <span class="title">tc</span>-<span class="title">route</span>(8) <span class="title">for</span></span></span><br><span class="line"><span class="class">              <span class="title">details</span>.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">       <span class="title">rsvp</span>   <span class="title">Match</span> <span class="title">Resource</span> <span class="title">Reservation</span> <span class="title">Protocol</span> (<span class="title">RSVP</span>) <span class="title">packets</span>.</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">       <span class="title">tcindex</span></span></span><br><span class="line"><span class="class">              <span class="title">Filter</span> <span class="title">packets</span> <span class="title">based</span> <span class="title">on</span> <span class="title">traffic</span> <span class="title">control</span> <span class="title">index</span>. <span class="title">See</span></span></span><br><span class="line"><span class="class">              <span class="title">tc</span>-<span class="title">tcindex</span>(8).</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">       <span class="title">u32</span>    <span class="title">Generic</span> <span class="title">filtering</span> <span class="title">on</span> <span class="title">arbitrary</span> <span class="title">packet</span> <span class="title">data</span>, <span class="title">assisted</span> <span class="title">by</span></span></span><br><span class="line"><span class="class">              <span class="title">syntax</span> <span class="title">to</span> <span class="title">abstract</span> <span class="title">common</span> <span class="title">operations</span>. <span class="title">See</span> <span class="title">tc</span>-<span class="title">u32</span>(8) <span class="title">for</span></span></span><br><span class="line"><span class="class">              <span class="title">details</span>.</span></span><br><span class="line"><span class="class">    <span class="title">matchall</span></span></span><br><span class="line"><span class="class">              <span class="title">Traffic</span> <span class="title">control</span> <span class="title">filter</span> <span class="title">that</span> <span class="title">matches</span> <span class="title">every</span> <span class="title">packet</span>. <span class="title">See</span></span></span><br><span class="line"><span class="class">              <span class="title">tc</span>-<span class="title">matchall</span>(8) <span class="title">for</span> <span class="title">details</span>.</span></span><br><span class="line"><span class="class"><span class="title">eg</span>:</span></span><br><span class="line">#使用u32创建过滤器</span><br><span class="line">tc filter add dev eth0 protocol ip parent <span class="number">1</span>:<span class="number">0</span> prio <span class="number">1</span> u32 match ip sport <span class="number">22</span> flowid <span class="number">1</span>:<span class="number">10</span></span><br></pre></td></tr></table></figure></p>
<p>在内核中的结构：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto</span> &#123;</span></span><br><span class="line">	<span class="comment">/* Fast access part */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto</span> __<span class="title">rcu</span>	*<span class="title">next</span>;</span><span class="comment">//将多个过滤器连接起来</span></span><br><span class="line">	<span class="keyword">void</span> __rcu		*root;</span><br><span class="line">	<span class="keyword">int</span>			(*classify)(struct sk_buff *,</span><br><span class="line">					    <span class="keyword">const</span> struct tcf_proto *,</span><br><span class="line">					    struct tcf_result *); <span class="comment">//报文分类函数--&gt; tcf_proto_ops上</span></span><br><span class="line">	__be16			protocol;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* All the rest */</span></span><br><span class="line">	u32			prio;</span><br><span class="line">	u32			classid;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span>		*<span class="title">q</span>;</span></span><br><span class="line">	<span class="keyword">void</span>			*data;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto_ops</span>	*<span class="title">ops</span>;</span><span class="comment">//过滤器操作函数接口</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">rcu</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="qdisc的例子：-pfifo-ftb等"><a href="#qdisc的例子：-pfifo-ftb等" class="headerlink" title="qdisc的例子： pfifo ,ftb等"></a>qdisc的例子： pfifo ,ftb等</h3><p>通过fifo学习如何实现一个规则；<br>默认情况下是pfifo，这个通过dev_open挂到设备上；如果需要其他的，通过tc后-&gt;netlink再操作到dev结构等上；<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span> <span class="title">noop_qdisc</span> = &#123;</span></span><br><span class="line">	.enqueue	=	noop_enqueue,</span><br><span class="line">	.dequeue	=	noop_dequeue,</span><br><span class="line">	.flags		=	TCQ_F_BUILTIN,</span><br><span class="line">	.ops		=	&amp;noop_qdisc_ops,</span><br><span class="line">	.<span class="built_in">list</span>		=	LIST_HEAD_INIT(noop_qdisc.<span class="built_in">list</span>),</span><br><span class="line">	.q.lock		=	__SPIN_LOCK_UNLOCKED(noop_qdisc.q.lock),</span><br><span class="line">	.dev_queue	=	&amp;noop_netdev_queue,</span><br><span class="line">	.running	=	SEQCNT_ZERO(noop_qdisc.running),</span><br><span class="line">	.busylock	=	__SPIN_LOCK_UNLOCKED(noop_qdisc.busylock),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Qdisc_ops</span> <span class="title">pfifo_fast_ops</span> __<span class="title">read_mostly</span> = &#123;</span></span><br><span class="line">	.id		=	<span class="string">"pfifo_fast"</span>,</span><br><span class="line">	.priv_size	=	<span class="keyword">sizeof</span>(struct pfifo_fast_priv),</span><br><span class="line">	.enqueue	=	pfifo_fast_enqueue,</span><br><span class="line">	.dequeue	=	pfifo_fast_dequeue,</span><br><span class="line">	.peek		=	pfifo_fast_peek,</span><br><span class="line">	.init		=	pfifo_fast_init,</span><br><span class="line">	.reset		=	pfifo_fast_reset,</span><br><span class="line">	.dump		=	pfifo_fast_dump,</span><br><span class="line">	.owner		=	THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="tc工具的netlink接口"><a href="#tc工具的netlink接口" class="headerlink" title="tc工具的netlink接口"></a>tc工具的netlink接口</h3><p>定义在sch_api.c，主要操作排队规则中的类和过滤器；<br>tc是通过netlink向内核通信，从而实现创建，修改qos等功能</p>
<p>本文只是给了一个流程和具体认知，通过本文来知道tc大致原理和框架，从而为进一步提供便利和查找依据；</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/tcpip-tc/" rel="tag"># tcpip_tc</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/05/22/linux-netdevicelayer/" rel="prev" title="linux_netdevicelayer">
      <i class="fa fa-chevron-left"></i> linux_netdevicelayer
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/05/22/c-valuetype/" rel="next" title="c++_valuetype">
      c++_valuetype <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#流量控制概述"><span class="nav-number">1.</span> <span class="nav-text">流量控制概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#例子："><span class="nav-number">1.1.</span> <span class="nav-text">例子：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流量控制的基本实现原理"><span class="nav-number">2.</span> <span class="nav-text">流量控制的基本实现原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流量控制的实现和基本流程："><span class="nav-number">3.</span> <span class="nav-text">流量控制的实现和基本流程：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#相关代码："><span class="nav-number">3.1.</span> <span class="nav-text">相关代码：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#流程"><span class="nav-number">3.2.</span> <span class="nav-text">流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#流量控制的结构："><span class="nav-number">3.3.</span> <span class="nav-text">流量控制的结构：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qdisc的例子：-pfifo-ftb等"><span class="nav-number">4.</span> <span class="nav-text">qdisc的例子： pfifo ,ftb等</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tc工具的netlink接口"><span class="nav-number">5.</span> <span class="nav-text">tc工具的netlink接口</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="小兴"
      src="/images/headicon2.jpg">
  <p class="site-author-name" itemprop="name">小兴</p>
  <div class="site-description" itemprop="description">始于歧路，愿归于征途</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xdksx/" title="GitHub → https://github.com/xdksx/" rel="noopener" target="_blank"><i class="fa fa-fw fa-github-square"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/ksance@gmail.com" title="E-Mail → ksance@gmail.com"><i class="fa fa-fw fa-envelope"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/572897439" title="FB Page → https://www.facebook.com/572897439" rel="noopener" target="_blank"><i class="fa fa-fw fa-facebook"></i></a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      friendly link
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://yoursite.com" title="http://yoursite.com" rel="noopener" target="_blank">Title</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小兴</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.7.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '06e6b70d396f6928e45a',
      clientSecret: 'cd03b7c657d50a5d76a7fa682c4f8eb48cb15fc3',
      repo        : 'xdksx.github.io',
      owner       : 'xdksx',
      admin       : ['xdksx'],
      id          : 'bafb454a1572209072a952977a1c7cc8',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
