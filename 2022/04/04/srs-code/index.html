<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xdksx.github.io","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="srs代码流程图">
<meta property="og:type" content="article">
<meta property="og:title" content="srs_code">
<meta property="og:url" content="https://xdksx.github.io/2022/04/04/srs-code/index.html">
<meta property="og:site_name" content="追光者">
<meta property="og:description" content="srs代码流程图">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xdksx.github.io/2022/04/04/srs-code/srs2.png">
<meta property="og:image" content="https://xdksx.github.io/2022/04/04/srs-code/srs1.png">
<meta property="article:published_time" content="2022-04-04T08:07:33.000Z">
<meta property="article:modified_time" content="2022-04-04T08:45:32.010Z">
<meta property="article:author" content="小兴">
<meta property="article:tag" content="srs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xdksx.github.io/2022/04/04/srs-code/srs2.png">

<link rel="canonical" href="https://xdksx.github.io/2022/04/04/srs-code/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>srs_code | 追光者</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">追光者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">小兴的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-观影">

    <a href="/movies/" rel="section"><i class="fa fa-fw fa-film"></i>观影</a>

  </li>
        <li class="menu-item menu-item-阅读">

    <a href="/read/" rel="section"><i class="fa fa-fw fa-book"></i>阅读</a>

  </li>
        <li class="menu-item menu-item-心理">

    <a href="/categories/%E5%BF%83%E7%90%86/" rel="section"><i class="fa fa-fw fa-heart"></i>心理</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xdksx.github.io/2022/04/04/srs-code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/headicon2.jpg">
      <meta itemprop="name" content="小兴">
      <meta itemprop="description" content="始于歧路，愿归于征途">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追光者">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          srs_code
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-04 16:07:33 / 修改时间：16:45:32" itemprop="dateCreated datePublished" datetime="2022-04-04T16:07:33+08:00">2022-04-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/srs/" itemprop="url" rel="index"><span itemprop="name">srs</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="srs代码流程图"><a href="#srs代码流程图" class="headerlink" title="srs代码流程图"></a>srs代码流程图<span id="more"></span></h4><img src="/2022/04/04/srs-code/srs2.png" class="" title="This is an example image">
<h4 id="srs代码流程分析"><a href="#srs代码流程分析" class="headerlink" title="srs代码流程分析:"></a>srs代码流程分析:</h4><ul>
<li><p>main:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">srs_error_t <span class="keyword">do</span><span class="constructor">_main(<span class="params">int</span> <span class="params">argc</span>, <span class="params">char</span><span class="operator">**</span> <span class="params">argv</span>)</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((err = srs<span class="constructor">_thread_initialize()</span>) != srs_success) &#123;</span><br><span class="line">         <span class="keyword">if</span> ((err = srs<span class="constructor">_st_init()</span>) != srs_success) &#123;</span><br><span class="line">                <span class="keyword">if</span>((r0 = st<span class="constructor">_init()</span>) != <span class="number">0</span>)&#123;</span><br><span class="line">                       <span class="comment">/* We can ignore return value here */</span></span><br><span class="line">                     st<span class="constructor">_set_eventsys(ST_EVENTSYS_DEFAULT)</span>; <span class="comment">//设置用epoll或其他；</span></span><br><span class="line">                     _st_eventsys 的各种操作：</span><br><span class="line">                     <span class="module-access"><span class="module"><span class="identifier">_st_this_vp</span>.</span></span>idle_thread = st<span class="constructor">_thread_create(<span class="params">_st_idle_thread_start</span>, NULL, 0, 0)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>大的代码逻辑架构：</p>
<figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">1</span> srs_main_server.cpp:</span><br><span class="line">        main--&gt;do_main</span><br><span class="line">  <span class="number">2</span>  do_main主要做两件事：</span><br><span class="line">     <span class="number">1</span>) 初始化： </span><br><span class="line">        <span class="comment">// Initialize global or thread-local variables.</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">err</span> = srs_thread_initialize()) != srs_success) &#123;</span><br><span class="line">    <span class="keyword">return</span> srs_error_wrap(<span class="keyword">err</span>, <span class="string">&quot;thread init&quot;</span>)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">//非主要： 解析配置，初始化log</span></span><br><span class="line">      </span><br><span class="line">    <span class="number">2</span>)运行混合服务：</span><br><span class="line">      <span class="keyword">if</span> ((<span class="keyword">err</span> = run_directly_or_daemon()) != srs_success) &#123;</span><br><span class="line">    <span class="keyword">return</span> srs_error_wrap(<span class="keyword">err</span>, <span class="string">&quot;run&quot;</span>)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>初始化分析：srs_thread_initialize</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">        <span class="number">1</span>）创建多个全局变量</span><br><span class="line">          <span class="number">2</span>）初始化st :st主要是做网络的监听等操作： stack？协议栈</span><br><span class="line">             <span class="comment">// Initialize ST, which depends on pps cids.</span></span><br><span class="line">    <span class="keyword">if</span> ((err = srs_st_init()) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> srs_error_wrap(err, <span class="string">&quot;initialize st failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">           --》根据是否支持epoll/等，来初始化poll:</span><br><span class="line">           <span class="comment">// Select the best event system available on the OS. In Linux this is</span></span><br><span class="line">    <span class="comment">// epoll(). On BSD it will be kqueue.</span></span><br><span class="line">    <span class="keyword">if</span> (st_set_eventsys(ST_EVENTSYS_ALT) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> srs_error_new(ERROR_ST_SET_EPOLL, <span class="string">&quot;st enable st failed, current is %s&quot;</span>, st_get_eventsys_name());</span><br><span class="line">    &#125;</span><br><span class="line">          <span class="keyword">static</span> _st_eventsys_t _st_epoll_eventsys = &#123;</span><br><span class="line">    <span class="string">&quot;epoll&quot;</span>,</span><br><span class="line">    ST_EVENTSYS_ALT,</span><br><span class="line">    _st_epoll_init, <span class="comment">//epoll_create这里</span></span><br><span class="line">    _st_epoll_dispatch, <span class="comment">//epoll_wait在这里</span></span><br><span class="line">    _st_epoll_pollset_add,<span class="comment">//epoll_ctl这里</span></span><br><span class="line">    _st_epoll_pollset_del,</span><br><span class="line">    _st_epoll_fd_new,</span><br><span class="line">    _st_epoll_fd_close,</span><br><span class="line">    _st_epoll_fd_getlimit</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">typedef <span class="keyword">struct</span> _st_eventsys_ops &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">char</span> *name;                          <span class="comment">/* Name of this event system */</span></span><br><span class="line">    <span class="built_in">int</span>  val;                                  <span class="comment">/* Type of this event system */</span></span><br><span class="line">    <span class="built_in">int</span>  (*<span class="keyword">init</span>)(<span class="keyword">void</span>);                        <span class="comment">/* Initialization */</span></span><br><span class="line">    <span class="keyword">void</span> (*dispatch)(<span class="keyword">void</span>);                    <span class="comment">/* Dispatch function */</span></span><br><span class="line">    <span class="built_in">int</span>  (*pollset_add)(<span class="keyword">struct</span> pollfd *, <span class="built_in">int</span>); <span class="comment">/* Add descriptor set */</span></span><br><span class="line">    <span class="keyword">void</span> (*pollset_del)(<span class="keyword">struct</span> pollfd *, <span class="built_in">int</span>); <span class="comment">/* Delete descriptor set */</span></span><br><span class="line">    <span class="built_in">int</span>  (*fd_new)(<span class="built_in">int</span>);                       <span class="comment">/* New descriptor allocated */</span></span><br><span class="line">    <span class="built_in">int</span>  (*fd_close)(<span class="built_in">int</span>);                     <span class="comment">/* Descriptor closed */</span></span><br><span class="line">    <span class="built_in">int</span>  (*fd_getlimit)(<span class="keyword">void</span>);                 <span class="comment">/* Descriptor hard limit */</span></span><br><span class="line">&#125; _st_eventsys_t;</span><br></pre></td></tr></table></figure>
<p>至此准备好了选择的网络处理模型；</p>
</li>
<li><p>线程初始化：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="keyword">if</span>((r0 = <span class="built_in">st_init</span>()) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">srs_error_new</span>(ERROR_ST_INITIALIZE, <span class="string">&quot;st initialize failed, r0=%d&quot;</span>, r0);</span><br><span class="line">    &#125;</span><br><span class="line"> --》初始化st_io_init: 主要是做进程的rlimit等配置</span><br><span class="line"> --》*_st_eventsys-&gt;init)() 创建 epoll_create</span><br><span class="line">--&gt;创建idle 协程并启动：</span><br><span class="line">  _st_this_vp.idle_thread = <span class="built_in">st_thread_create</span>(_st_idle_thread_start, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="type">_st_thread_t</span> *<span class="title">st_thread_create</span><span class="params">(<span class="type">void</span> *(*start)(<span class="type">void</span> *arg), <span class="type">void</span> *arg, <span class="type">int</span> joinable, <span class="type">int</span> stk_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">_st_thread_t</span> *thread;</span><br><span class="line">    <span class="type">_st_stack_t</span> *stack;</span><br><span class="line">   。。。</span><br><span class="line">   <span class="meta">#<span class="keyword">ifndef</span> __ia64__</span></span><br><span class="line">    <span class="comment">/* Merge from https://github.com/michaeltalyansky/state-threads/commit/cce736426c2320ffec7c9820df49ee7a18ae638c */</span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> defined(__arm__) &amp;&amp; !defined(MD_USE_BUILTIN_SETJMP) &amp;&amp; __GLIBC_MINOR__ &gt;= 19</span></span><br><span class="line">        <span class="keyword">volatile</span> <span class="type">void</span> * lsp = <span class="built_in">PTR_MANGLE</span>(stack-&gt;sp);</span><br><span class="line">        <span class="keyword">if</span> (_setjmp ((thread)-&gt;context))</span><br><span class="line">            _st_thread_main();</span><br><span class="line">        (thread)-&gt;context[<span class="number">0</span>].__jmpbuf[<span class="number">8</span>] = (<span class="type">long</span>) (lsp);</span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        _ST_INIT_CONTEXT(thread, stack-&gt;sp, _st_thread_main);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    _ST_INIT_CONTEXT(thread, stack-&gt;sp, stack-&gt;bsp, _st_thread_main);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   执行： 以下函数，会切换上下文，这样即使启动，也能回去；</span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Start function for the idle thread</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* ARGSUSED */</span></span><br><span class="line"><span class="type">void</span> *_st_idle_thread_start(<span class="type">void</span> *arg)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">_st_thread_t</span> *me = _ST_CURRENT_THREAD();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (_st_active_count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* Idle vp till I/O is ready or the smallest timeout expired */</span></span><br><span class="line">        _ST_VP_IDLE();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* Check sleep queue for expired threads */</span></span><br><span class="line">        _st_vp_check_clock();</span><br><span class="line">        </span><br><span class="line">        me-&gt;state = _ST_ST_RUNNABLE;</span><br><span class="line">        _ST_SWITCH_CONTEXT(me);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* No more threads */</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* NOTREACHED */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面是初始化，监听，启动各个服务的协程；run_directly_or_daemon</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 检测是否是docker环境，是则用</span><br><span class="line"><span class="number">2</span>  是否是后台使用？</span><br><span class="line"><span class="number">3</span>  创建子进程来运行，其他父，祖父进程稍后退出，最后只有子进程：</span><br><span class="line"> [<span class="number">2021</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">35.845</span>][Warn][<span class="number">11265</span>][b2cf05o9][<span class="number">22</span>] SRS/<span class="number">4.0</span>.<span class="number">146</span> <span class="keyword">is</span> <span class="built_in">not</span> stable</span><br><span class="line">[<span class="number">2021</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">35.845</span>][Trace][<span class="number">11265</span>][b2cf05o9] start daemon mode...</span><br><span class="line">[<span class="number">2021</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">35.845</span>][Trace][<span class="number">11266</span>][b2cf05o9] father process exit</span><br><span class="line">[<span class="number">2021</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">35.845</span>][Trace][<span class="number">11267</span>][b2cf05o9] son(daemon) process running.</span><br><span class="line">[<span class="number">2021</span>-<span class="number">08</span>-<span class="number">04</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">35.845</span>][Trace][<span class="number">11265</span>][b2cf05o9] grandpa process exit.</span><br><span class="line"><span class="number">4</span>  关键函数：run_hybrid_server</span><br><span class="line">run_hybrid_server 分析：</span><br><span class="line"><span class="number">1</span>）注册各种服务： http,rtmp，rtc服务等</span><br><span class="line"><span class="number">2</span>）初始化：各种定时器，和遍历每个服务的初始化函数</span><br><span class="line"><span class="number">3</span>） _<span class="function"><span class="title">srs_hybrid</span>-&gt;</span>run() 遍历每个服务进行 运行；</span><br><span class="line"></span><br><span class="line">这几个服务由他们包装：</span><br><span class="line">SrsServerAdapter--》实际服务：new SrsServer();--》rtmp <span class="built_in">and</span> http</span><br><span class="line">S<span class="function"><span class="title">rtServerAdapter</span>-&gt;</span>...</span><br><span class="line">R<span class="function"><span class="title">tcServerAdapter</span>-&gt;</span>...</span><br><span class="line"></span><br><span class="line">已srsServerAdapter为例：</span><br><span class="line">srs_error_t SrsServerAdapter::run()</span><br><span class="line">&#123;</span><br><span class="line">    srs_error_t err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize the whole system, set hooks to handle server level events.</span></span><br><span class="line">    <span class="function"><span class="title">if</span> ((err = srs-&gt;</span>initialize(NULL)) != srs_success) &#123;</span><br><span class="line">        return srs_error_wrap(err, <span class="string">&quot;server initialize&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> ((err = srs-&gt;</span>initialize_st()) != srs_success) &#123;</span><br><span class="line">        return srs_error_wrap(err, <span class="string">&quot;initialize st&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> ((err = srs-&gt;</span>acquire_pid_file()) != srs_success) &#123;</span><br><span class="line">        return srs_error_wrap(err, <span class="string">&quot;acquire pid file&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> ((err = srs-&gt;</span>initialize_signal()) != srs_success) &#123;</span><br><span class="line">        return srs_error_wrap(err, <span class="string">&quot;initialize signal&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> ((err = srs-&gt;</span><span class="function"><span class="title">listen</span>()) != srs_success) &#123; //监听：监听时会一层层传进去：-&gt;</span>S<span class="function"><span class="title">rsTcpListen</span>-&gt;</span><span class="function"><span class="title">srs_tcp_listen</span>-&gt;</span><span class="function"><span class="title">do_srs_tcp_listen</span>-&gt;</span>srs_netfd_open_socket  ，貌似监听的没有加到epoll中？</span><br><span class="line">        return srs_error_wrap(err, <span class="string">&quot;listen&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> ((err = srs-&gt;</span>register_signal()) != srs_success) &#123;</span><br><span class="line">        return srs_error_wrap(err, <span class="string">&quot;register signal&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> ((err = srs-&gt;</span>http_handle()) != srs_success) &#123;</span><br><span class="line">        return srs_error_wrap(err, <span class="string">&quot;http handle&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> ((err = srs-&gt;</span>ingest()) != srs_success) &#123;</span><br><span class="line">        return srs_error_wrap(err, <span class="string">&quot;ingest&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> ((err = srs-&gt;</span><span class="function"><span class="title">start</span>()) != srs_success) &#123; //启动协程：-&gt;</span> <span class="function"><span class="title">trd_</span>-&gt;</span><span class="function"><span class="title">start</span>()-&gt;</span>S<span class="function"><span class="title">rsSTCoroutine</span>-&gt;</span><span class="function"><span class="title">start</span>()-&gt;</span>S<span class="function"><span class="title">rsFastCoroutine</span>-&gt;</span><span class="function"><span class="title">start</span>-&gt;</span>_pfn_st_thread_create 创建协程和启动</span><br><span class="line">        return srs_error_wrap(err, <span class="string">&quot;start&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>至此运行起来</p>
</li>
<li><p>epoll和st_thread如何结合？</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">1</span> 将st_thread相关信息等放到epoll: 当连接，accept，发送接收数据等，可能会调用如下函数：将fd设置到epoll中；</span><br><span class="line">      <span class="built_in">int</span> st<span class="constructor">_poll(<span class="params">struct</span> <span class="params">pollfd</span> <span class="operator">*</span><span class="params">pds</span>, <span class="params">int</span> <span class="params">npds</span>, <span class="params">st_utime_t</span> <span class="params">timeout</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> pollfd *pd;</span><br><span class="line">    <span class="keyword">struct</span> pollfd *epd = pds + npds;</span><br><span class="line">    _st_pollq_t pq;</span><br><span class="line">    _st_thread_t *me = <span class="constructor">_ST_CURRENT_THREAD()</span>; </span><br><span class="line">    <span class="built_in">int</span> n;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (me-&gt;flags &amp; _ST_FL_INTERRUPT) &#123;</span><br><span class="line">        me-&gt;flags &amp;= ~_ST_FL_INTERRUPT;</span><br><span class="line">        errno = EINTR;</span><br><span class="line">        return -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((*_st_eventsys-&gt;pollset_add)(pds, npds) &lt; <span class="number">0</span>)</span><br><span class="line">        return -<span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    pq.pds = pds;</span><br><span class="line">    pq.npds = npds;</span><br><span class="line">    pq.thread = me;</span><br><span class="line">    pq.on_ioq = <span class="number">1</span>;</span><br><span class="line">    <span class="constructor">_ST_ADD_IOQ(<span class="params">pq</span>)</span>;<span class="comment">//同时设置这个结构，并将其加到队列中；</span></span><br><span class="line">    <span class="keyword">if</span> (timeout != ST_UTIME_NO_TIMEOUT)</span><br><span class="line">        <span class="constructor">_ST_ADD_SLEEPQ(<span class="params">me</span>, <span class="params">timeout</span>)</span>;</span><br><span class="line">    me-&gt;state = _ST_ST_IO_WAIT;</span><br><span class="line">    </span><br><span class="line">    <span class="constructor">_ST_SWITCH_CONTEXT(<span class="params">me</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (pq.on_ioq) &#123;</span><br><span class="line">        <span class="comment">/* If we timed out, the pollq might still be on the ioq. Remove it */</span></span><br><span class="line">        <span class="constructor">_ST_DEL_IOQ(<span class="params">pq</span>)</span>;</span><br><span class="line">        (*_st_eventsys-&gt;pollset_del)(pds, npds);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* Count the number of ready descriptors */</span></span><br><span class="line">        <span class="keyword">for</span> (pd = pds; pd &lt; epd; pd++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pd-&gt;revents)</span><br><span class="line">                n++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (me-&gt;flags &amp; _ST_FL_INTERRUPT) &#123;</span><br><span class="line">        me-&gt;flags &amp;= ~_ST_FL_INTERRUPT;</span><br><span class="line">        errno = EINTR;</span><br><span class="line">        return -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>当epoll事件触发时：其实是通过切换协程，再判断epoll_wait:</p>
</li>
</ul>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">#<span class="function"><span class="title">define</span> _ST_VP_IDLE()                   (*_st_eventsys-&gt;</span>dispatch)()</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Start function for the idle thread</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* ARGSUSED */</span></span><br><span class="line">void *_st_idle_thread_start(void *arg)</span><br><span class="line">&#123;</span><br><span class="line">    _st_thread_t *me = _ST_CURRENT_THREAD();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (_st_active_count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* Idle vp till I/O is ready or the smallest timeout expired */</span></span><br><span class="line">        _ST_VP_IDLE(); <span class="comment">//循环触发，触发后走当有事件时，让协程能调度运行，见下；</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* Check sleep queue for expired threads */</span></span><br><span class="line">        _st_vp_check_clock();</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="title">me</span>-&gt;</span>state = _ST_ST_RUNNABLE;</span><br><span class="line">        _ST_SWITCH_CONTEXT(me);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* No more threads */</span></span><br><span class="line">    exit(<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* NOTREACHED */</span></span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ST_HIDDEN void _st_epoll_dispatch(void)</span><br><span class="line">&#123;</span><br><span class="line">    st_utime_t min_timeout;</span><br><span class="line">    _st_clist_t *q;</span><br><span class="line">    _st_pollq_t *pq;</span><br><span class="line">    struct pollfd *pds, *epds;</span><br><span class="line">    struct epoll_event ev;</span><br><span class="line">    int timeout, nfd, i, osfd, notify;</span><br><span class="line">    int events, op;</span><br><span class="line">    short revents;</span><br><span class="line"></span><br><span class="line">    #<span class="keyword">if</span> defined(DEBUG) &amp;&amp; defined(DEBUG_STATS)</span><br><span class="line">    ++_st_stat_epoll;</span><br><span class="line">    #endif</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_ST_SLEEPQ == NULL) &#123;</span><br><span class="line">        timeout = -<span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="function"><span class="title">min_timeout</span> = (_ST_SLEEPQ-&gt;</span><span class="function"><span class="title">due</span> &lt;= _ST_LAST_CLOCK) ? 0 : (_ST_SLEEPQ-&gt;</span>due - _ST_LAST_CLOCK);</span><br><span class="line">        timeout = (int) (min_timeout / <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// At least wait 1ms when &lt;1ms, to avoid epoll_wait spin loop.</span></span><br><span class="line">        <span class="keyword">if</span> (timeout == <span class="number">0</span>) &#123;</span><br><span class="line">            #<span class="keyword">if</span> defined(DEBUG) &amp;&amp; defined(DEBUG_STATS)</span><br><span class="line">            ++_st_stat_epoll_zero;</span><br><span class="line">            #endif</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (min_timeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                #<span class="keyword">if</span> defined(DEBUG) &amp;&amp; defined(DEBUG_STATS)</span><br><span class="line">                ++_st_stat_epoll_shake;</span><br><span class="line">                #endif</span><br><span class="line"></span><br><span class="line">                timeout = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (_st_epoll_data-&gt;</span>pid != getpid()) &#123;</span><br><span class="line">        <span class="comment">/* We probably forked, reinitialize epoll set */</span></span><br><span class="line">        <span class="function"><span class="title">close</span>(_st_epoll_data-&gt;</span>epfd);</span><br><span class="line">        _<span class="function"><span class="title">st_epoll_data</span>-&gt;</span><span class="function"><span class="title">epfd</span> = epoll_create(_st_epoll_data-&gt;</span>fd_hint);</span><br><span class="line">        <span class="function"><span class="title">if</span> (_st_epoll_data-&gt;</span>epfd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* There is nothing we can do here, will retry later */</span></span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="title">fcntl</span>(_st_epoll_data-&gt;</span>epfd, F_SETFD, FD_CLOEXEC);</span><br><span class="line">        _<span class="function"><span class="title">st_epoll_data</span>-&gt;</span>pid = getpid();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Put all descriptors on ioq into new epoll set */</span></span><br><span class="line">        <span class="function"><span class="title">memset</span>(_st_epoll_data-&gt;</span><span class="function"><span class="title">fd_data</span>, 0, _st_epoll_data-&gt;</span>fd_data_size * sizeof(_epoll_fd_data_t));</span><br><span class="line">        _<span class="function"><span class="title">st_epoll_data</span>-&gt;</span>evtlist_cnt = <span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="title">for</span> (q = _ST_IOQ.next; q != &amp;_ST_IOQ; q = q-&gt;</span>next) &#123;</span><br><span class="line">            pq = _ST_POLLQUEUE_PTR(q);<span class="comment">//拿到协程相关结构</span></span><br><span class="line">            _<span class="function"><span class="title">st_epoll_pollset_add</span>(pq-&gt;</span><span class="function"><span class="title">pds</span>, pq-&gt;</span>npds);  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check for I/O operations */</span></span><br><span class="line">    <span class="function"><span class="title">nfd</span> = epoll_wait(_st_epoll_data-&gt;</span><span class="function"><span class="title">epfd</span>, _st_epoll_data-&gt;</span><span class="function"><span class="title">evtlist</span>, _st_epoll_data-&gt;</span>evtlist_size, timeout);</span><br><span class="line"></span><br><span class="line">    #<span class="keyword">if</span> defined(DEBUG) &amp;&amp; defined(DEBUG_STATS)</span><br><span class="line">    <span class="keyword">if</span> (nfd &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        ++_st_stat_epoll_spin;</span><br><span class="line">    &#125;</span><br><span class="line">    #endif</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nfd &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nfd; i++) &#123;</span><br><span class="line">            <span class="function"><span class="title">osfd</span> = _st_epoll_data-&gt;</span>evtlist[i].<span class="keyword">data</span>.fd;</span><br><span class="line">            _ST_EPOLL_REVENTS(<span class="function"><span class="title">osfd</span>) = _st_epoll_data-&gt;</span>evtlist[i].events;</span><br><span class="line">            <span class="keyword">if</span> (_ST_EPOLL_REVENTS(osfd) &amp; (EPOLLERR | EPOLLHUP)) &#123;</span><br><span class="line">                <span class="comment">/* Also set I/O bits on error */</span></span><br><span class="line">                _ST_EPOLL_REVENTS(osfd) |= _ST_EPOLL_EVENTS(osfd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">for</span> (q = _ST_IOQ.next; q != &amp;_ST_IOQ; q = q-&gt;</span>next) &#123;</span><br><span class="line">            pq = _ST_POLLQUEUE_PTR(q);</span><br><span class="line">            notify = <span class="number">0</span>;</span><br><span class="line">            <span class="function"><span class="title">epds</span> = pq-&gt;</span><span class="function"><span class="title">pds</span> + pq-&gt;</span>npds;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="title">for</span> (pds = pq-&gt;</span>pds; pds &lt; epds; pds++) &#123;</span><br><span class="line">                <span class="function"><span class="title">if</span> (_ST_EPOLL_REVENTS(pds-&gt;</span>fd) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="function"><span class="title">pds</span>-&gt;</span>revents = <span class="number">0</span>;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="function"><span class="title">osfd</span> = pds-&gt;</span>fd;</span><br><span class="line">                <span class="function"><span class="title">events</span> = pds-&gt;</span>events;</span><br><span class="line">                revents = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> ((events &amp; POLLIN) &amp;&amp; (_ST_EPOLL_REVENTS(osfd) &amp; EPOLLIN))</span><br><span class="line">                    revents |= POLLIN;</span><br><span class="line">                <span class="keyword">if</span> ((events &amp; POLLOUT) &amp;&amp; (_ST_EPOLL_REVENTS(osfd) &amp; EPOLLOUT))</span><br><span class="line">                    revents |= POLLOUT;</span><br><span class="line">                <span class="keyword">if</span> ((events &amp; POLLPRI) &amp;&amp; (_ST_EPOLL_REVENTS(osfd) &amp; EPOLLPRI))</span><br><span class="line">                    revents |= POLLPRI;</span><br><span class="line">                <span class="keyword">if</span> (_ST_EPOLL_REVENTS(osfd) &amp; EPOLLERR)</span><br><span class="line">                    revents |= POLLERR;</span><br><span class="line">                <span class="keyword">if</span> (_ST_EPOLL_REVENTS(osfd) &amp; EPOLLHUP)</span><br><span class="line">                    revents |= POLLHUP;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="title">pds</span>-&gt;</span>revents = revents;</span><br><span class="line">                <span class="keyword">if</span> (revents) &#123;</span><br><span class="line">                    notify = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (notify) &#123; <span class="comment">//如果有事件</span></span><br><span class="line">                ST_REMOVE_LINK(&amp;<span class="function"><span class="title">pq</span>-&gt;</span>links);</span><br><span class="line">                <span class="function"><span class="title">pq</span>-&gt;</span>on_ioq = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Here we will only delete/modify descriptors that</span></span><br><span class="line"><span class="comment">                 * didn&#x27;t fire (see comments in _st_epoll_pollset_del()).</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                _<span class="function"><span class="title">st_epoll_pollset_del</span>(pq-&gt;</span><span class="function"><span class="title">pds</span>, pq-&gt;</span>npds);</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="title">if</span> (pq-&gt;</span><span class="function"><span class="title">thread</span>-&gt;</span>flags &amp; _ST_FL_ON_SLEEPQ)</span><br><span class="line">                    _ST_DEL_SLEEPQ(<span class="function"><span class="title">pq</span>-&gt;</span>thread);</span><br><span class="line">                <span class="function"><span class="title">pq</span>-&gt;</span><span class="function"><span class="title">thread</span>-&gt;</span>state = _ST_ST_RUNNABLE; <span class="comment">//将协程设置为运行，则调度 会调度这个协程运行；</span></span><br><span class="line">                _ST_ADD_RUNQ(<span class="function"><span class="title">pq</span>-&gt;</span>thread);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nfd; i++) &#123;</span><br><span class="line">            <span class="comment">/* Delete/modify descriptors that fired */</span></span><br><span class="line">            <span class="function"><span class="title">osfd</span> = _st_epoll_data-&gt;</span>evtlist[i].<span class="keyword">data</span>.fd;</span><br><span class="line">            _ST_EPOLL_REVENTS(osfd) = <span class="number">0</span>;</span><br><span class="line">            events = _ST_EPOLL_EVENTS(osfd);</span><br><span class="line">            op = events ? EPOLL_CTL_MOD : EPOLL_CTL_DEL;</span><br><span class="line">            ev.events = events;</span><br><span class="line">            ev.<span class="keyword">data</span>.fd = osfd;</span><br><span class="line">            <span class="function"><span class="title">if</span> (epoll_ctl(_st_epoll_data-&gt;</span>epfd, op, osfd, &amp;ev) == <span class="number">0</span> &amp;&amp; op == EPOLL_CTL_DEL) &#123;</span><br><span class="line">                _<span class="function"><span class="title">st_epoll_data</span>-&gt;</span>evtlist_cnt--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="comment">//调度主要见sched.c:</span></span><br><span class="line">    <span class="comment">//业务逻辑处理：</span></span><br><span class="line">   举例：如http:</span><br><span class="line">   当epoll发现数据准备好了，切换到协程，执行对应的do_cycle,这个函数会去循环读取数据来解析；</span><br><span class="line">    解析结束后让出 协程，到idle，等待下一个消息；</span><br></pre></td></tr></table></figure>
<h4 id="gdb调试："><a href="#gdb调试：" class="headerlink" title="gdb调试："></a>gdb调试：</h4><ul>
<li><p>调试推流：ffmpeg -re -i .&#x2F;doc&#x2F;source.flv -c copy -f flv -y rtmp:&#x2F;&#x2F;localhost&#x2F;live&#x2F;livestream</p>
</li>
<li><p>调试方式1：适用于单步，打断点，缺点，可能会因超时网络断开等需要重新开始；</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb ./objs/srs</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">args</span> -<span class="keyword">c</span> ./<span class="keyword">conf</span>/srs.<span class="keyword">conf</span></span><br><span class="line"><span class="keyword">break</span> run_hybrid_server</span><br><span class="line"><span class="keyword">set</span> detach-<span class="keyword">on</span>-fork  off</span><br><span class="line"><span class="keyword">set</span> follow-fork-<span class="keyword">mode</span> child</span><br></pre></td></tr></table></figure>
</li>
<li><p>调试方式2：适用于持续运行<br>窗口1： .&#x2F;srs -c ..&#x2F;conf&#x2F;srs.conf<br>窗口2： gdbserver –attach 127.0.0.1:1234 <code>pidof srs</code><br>窗口3： gdb –command&#x3D;command       &#x2F;&#x2F;指定文件名为command,无后缀名。</p>
</li>
</ul>
<p>一个command举例</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">file srs</span><br><span class="line">target remote <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">1234</span></span><br><span class="line">trace srs_app_rtc_dtls.cpp:<span class="number">561</span></span><br><span class="line">actions</span><br><span class="line">collect dtls_ctx</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">tstart</span><br><span class="line"><span class="keyword">break</span> on_connection_established</span><br><span class="line">bt</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">break</span> on_rtp</span><br><span class="line">bt </span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">break</span> on_video </span><br><span class="line">bt </span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">break</span> process_publish_message</span><br><span class="line">bt </span><br><span class="line"><span class="keyword">continue</span> </span><br><span class="line"><span class="keyword">break</span> handle_publish_message</span><br><span class="line">bt </span><br><span class="line"><span class="built_in">clear</span> on_connection_established</span><br><span class="line"><span class="built_in">clear</span> on_rtp</span><br><span class="line"><span class="built_in">clear</span> on_video</span><br><span class="line"><span class="built_in">clear</span> process_publish_message</span><br><span class="line"><span class="built_in">clear</span> handle_publish_message</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">tstatus</span><br><span class="line">tstop</span><br><span class="line">tfind <span class="built_in">start</span></span><br><span class="line"><span class="keyword">while</span> <span class="variable">$trace_frame</span> != <span class="literal">-1</span></span><br><span class="line">output <span class="variable">$trace_file</span></span><br><span class="line">printf <span class="string">&quot;, line %d (tracepoint #%d)\n&quot;</span>, <span class="variable">$trace_line</span>, <span class="variable">$tracepoint</span></span><br><span class="line">tfind </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>


<h4 id="gdb调试一个场景代码流程分析："><a href="#gdb调试一个场景代码流程分析：" class="headerlink" title="gdb调试一个场景代码流程分析："></a>gdb调试一个场景代码流程分析：</h4><p>rtmp推流，webrtc浏览器拉流播放：</p>
<p>1 接收sdp(以http发送，端口是1988，然后建立session，创建dtls ，并交换秘钥和握手；<br>接着再进行srtp的数据交换；</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SrsHttpCorsMux<span class="number">::</span>serve_http</span><br><span class="line">SrsHttpServeMux<span class="number">::</span>serve_http</span><br><span class="line"> SrsGoApiRtcPlay<span class="number">::</span>serve_http</span><br><span class="line"> SrsRtcServer<span class="number">::</span>on_udp_packet</span><br><span class="line"></span><br><span class="line">http:</span><br><span class="line">(gdb) bt</span><br><span class="line">#<span class="number">0</span>  SrsGoApiRtcPlay<span class="number">::</span>serve_http (this=<span class="number">0</span>x0, w=<span class="number">0</span>x<span class="number">555556039170</span>, r=<span class="number">0</span>x555555ecaac8) at src/app/srs_app_rtc_api.cpp:<span class="number">42</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0</span>x0000555<span class="number">55569e3a3</span> in SrsHttpServeMux<span class="number">::</span>serve_http (this=<span class="number">0</span>x555555ecaa60, w=<span class="number">0</span>x55<span class="number">55560393c0</span>, r=<span class="number">0</span>x555556006bc0) at src/protocol/srs_http_stack.cpp:<span class="number">713</span></span><br><span class="line">#<span class="number">2</span>  <span class="number">0</span>x000055555569f1ec in SrsHttpCorsMux<span class="number">::</span>serve_http (this=<span class="number">0</span>x5<span class="number">55556007c90</span>, w=<span class="number">0</span>x55<span class="number">55560393c0</span>, r=<span class="number">0</span>x555556006bc0) at src/protocol/srs_http_stack.cpp:<span class="number">861</span></span><br><span class="line">#<span class="number">3</span>  <span class="number">0</span>x00005555557877bf in SrsHttpConn<span class="number">::</span>process_request (this=<span class="number">0</span>x<span class="number">555556007160</span>, w=<span class="number">0</span>x55<span class="number">55560393c0</span>, r=<span class="number">0</span>x555556006bc0, rid=<span class="number">1</span>) at src/app/srs_app_http_conn.cpp:<span class="number">233</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0</span>x00005555557873ea in SrsHttpConn<span class="number">::</span>process_requests (this=<span class="number">0</span>x<span class="number">555556007160</span>, preq=<span class="number">0</span>x5<span class="number">55556039498</span>) at src/app/srs_app_http_conn.cpp:<span class="number">206</span></span><br><span class="line">#<span class="number">5</span>  <span class="number">0</span>x00005<span class="number">55555786f75</span> in SrsHttpConn<span class="number">::</span>do_cycle (this=<span class="number">0</span>x<span class="number">555556007160</span>) at src/app/srs_app_http_conn.cpp:<span class="number">160</span></span><br><span class="line">#<span class="number">6</span>  <span class="number">0</span>x000055555578694c in SrsHttpConn<span class="number">::</span>cycle (this=<span class="number">0</span>x<span class="number">555556007160</span>) at src/app/srs_app_http_conn.cpp:<span class="number">105</span></span><br><span class="line">#<span class="number">7</span>  <span class="number">0</span>x0000555<span class="number">55571e1b8</span> in SrsFastCoroutin<span class="number">e::</span>cycle (this=<span class="number">0</span>x5<span class="number">55556006e20</span>) at src/app/srs_app_st.cpp:<span class="number">253</span></span><br><span class="line">#<span class="number">8</span>  <span class="number">0</span>x000055555571e25c in SrsFastCoroutin<span class="number">e::</span>pfn (arg=<span class="number">0</span>x5<span class="number">55556006e20</span>) at src/app/srs_app_st.cpp:<span class="number">268</span></span><br><span class="line">#<span class="number">9</span>  <span class="number">0</span>x000055555585072f in _st_thread_main () at sched.c:<span class="number">363</span></span><br><span class="line">#<span class="number">10</span> <span class="number">0</span>x0000555555850fe8 in st_thread_create (start=<span class="number">0</span>x<span class="number">55555571e238</span> &lt;SrsFastCoroutin<span class="number">e::</span>pfn(void*)&gt;, arg=<span class="number">0</span>x5<span class="number">55556006e20</span>, joinable=<span class="number">1</span>, stk_size=<span class="number">65536</span>) at sched.c:<span class="number">694</span></span><br><span class="line">Backtrace stopped: previous frame inner to this frame (corrupt stack?)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2 sdp: 客户端web-&gt;向server 发起http连接，传递sdp等信息</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">srs_error_t SrsGoApiRtcPlay::<span class="keyword">do</span><span class="constructor">_serve_http(ISrsHttpResponseWriter<span class="operator">*</span> <span class="params">w</span>, ISrsHttpMessage<span class="operator">*</span> <span class="params">r</span>, SrsJsonObject<span class="operator">*</span> <span class="params">res</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    srs_error_t err = srs_success;</span><br><span class="line">   <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> When server enabled, but vhost disabled, should report error.</span></span><br><span class="line">    SrsRtcConnection* session = NULL;</span><br><span class="line">    <span class="keyword">if</span> ((err = server_-&gt;create<span class="constructor">_session(&amp;<span class="params">ruc</span>, <span class="params">local_sdp</span>, &amp;<span class="params">session</span>)</span>) != srs_success) &#123;</span><br><span class="line">        return srs<span class="constructor">_error_wrap(<span class="params">err</span>, <span class="string">&quot;create session, dtls=%u, srtp=%u, eip=%s&quot;</span>, <span class="params">ruc</span>.<span class="params">dtls_</span>, <span class="params">ruc</span>.<span class="params">srtp_</span>, <span class="params">eip</span>.<span class="params">c_str</span>()</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> <span class="doctag">FIXME:</span> add do_create_session to error process.</span></span><br><span class="line">    SrsRtcConnection* session = <span class="keyword">new</span> <span class="constructor">SrsRtcConnection(<span class="params">this</span>, <span class="params">cid</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> ((err = <span class="keyword">do</span><span class="constructor">_create_session(<span class="params">ruc</span>, <span class="params">local_sdp</span>, <span class="params">session</span>)</span>) != srs_success) &#123;<span class="comment">//进行添加candiate,set_dtls_role,remote_sdp等等</span></span><br><span class="line">        srs<span class="constructor">_freep(<span class="params">session</span>)</span>;</span><br><span class="line">        return srs<span class="constructor">_error_wrap(<span class="params">err</span>, <span class="string">&quot;create session&quot;</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *psession = session;</span><br><span class="line"></span><br><span class="line">    创建session,确认自己的角色后，</span><br><span class="line">    初始化sdp, dtls等等；</span><br><span class="line">     do_create_session完成的内容：</span><br><span class="line">         <span class="number">1</span>- 创建session</span><br><span class="line">         <span class="number">2</span>- 接收和初始化candiate</span><br><span class="line">         <span class="number">3</span>-初始化dtls</span><br><span class="line">       candiate,offer,answer;</span><br><span class="line">    接着打洞；发送数据；</span><br><span class="line"></span><br><span class="line">然后 on_udp_packet </span><br><span class="line">   on_stun --&gt;</span><br><span class="line">      绑定连接，接着进行dtls 产生秘钥；</span><br></pre></td></tr></table></figure>
<img src="/2022/04/04/srs-code/srs1.png" class="" title="This is an example image">

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[2021-08-11 18:22:29.490][Trace][39330][5mkn5262] RTC: session<span class="built_in"> address </span>init 172.21.0.5:60276</span><br><span class="line">[2021-08-11 18:22:29.491][Trace][39330][5mkn5262] RTC: session STUN done, waiting DTLS handshake.</span><br><span class="line">[2021-08-11 18:22:29.498][Trace][39330][5mkn5262] DTLS: State Passive RECV, <span class="attribute">done</span>=0, <span class="attribute">arq</span>=0/0, <span class="attribute">r0</span>=1, <span class="attribute">r1</span>=0, <span class="attribute">len</span>=159, <span class="attribute">cnt</span>=22, <span class="attribute">size</span>=146, <span class="attribute">hs</span>=1</span><br><span class="line">[2021-08-11 18:22:29.499][Trace][39330][5mkn5262] DTLS: State Passive SEND, <span class="attribute">done</span>=0, <span class="attribute">arq</span>=0/0, <span class="attribute">r0</span>=-1, <span class="attribute">r1</span>=2, <span class="attribute">len</span>=680, <span class="attribute">cnt</span>=22, <span class="attribute">size</span>=82, <span class="attribute">hs</span>=2</span><br><span class="line">[2021-08-11 18:22:29.502][Trace][39330][5mkn5262] DTLS: State Passive RECV, <span class="attribute">done</span>=0, <span class="attribute">arq</span>=0/0, <span class="attribute">r0</span>=1, <span class="attribute">r1</span>=0, <span class="attribute">len</span>=578, <span class="attribute">cnt</span>=22, <span class="attribute">size</span>=300, <span class="attribute">hs</span>=11</span><br><span class="line">[2021-08-11 18:22:29.503][Trace][39330][5mkn5262] DTLS: State Passive SEND, <span class="attribute">done</span>=1, <span class="attribute">arq</span>=0/0, <span class="attribute">r0</span>=1, <span class="attribute">r1</span>=0, <span class="attribute">len</span>=554, <span class="attribute">cnt</span>=22, <span class="attribute">size</span>=466, <span class="attribute">hs</span>=4</span><br><span class="line">[2021-08-11 18:22:29.503][Trace][39330][5mkn5262] RTC: DTLS handshake done.</span><br><span class="line">[2021-08-11 18:22:29.503][Trace][39330][5mkn5262] RTC: session <span class="attribute">pub</span>=0, <span class="attribute">sub</span>=1, <span class="attribute">to</span>=30000ms<span class="built_in"> connection </span>established</span><br><span class="line">[2021-08-11 18:22:29.503][Trace][39330][5mkn5262] RTC: Subscriber <span class="attribute">url</span>=/live/livestream established</span><br><span class="line">[2021-08-11 18:22:29.503][Trace][39330][5mkn5262] create consumer, <span class="literal">no</span> gop cache</span><br><span class="line">[2021-08-11 18:22:29.503][Trace][39330][5mkn5262] RTC: start play <span class="attribute">url</span>=/live/livestream, <span class="attribute">source_id</span>=/, <span class="attribute">realtime</span>=1, <span class="attribute">mw_msgs</span>=0</span><br><span class="line">[2021-08-11 18:22:30.016][Trace][39330][89983q51] Hybrid <span class="attribute">cpu</span>=1.00%,14MB</span><br><span class="line">[2021-08-11 18:22:30.016][Trace][39330][89983q51] RTC:<span class="built_in"> Server </span><span class="attribute">conns</span>=1</span><br><span class="line">[2021-08-11 18:22:35.016][Trace][39330][89983q51] Hybrid <span class="attribute">cpu</span>=1.00%,14MB</span><br><span class="line">[2021-08-11 18:22:35.016][Trace][39330][89983q51] RTC:<span class="built_in"> Server </span><span class="attribute">conns</span>=1</span><br><span class="line">[2021-08-11 18:22:37.033][Trace][39330][408j1397] RTMP<span class="built_in"> client </span><span class="attribute">ip</span>=127.0.0.1:23390, <span class="attribute">fd</span>=11</span><br><span class="line">[2021-08-11 18:22:37.035][Trace][39330][408j1397] complex handshake success</span><br><span class="line">[2021-08-11 18:22:37.035][Trace][39330][408j1397] connect app, <span class="attribute">tcUrl</span>=rtmp://localhost:1936/live, <span class="attribute">pageUrl</span>=, <span class="attribute">swfUrl</span>=, <span class="attribute">schema</span>=rtmp, <span class="attribute">vhost</span>=localhost, <span class="attribute">port</span>=1936, <span class="attribute">app</span>=live, <span class="attribute">args</span>=<span class="literal">null</span></span><br><span class="line">[2021-08-11 18:22:37.035][Trace][39330][408j1397] protocol <span class="keyword">in</span>.<span class="attribute">buffer</span>=0, <span class="keyword">in</span>.<span class="attribute">ack</span>=0, out.<span class="attribute">ack</span>=0, <span class="keyword">in</span>.<span class="attribute">chunk</span>=128, out.<span class="attribute">chunk</span>=128</span><br><span class="line">[2021-08-11 18:22:37.035][Trace][39330][408j1397]<span class="built_in"> client </span>identified, <span class="attribute">type</span>=fmle-publish, <span class="attribute">vhost</span>=localhost, <span class="attribute">app</span>=live, <span class="attribute">stream</span>=livestream, <span class="attribute">param</span>=, <span class="attribute">duration</span>=0ms</span><br><span class="line">[2021-08-11 18:22:37.035][Trace][39330][408j1397] connected stream, <span class="attribute">tcUrl</span>=rtmp://localhost:1936/live, <span class="attribute">pageUrl</span>=, <span class="attribute">swfUrl</span>=, <span class="attribute">schema</span>=rtmp, <span class="attribute">vhost</span>=__defaultVhost__, <span class="attribute">port</span>=1936, <span class="attribute">app</span>=live, <span class="attribute">stream</span>=livestream, <span class="attribute">param</span>=, <span class="attribute">args</span>=<span class="literal">null</span></span><br><span class="line">[2021-08-11 18:22:37.035][Trace][39330][408j1397] new source, <span class="attribute">stream_url</span>=/live/livestream</span><br><span class="line">[2021-08-11 18:22:37.035][Trace][39330][408j1397] source <span class="attribute">url</span>=/live/livestream, <span class="attribute">ip</span>=127.0.0.1, <span class="attribute">cache</span>=1, <span class="attribute">is_edge</span>=0, <span class="attribute">source_id</span>=/</span><br><span class="line">[2021-08-11 18:22:37.038][Trace][39330][408j1397] RTC<span class="built_in"> bridge </span><span class="keyword">from</span> RTMP, <span class="attribute">discard_aac</span>=0, <span class="attribute">discard_bframe</span>=1, <span class="attribute">merge_nalus</span>=0</span><br><span class="line">[2021-08-11 18:22:37.038][Trace][39330][408j1397] ignore disabled exec <span class="keyword">for</span> <span class="attribute">vhost</span>=__defaultVhost__</span><br><span class="line">[2021-08-11 18:22:37.038][Trace][39330][408j1397] http: mount flv stream <span class="keyword">for</span> <span class="attribute">sid</span>=/live/livestream, <span class="attribute">mount</span>=/live/livestream.flv</span><br><span class="line">[2021-08-11 18:22:37.038][Trace][39330][408j1397] start publish <span class="attribute">mr</span>=0/350, <span class="attribute">p1stpt</span>=20000, <span class="attribute">pnt</span>=5000, <span class="attribute">tcp_nodelay</span>=0</span><br><span class="line">[2021-08-11 18:22:37.038][Trace][39330][408j1397] got metadata, <span class="attribute">width</span>=768, <span class="attribute">height</span>=320, <span class="attribute">vcodec</span>=7, <span class="attribute">acodec</span>=10</span><br><span class="line">[2021-08-11 18:22:37.039][Trace][39330][408j1397] 46B video sh,  codec(7, <span class="attribute">profile</span>=High, <span class="attribute">level</span>=3.2, 768x320, 0kbps, 0.0fps, 0.0s)</span><br><span class="line">[2021-08-11 18:22:37.039][Trace][39330][408j1397] 4B audio sh, codec(10, <span class="attribute">profile</span>=LC, 2channels, 0kbps, 44100HZ), flv(16bits, 2channels, 44100HZ)</span><br><span class="line">[2021-08-11 18:22:37.040][Trace][39330][5mkn5262] update <span class="attribute">source_id</span>=408j1397/408j1397</span><br><span class="line">[2021-08-11 18:22:37.240][Trace][39330][89137u4l] &lt;- RTC RECV #10, udp 19, pps 1/1, schedule 19</span><br><span class="line">[2021-08-11 18:22:40.017][Trace][39330][89983q51] Hybrid <span class="attribute">cpu</span>=1.00%,17MB, <span class="attribute">cid</span>=6,3, <span class="attribute">timer</span>=63,0,39, <span class="attribute">clock</span>=0,48,1,0,0,0,0,1,0, <span class="attribute">free</span>=1, objs=(pkt:28,raw:23,fua:4,msg:59,oth:1,buf:11)</span><br><span class="line">[2021-08-11 18:22:40.017][Trace][39330][89983q51] RTC:<span class="built_in"> Server </span><span class="attribute">conns</span>=1</span><br><span class="line">[2021-08-11 18:22:45.018][Trace][39330][89983q51] Hybrid <span class="attribute">cpu</span>=2.00%,18MB, <span class="attribute">cid</span>=6,3, <span class="attribute">timer</span>=63,0,39, <span class="attribute">clock</span>=0,48,1,0,0,0,0,1,0, <span class="attribute">free</span>=1, objs=(pkt:28,raw:23,fua:4,msg:59,oth:1,buf:11)</span><br><span class="line">[2021-08-11 18:22:45.018][Trace][39330][89983q51] RTC:<span class="built_in"> Server </span><span class="attribute">conns</span>=1, rpkts=(1,rtp:0,stun:1,rtcp:1), spkts=(43,rtp:43,stun:1,rtcp:0), fid=(id:0,fid:0,ffid:1,addr:1,faddr:1)</span><br><span class="line">[2021-08-11 18:22:47.288][Trace][39330][89137u4l] &lt;- RTC RECV #10, udp 18, pps 1/1, schedule 18</span><br><span class="line">[2021-08-11 18:22:50.019][Trace][39330][89983q51] Hybrid <span class="attribute">cpu</span>=2.00%,18MB, <span class="attribute">cid</span>=6,3, <span class="attribute">timer</span>=63,0,39, <span class="attribute">clock</span>=0,48,1,0,0,0,0,1,0, <span class="attribute">free</span>=1, objs=(pkt:28,raw:23,fua:4,msg:59,oth:1,buf:11)</span><br><span class="line">[2021-08-11 18:22:50.019][Trace][39330][89983q51] RTC:<span class="built_in"> Server </span><span class="attribute">conns</span>=1, rpkts=(1,rtp:0,stun:1,rtcp:1), spkts=(43,rtp:43,stun:1,rtcp:0), fid=(id:0,fid:0,ffid:1,addr:1,faddr:1)</span><br><span class="line">[2021-08-11 18:22:55.020][Trace][39330][89983q51] Hybrid <span class="attribute">cpu</span>=2.00%,18MB, <span class="attribute">cid</span>=1,2, <span class="attribute">timer</span>=62,0,48, <span class="attribute">clock</span>=0,47,1,0,0,0,0,0,0, objs=(pkt:164,raw:113,fua:50,msg:300,oth:1,buf:50)</span><br><span class="line"></span><br><span class="line">创建session ice连接（udp) --p2p</span><br><span class="line">udp连接 ：rtc<span class="built_in"> connection </span>--ice连接</span><br><span class="line">之后设置了各种后</span><br><span class="line">offer？是通过udp</span><br><span class="line"></span><br><span class="line"> 创建session后，收到客户端的udp发包，进入onStun,接着回包；完成打洞；</span><br><span class="line">[2021-08-13 11:25:10.072][Trace][12488][a8j88kek] RTC: session<span class="built_in"> address </span>init 172.21.0.5:59005</span><br><span class="line">[2021-08-13 11:25:10.072][Trace][12488][a8j88kek] RTC: session STUN done, waiting DTLS handshake.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">接着开始dtls连接；即收到客户端的dtls握手包后处理：</span><br><span class="line">SrsDtlsImpl::on_dtls</span><br><span class="line">[2021-08-13 11:26:10.425][Trace][12488][a8j88kek] DTLS: State Passive RECV, <span class="attribute">done</span>=0, <span class="attribute">arq</span>=0/0, <span class="attribute">r0</span>=1, <span class="attribute">r1</span>=0, <span class="attribute">len</span>=159, <span class="attribute">cnt</span>=22, <span class="attribute">size</span>=146, <span class="attribute">hs</span>=1</span><br><span class="line">[2021-08-13 11:26:10.425][Trace][12488][a8j88kek] DTLS: State Passive SEND, <span class="attribute">done</span>=0, <span class="attribute">arq</span>=0/0, <span class="attribute">r0</span>=-1, <span class="attribute">r1</span>=2, <span class="attribute">len</span>=681, <span class="attribute">cnt</span>=22, <span class="attribute">size</span>=82, <span class="attribute">hs</span>=2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">接着进on_rtcp传rtcp的数据；</span><br></pre></td></tr></table></figure>
<p>3 订阅过程：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">在收到http请求后，走到srs_error_t SrsGoApiRtcPlay::<span class="keyword">do</span><span class="constructor">_serve_http(ISrsHttpResponseWriter<span class="operator">*</span> <span class="params">w</span>, ISrsHttpMessage<span class="operator">*</span> <span class="params">r</span>, SrsJsonObject<span class="operator">*</span> <span class="params">res</span>)</span></span><br><span class="line">会构造 req = json-&gt;<span class="keyword">to</span><span class="constructor">_object()</span>;</span><br><span class="line">在创建会话session时传入：</span><br><span class="line">SrsRtcServer::create<span class="constructor">_session(SrsRtcUserConfig<span class="operator">*</span> <span class="params">ruc</span>, SrsSdp&amp; <span class="params">local_sdp</span>, SrsRtcConnection<span class="operator">**</span> <span class="params">psession</span>)</span></span><br><span class="line">err = session-&gt;add<span class="constructor">_player(<span class="params">ruc</span>, <span class="params">local_sdp</span>)</span></span><br><span class="line"> create<span class="constructor">_player(<span class="params">req</span>, <span class="params">play_sub_relations</span>)</span>) </span><br><span class="line">   后初始化时，会去检测是否有这个流：</span><br><span class="line">        <span class="keyword">if</span> ((err = _srs_rtc_sources-&gt;fetch<span class="constructor">_or_create(<span class="params">req_</span>, &amp;<span class="params">source_</span>)</span>) != srs_success) &#123;</span><br><span class="line">        return srs<span class="constructor">_error_wrap(<span class="params">err</span>, <span class="string">&quot;rtc fetch source failed&quot;</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">流和RtcSource放在这个结构：pool<span class="literal">[<span class="identifier">stream_url</span>]</span> = source;</span><br><span class="line">    std::map&lt;std::<span class="built_in">string</span>, SrsRtcSource*&gt; pool;</span><br><span class="line"></span><br><span class="line">早在这里：rtmp推上来后，若配置了rtc就会创建了；所以在rtc创建play后能找到这个rtcsource，进而创建comsumor来取包发送；</span><br><span class="line">srs_error_t SrsRtmpConn::acquire<span class="constructor">_publish(SrsLiveSource<span class="operator">*</span> <span class="params">source</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    srs_error_t err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check whether RTMP stream is busy.</span></span><br><span class="line">    <span class="keyword">if</span> (!source-&gt;can<span class="constructor">_publish(<span class="params">info</span>-&gt;<span class="params">edge</span>)</span>) &#123;</span><br><span class="line">        return srs<span class="constructor">_error_new(ERROR_SYSTEM_STREAM_BUSY, <span class="string">&quot;rtmp: stream %s is busy&quot;</span>, <span class="params">req</span>-&gt;<span class="params">get_stream_url</span>()</span>.c<span class="constructor">_str()</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Check whether RTC stream is busy.</span></span><br><span class="line">#ifdef SRS_RTC</span><br><span class="line">    SrsRtcSource *rtc = NULL;</span><br><span class="line">    <span class="built_in">bool</span> rtc_server_enabled = _srs_config-&gt;get<span class="constructor">_rtc_server_enabled()</span>;</span><br><span class="line">    <span class="built_in">bool</span> rtc_enabled = _srs_config-&gt;get<span class="constructor">_rtc_enabled(<span class="params">req</span>-&gt;<span class="params">vhost</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (rtc_server_enabled<span class="operator"> &amp;&amp; </span>rtc_enabled<span class="operator"> &amp;&amp; </span>!info-&gt;edge) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = _srs_rtc_sources-&gt;fetch<span class="constructor">_or_create(<span class="params">req</span>, &amp;<span class="params">rtc</span>)</span>) != srs_success) &#123;</span><br><span class="line">            return srs<span class="constructor">_error_wrap(<span class="params">err</span>, <span class="string">&quot;create source&quot;</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!rtc-&gt;can<span class="constructor">_publish()</span>) &#123;</span><br><span class="line">            return srs<span class="constructor">_error_new(ERROR_SYSTEM_STREAM_BUSY, <span class="string">&quot;rtc stream %s busy&quot;</span>, <span class="params">req</span>-&gt;<span class="params">get_stream_url</span>()</span>.c<span class="constructor">_str()</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bridge to RTC streaming.</span></span><br><span class="line">#<span class="keyword">if</span> defined(SRS_RTC)<span class="operator"> &amp;&amp; </span>defined(SRS_FFMPEG_FIT)</span><br></pre></td></tr></table></figure>




<p>4 srtp加密,传输；<br>传输数据；调用流程；</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">srs_error_t SrsRtcFromRtmpBridger::transcode(SrsAudioFrame* audio)</span><br><span class="line">&#123;</span><br><span class="line">    srs_error_t err = srs_success;</span><br><span class="line"></span><br><span class="line">    std::vector&lt;SrsAudioFrame *&gt; out_audios;</span><br><span class="line">    <span class="keyword">if</span> ((err = codec_-&gt;transcode(audio, out_audios)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> srs_error_wrap(err, <span class="string">&quot;recode error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Save OPUS packets in shared message.</span></span><br><span class="line">    <span class="keyword">if</span> (out_audios.empty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (std::vector&lt;SrsAudioFrame*&gt;::iterator it = out_audios.begin(); it != out_audios.end(); ++it) &#123;</span><br><span class="line">        SrsAudioFrame* out_audio = *it;</span><br><span class="line"></span><br><span class="line">        SrsRtpPacket* pkt = <span class="keyword">new</span> SrsRtpPacket();</span><br><span class="line">        SrsAutoFree(SrsRtpPacket, pkt);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((err = package_opus(out_audio, pkt)) != srs_success) &#123;</span><br><span class="line">            err = srs_error_wrap(err, <span class="string">&quot;package opus&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((err = source_-&gt;on_rtp(pkt)) != srs_success) &#123;</span><br><span class="line">            err = srs_error_wrap(err, <span class="string">&quot;consume opus&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    codec_-&gt;free_frames(out_audios);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">srs_error_t SrsRtcSource::on_rtp(SrsRtpPacket* pkt)</span><br><span class="line">&#123;</span><br><span class="line">    srs_error_t err = srs_success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If circuit-breaker is dying, drop packet.</span></span><br><span class="line">    <span class="keyword">if</span> (_srs_circuit_breaker-&gt;hybrid_dying_water_level()) &#123;</span><br><span class="line">        _srs_pps_aloss2-&gt;sugar += (int64_t)consumers.<span class="keyword">size</span>();</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)consumers.<span class="keyword">size</span>(); i++) &#123; <span class="comment">//这里是看有没有订阅者，如果请求的---</span></span><br><span class="line">        SrsRtcConsumer* consumer = consumers.at(i); </span><br><span class="line">        <span class="keyword">if</span> ((err = consumer-&gt;enqueue(pkt-&gt;<span class="keyword">copy</span>())) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> srs_error_wrap(err, <span class="string">&quot;consume message&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bridger_ &amp;&amp; (err = bridger_-&gt;on_rtp(pkt)) != srs_success) &#123;</span><br><span class="line">        <span class="keyword">return</span> srs_error_wrap(err, <span class="string">&quot;bridger consume message&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="number">3</span>, SrsRtcSource::on_rtp (<span class="keyword">this</span>=<span class="number">0</span>x55ee8c800030, pkt=<span class="number">0</span>x55ee8c84d680) at src<span class="regexp">/app/</span>srs_app_rtc_source.cpp:<span class="number">612</span></span><br><span class="line"><span class="number">612</span>	&#123;</span><br><span class="line">Breakpoint <span class="number">4</span> at <span class="number">0</span>x55ee8a2b1a9a: on_video. (<span class="number">13</span> locations)</span><br><span class="line">#<span class="number">0</span>  SrsRtcSource::on_rtp (<span class="keyword">this</span>=<span class="number">0</span>x55ee8c800030, pkt=<span class="number">0</span>x55ee8c84d680) at src<span class="regexp">/app/</span>srs_app_rtc_source.cpp:<span class="number">612</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0</span>x000055ee8a4e5eb4 in SrsRtcFromRtmpBridger::transcode (<span class="keyword">this</span>=<span class="number">0</span>x55ee8c800030, audio=<span class="number">0</span>x55ee8c76d260) at src<span class="regexp">/app/</span>srs_app_rtc_source.cpp:<span class="number">867</span></span><br><span class="line">#<span class="number">2</span>  <span class="number">0</span>x000055ee8a4e5c6d in SrsRtcFromRtmpBridger::on_audio (<span class="keyword">this</span>=<span class="number">0</span>x55ee8c800030, msg=<span class="number">0</span>x55ee8c76eb70) at src<span class="regexp">/app/</span>srs_app_rtc_source.cpp:<span class="number">834</span></span><br><span class="line">#<span class="number">3</span>  <span class="number">0</span>x000055ee8a3a9b18 in SrsLiveSource::on_audio_imp (<span class="keyword">this</span>=<span class="number">0</span>x55ee8c426a70, msg=<span class="number">0</span>x55ee8c76eb70) at src<span class="regexp">/app/</span>srs_app_source.cpp:<span class="number">2205</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0</span>x000055ee8a3a96de in SrsLiveSource::on_audio (<span class="keyword">this</span>=<span class="number">0</span>x55ee8c426a70, shared_audio=<span class="number">0</span>x55ee8c652fc0) at src<span class="regexp">/app/</span>srs_app_source.cpp:<span class="number">2160</span></span><br><span class="line">#<span class="number">5</span>  <span class="number">0</span>x000055ee8a39b751 in SrsRtmpConn::process_publish_message (<span class="keyword">this</span>=<span class="number">0</span>x55ee8c571170, <span class="keyword">source</span>=<span class="number">0</span>x55ee8c426a70, msg=<span class="number">0</span>x55ee8c652fc0) at src<span class="regexp">/app/</span>srs_app_rtmp_conn.cpp:<span class="number">1055</span></span><br><span class="line">--Type &lt;RET&gt; <span class="keyword">for</span> more, q to quit, c to <span class="keyword">continue</span> without paging--</span><br><span class="line">#<span class="number">6</span>  <span class="number">0</span>x000055ee8a39b5bd in SrsRtmpConn::handle_publish_message (<span class="keyword">this</span>=<span class="number">0</span>x55ee8c571170, <span class="keyword">source</span>=<span class="number">0</span>x55ee8c426a70, msg=<span class="number">0</span>x55ee8c652fc0) at src<span class="regexp">/app/</span>srs_app_rtmp_conn.cpp:<span class="number">1034</span></span><br><span class="line">#<span class="number">7</span>  <span class="number">0</span>x000055ee8a45afb7 in SrsPublishRecvThread::consume (<span class="keyword">this</span>=<span class="number">0</span>x55ee8c6b6f40, msg=<span class="number">0</span>x55ee8c652fc0) at src<span class="regexp">/app/</span>srs_app_recv_thread.cpp:<span class="number">376</span></span><br><span class="line">#<span class="number">8</span>  <span class="number">0</span>x000055ee8a459f11 in SrsRecvThread::do_cycle (<span class="keyword">this</span>=<span class="number">0</span>x55ee8c6b6f60) at src<span class="regexp">/app/</span>srs_app_recv_thread.cpp:<span class="number">133</span></span><br><span class="line">#<span class="number">9</span>  <span class="number">0</span>x000055ee8a459d5e in SrsRecvThread::cycle (<span class="keyword">this</span>=<span class="number">0</span>x55ee8c6b6f60) at src<span class="regexp">/app/</span>srs_app_recv_thread.cpp:<span class="number">102</span></span><br><span class="line">#<span class="number">10</span> <span class="number">0</span>x000055ee8a3ce1b8 in SrsFastCoroutine::cycle (<span class="keyword">this</span>=<span class="number">0</span>x55ee8c77fbb0) at src<span class="regexp">/app/</span>srs_app_st.cpp:<span class="number">253</span></span><br><span class="line">#<span class="number">11</span> <span class="number">0</span>x000055ee8a3ce25c in SrsFastCoroutine::pfn (arg=<span class="number">0</span>x55ee8c77fbb0) at src<span class="regexp">/app/</span>srs_app_st.cpp:<span class="number">268</span></span><br><span class="line">#<span class="number">12</span> <span class="number">0</span>x000055ee8a50072f in _st_thread_main () at sched.c:<span class="number">363</span></span><br><span class="line">#<span class="number">13</span> <span class="number">0</span>x000055ee8a500fe8 in st_thread_create (start=<span class="number">0</span>x55ee8c3f12c0, arg=<span class="number">0</span>x55ee8c3f12e0, joinable=<span class="number">21998</span>, stk_size=-<span class="number">1942023440</span>) at sched.c:<span class="number">694</span></span><br><span class="line">Backtrace stopped: <span class="keyword">previous</span> frame inner to <span class="keyword">this</span> frame (corrupt stack?)</span><br><span class="line"></span><br><span class="line">实际上，在有srsrtcsource下，才会创建rtmpbridge,并在recvThread统计调用rtmp接收后，发送给bridge，到rtcsoucre;</span><br><span class="line">srs_error_t SrsRtmpConn::acquire_publish(SrsLiveSource* <span class="keyword">source</span>)</span><br><span class="line">&#123;</span><br><span class="line">    srs_error_t err = srs_success;</span><br><span class="line">    </span><br><span class="line">    SrsRequest* req = info-&gt;req;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check whether RTMP stream is busy.</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">source</span>-&gt;can_publish(info-&gt;edge)) &#123;</span><br><span class="line">        <span class="keyword">return</span> srs_error_new(ERROR_SYSTEM_STREAM_BUSY, <span class="string">&quot;rtmp: stream %s is busy&quot;</span>, req-&gt;get_stream_url().c_str());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Check whether RTC stream is busy.</span></span><br><span class="line">#ifdef SRS_RTC</span><br><span class="line">    SrsRtcSource *rtc = <span class="keyword">NULL</span>;</span><br><span class="line">    bool rtc_server_enabled = _srs_config-&gt;get_rtc_server_enabled();</span><br><span class="line">    bool rtc_enabled = _srs_config-&gt;get_rtc_enabled(req-&gt;vhost);</span><br><span class="line">    <span class="keyword">if</span> (rtc_server_enabled &amp;&amp; rtc_enabled &amp;&amp; !info-&gt;edge) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = _srs_rtc_sources-&gt;fetch_or_create(req, &amp;rtc)) != srs_success) &#123;</span><br><span class="line">            <span class="keyword">return</span> srs_error_wrap(err, <span class="string">&quot;create source&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!rtc-&gt;can_publish()) &#123;</span><br><span class="line">            <span class="keyword">return</span> srs_error_new(ERROR_SYSTEM_STREAM_BUSY, <span class="string">&quot;rtc stream %s busy&quot;</span>, req-&gt;get_stream_url().c_str());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bridge to RTC streaming.</span></span><br><span class="line">#<span class="keyword">if</span> defined(SRS_RTC) &amp;&amp; defined(SRS_FFMPEG_FIT)</span><br><span class="line">    <span class="keyword">if</span> (rtc) &#123;</span><br><span class="line">        SrsRtcFromRtmpBridger *bridger = <span class="keyword">new</span> SrsRtcFromRtmpBridger(rtc);</span><br><span class="line">        <span class="keyword">if</span> ((err = bridger-&gt;initialize(req)) != srs_success) &#123;</span><br><span class="line">            srs_freep(bridger);</span><br><span class="line">            <span class="keyword">return</span> srs_error_wrap(err, <span class="string">&quot;bridger init&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">source</span>-&gt;set_bridger(bridger);</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start publisher now.</span></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;edge) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">source</span>-&gt;on_edge_start_publish();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">source</span>-&gt;on_publish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>ref:<br><a target="_blank" rel="noopener" href="https://github.com/ossrs/srs">https://github.com/ossrs/srs</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/srs/" rel="tag"># srs</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/04/webrtc-code/" rel="prev" title="webrtc_code">
      <i class="fa fa-chevron-left"></i> webrtc_code
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/04/04/linux-nettx-dev/" rel="next" title="linux_nettx_dev">
      linux_nettx_dev <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#srs%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">1.</span> <span class="nav-text">srs代码流程图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#srs%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">srs代码流程分析:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gdb%E8%B0%83%E8%AF%95%EF%BC%9A"><span class="nav-number">3.</span> <span class="nav-text">gdb调试：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gdb%E8%B0%83%E8%AF%95%E4%B8%80%E4%B8%AA%E5%9C%BA%E6%99%AF%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%EF%BC%9A"><span class="nav-number">4.</span> <span class="nav-text">gdb调试一个场景代码流程分析：</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="小兴"
      src="/images/headicon2.jpg">
  <p class="site-author-name" itemprop="name">小兴</p>
  <div class="site-description" itemprop="description">始于歧路，愿归于征途</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">88</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xdksx/" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xdksx&#x2F;" rel="noopener" target="_blank"><i class="fa fa-fw fa-github-square"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/ksance@gmail.com" title="E-Mail → ksance@gmail.com"><i class="fa fa-fw fa-envelope"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/572897439" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;572897439" rel="noopener" target="_blank"><i class="fa fa-fw fa-facebook"></i></a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      friendly link
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://yoursite.com/" title="http:&#x2F;&#x2F;yoursite.com" rel="noopener" target="_blank">Title</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小兴</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v6.1.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '06e6b70d396f6928e45a',
      clientSecret: 'cd03b7c657d50a5d76a7fa682c4f8eb48cb15fc3',
      repo        : 'xdksx.github.io',
      owner       : 'xdksx',
      admin       : ['xdksx'],
      id          : '11ebbd5494195753fbd472c56d8c15d1',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
