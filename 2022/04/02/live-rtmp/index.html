<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xdksx.github.io","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="1 rtmp是什么：Adobe’s Real Time Messaging Protocol (RTMP) provides a bidirectional message multiplex service over a reliable stream transport, such as TCP [RFC0793], intended to carry parallel streams of">
<meta property="og:type" content="article">
<meta property="og:title" content="live_rtmp">
<meta property="og:url" content="https://xdksx.github.io/2022/04/02/live-rtmp/index.html">
<meta property="og:site_name" content="追光者">
<meta property="og:description" content="1 rtmp是什么：Adobe’s Real Time Messaging Protocol (RTMP) provides a bidirectional message multiplex service over a reliable stream transport, such as TCP [RFC0793], intended to carry parallel streams of">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-04-02T09:52:47.000Z">
<meta property="article:modified_time" content="2022-04-02T12:08:49.508Z">
<meta property="article:author" content="小兴">
<meta property="article:tag" content="rtmp">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://xdksx.github.io/2022/04/02/live-rtmp/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>live_rtmp | 追光者</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">追光者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">小兴的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-观影">

    <a href="/movies/" rel="section"><i class="fa fa-fw fa-film"></i>观影</a>

  </li>
        <li class="menu-item menu-item-阅读">

    <a href="/read/" rel="section"><i class="fa fa-fw fa-book"></i>阅读</a>

  </li>
        <li class="menu-item menu-item-心理">

    <a href="/categories/%E5%BF%83%E7%90%86/" rel="section"><i class="fa fa-fw fa-heart"></i>心理</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xdksx.github.io/2022/04/02/live-rtmp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/headicon2.jpg">
      <meta itemprop="name" content="小兴">
      <meta itemprop="description" content="始于歧路，愿归于征途">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追光者">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          live_rtmp
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-02 17:52:47 / 修改时间：20:08:49" itemprop="dateCreated datePublished" datetime="2022-04-02T17:52:47+08:00">2022-04-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/live/" itemprop="url" rel="index"><span itemprop="name">live</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="1-rtmp是什么："><a href="#1-rtmp是什么：" class="headerlink" title="1 rtmp是什么："></a>1 rtmp是什么：</h3><p>Adobe’s Real Time Messaging Protocol (RTMP) provides a bidirectional message multiplex service over a reliable stream transport, such as TCP [RFC0793], intended to carry parallel streams of video, audio, and data messages, with associated timing information, between a pair of communicating peers. Implementations typically assign different priorities to different classes of messages, which can effect the order in which messages are enqueued to the underlying stream transport when transport capacity is constrained.<br>说白了就是基于tcp等可靠协议的实Adobe开发的实时信息协议，主要用于流媒体如音频视频等上，携带时间信息来做同步。 <span id="more"></span></p>
<p>rtmp基于tcp</p>
<h3 id="2-rtmp中的元素："><a href="#2-rtmp中的元素：" class="headerlink" title="2 rtmp中的元素："></a>2 rtmp中的元素：</h3><ul>
<li>Payload: The data contained in a packet, for example audio samples or compressed video data. The payload format and interpretation are beyond the scope of this document.</li>
<li>Packet: A data packet consists of fixed header and payload data. Some underlying protocols may require an encapsulation of the packet to be defined.</li>
<li>Port: The “abstraction that transport protocols use to distinguish among multiple destinations within a given host computer. TCP&#x2F;IP protocols identify ports using small positive integers.” The transport selectors (TSEL) used by the OSI transport layer are equivalent to ports.</li>
<li>Transport address: The combination of a network address and port that identifies a transport-level endpoint, for example an IP address and a TCP port. Packets are transmitted from a source transport address to a destination transport address.</li>
<li>Message stream: A logical channel of communication in which messages flow.</li>
<li>Message stream ID: Each message has an ID associated with it to identify the message stream in which it is flowing.</li>
<li>Chunk: A fragment of a message. The messages are broken into smaller parts and interleaved before they are sent over the network. The chunks ensure timestamp-ordered end-to-end delivery of all messages, across multiple streams.</li>
<li>Chunk stream: A logical channel of communication that allows flow of chunks in a particular direction. The chunk stream can travel from the client to the server and reverse.</li>
<li>Chunk stream ID: Every chunk has an ID associated with it to identify the chunk stream in which it is flowing.</li>
<li>Multiplexing: Process of making separate audio&#x2F;video data into one coherent audio&#x2F;video stream, making it possible to transmit several video and audio simultaneously.</li>
<li>DeMultiplexing: Reverse process of multiplexing, in which interleaved audio and video data are assembled to form the original audio and video data.</li>
<li>Remote Procedure Call (RPC): A request that allows a client or a server to call a subroutine or procedure at the peer end.</li>
<li>Metadata: A description about the data. The metadata of a movie includes the movie title, duration, date of creation, and so on.</li>
<li>Application Instance: The instance of the application at the server with which the clients connect by sending the connect request.</li>
<li>Action Message Format (AMF): A compact binary format that is used to serialize ActionScript object graphs. AMF has two versions: AMF 0 [AMF0] and AMF 3 [AMF3].</li>
</ul>
<h3 id="3-字节序，对齐和时间格式："><a href="#3-字节序，对齐和时间格式：" class="headerlink" title="3 字节序，对齐和时间格式："></a>3 字节序，对齐和时间格式：</h3><ul>
<li><p>所有整数字段都以网络字节顺序传送，字节零是显示的第一个字节，位零是字或字段中的最高有效位。这种字节顺序通常称为大端。传输顺序在 Internet 协议 [RFC0791] 中有详细描述。除非另有说明，否则本文档中的数字常量为十进制（以 10 为基数）。</p>
</li>
<li><p>除非另有说明，RTMP中的所有数据都是字节对齐的；例如，16 位字段可能位于奇数字节偏移处。在指示填充的地方，填充字节应该具有零值。</p>
</li>
<li><p>RTMP 中的时间戳以相对于未指定时期的整数毫秒数给出。通常，每个流将以 0 的时间戳开始，但这不是必需的，只要两个端点在 epoch 上达成一致即可。请注意，这意味着跨多个流（尤其是来自不同主机）的任何同步都需要 RTMP 之外的一些额外机制。</p>
</li>
<li><p>因为时间戳是 32 位长，它们每 49 天 17 小时 2 分钟 47.296 秒翻转一次。因为流被允许连续运行，可能持续数年，RTMP 应用程序在处理时间戳时应该使用序列号算法 [RFC1982]，并且应该能够处理回绕。例如，应用程序假设所有相邻的时间戳都在 2^31 - 1 毫秒内，因此 10000 在 4000000000 之后，而 3000000000 在 4000000000 之前。</p>
</li>
<li><p>时间戳增量也指定为相对于前一个时间戳的无符号整数毫秒数。时间戳增量可以是 24 位或 32 位长。</p>
</li>
</ul>
<h3 id="4-RTMP-CHUNK-STREAM"><a href="#4-RTMP-CHUNK-STREAM" class="headerlink" title="4 RTMP CHUNK STREAM:"></a>4 RTMP CHUNK STREAM:</h3><ul>
<li>本节指定实时消息传递协议块流（RTMP 块流）。它为更高级别的多媒体流协议提供多路复用和打包服务。</li>
<li>虽然 RTMP 块流被设计为与实时消息传递协议（第 6 节）一起使用，但它可以处理任何发送消息流的协议。每条消息都包含时间戳和有效负载类型标识。 RTMP Chunk Stream 和 RTMP 一起适用于各种音视频应用，从一对一和一对多直播到视频点播服务再到交互式会议应用。</li>
<li>当与可靠的传输协议（如 TCP [RFC0793]）一起使用时，RTMP 块流提供跨多个流的所有消息的有保证的时间戳顺序端到端传递。 RTMP 块流不提供任何优先级或类似形式的控制，但可以被更高级别的协议用于提供此类优先级。</li>
<li>例如，实时视频服务器可能会根据发送时间或确认每条消息的时间，选择为慢速客户端丢弃视频消息，以确保及时接收音频消息。</li>
<li>RTMP Chunk Stream 包含自己的带内协议控制消息，并且还提供了一种机制让上层协议嵌入用户控制消息。</li>
</ul>
<h4 id="4-1-Message-Format"><a href="#4-1-Message-Format" class="headerlink" title="4.1 Message Format:"></a>4.1 Message Format:</h4><p>The format of a message that can be split into chunks to support multiplexing depends on a higher level protocol.<br>The message format SHOULD however contain the following fields which are necessary for creating the chunks.<br>可以拆分为块以支持多路复用的消息格式取决于更高级别的协议。 然而，消息格式应该包含创建块所必需的以下字段。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Timestamp</span>: <span class="type">Timestamp</span> <span class="keyword">of</span> the message. This field can transport <span class="number">4</span> bytes.</span><br><span class="line">Length: Length <span class="keyword">of</span> the message payload. <span class="keyword">If</span> the message <span class="keyword">header</span> cannot be elided, it should be included <span class="keyword">in</span> the length. This field occupies <span class="number">3</span> bytes <span class="keyword">in</span> the chunk <span class="keyword">header</span>.</span><br><span class="line"><span class="keyword">Type</span> Id: A range <span class="keyword">of</span> <span class="keyword">type</span> IDs are reserved <span class="keyword">for</span> protocol control messages. These messages which propagate information are handled <span class="keyword">by</span> <span class="keyword">both</span> RTMP Chunk Stream protocol <span class="keyword">and</span> the higher-<span class="keyword">level</span> protocol. <span class="keyword">All</span> other <span class="keyword">type</span> IDs are available <span class="keyword">for</span> use <span class="keyword">by</span> the higher-<span class="keyword">level</span> protocol, <span class="keyword">and</span> treated <span class="keyword">as</span> <span class="type">opaque</span> <span class="keyword">values</span> <span class="keyword">by</span> RTMP Chunk Stream. <span class="keyword">In</span> fact, <span class="keyword">nothing</span> <span class="keyword">in</span> RTMP Chunk Stream requires these <span class="keyword">values</span> <span class="keyword">to</span> be used <span class="keyword">as</span> a <span class="keyword">type</span>; <span class="keyword">all</span> (non-protocol) messages could be <span class="keyword">of</span> the same <span class="keyword">type</span>, <span class="keyword">or</span> the application could use this field <span class="keyword">to</span> distinguish simultaneous tracks rather than <span class="keyword">types</span>. This field occupies <span class="number">1</span> byte <span class="keyword">in</span> the chunk <span class="keyword">header</span>.</span><br><span class="line">Message Stream ID: The message stream ID can be <span class="keyword">any</span> arbitrary <span class="keyword">value</span>. Different message streams multiplexed onto the same chunk stream are demultiplexed based <span class="keyword">on</span> their message stream IDs. Beyond that, <span class="keyword">as</span> far <span class="keyword">as</span> RTMP Chunk Stream <span class="keyword">is</span> concerned, this <span class="keyword">is</span> an <span class="type">opaque</span> <span class="keyword">value</span>. This field occupies <span class="number">4</span> bytes <span class="keyword">in</span> the chunk <span class="keyword">header</span> <span class="keyword">in</span> little endian <span class="keyword">format</span>.</span><br></pre></td></tr></table></figure>

<h4 id="4-2-握手："><a href="#4-2-握手：" class="headerlink" title="4.2 握手："></a>4.2 握手：</h4><ul>
<li>RTMP 连接以握手开始。 握手与协议的其余部分不同； 它由三个静态大小的块组成，而不是由带有标题的可变大小的块组成。 客户端（发起连接的端点）和服务器各自发送相同的三个块。 为了说明，这些块在客户端发送时将被指定为 C0、C1 和 C2； 由服务器发送时的 S0、S1 和 S2。</li>
</ul>
<h5 id="Handshake-Sequence"><a href="#Handshake-Sequence" class="headerlink" title="Handshake Sequence"></a>Handshake Sequence</h5><ul>
<li>握手从客户端发送 C0 和 C1 块开始。 客户端必须等到收到 S1 后再发送 C2。 客户端必须等到收到 S2 后再发送任何其他数据。</li>
<li>服务器必须等到收到 C0 后再发送 S0 和 S1，也可以等到 C1 之后。 服务器必须等到收到 C1 后再发送 S2。 服务器必须等到收到 C2 后再发送任何其他数据。</li>
</ul>
<h5 id="C0-and-S0-Format"><a href="#C0-and-S0-Format" class="headerlink" title="C0 and S0 Format"></a>C0 and S0 Format</h5><p>The C0 and S0 packets are a single octet, treated as a single 8-bit integer field:</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span></span><br><span class="line"> +-+-+-+-+-+-+-+-+</span><br><span class="line"> <span class="title">|    version    |</span></span><br><span class="line"> +-+-+-+-+-+-+-+-+</span><br><span class="line"></span><br><span class="line">  <span class="built_in">C0</span> <span class="keyword">and</span> <span class="built_in">S0</span> bits</span><br><span class="line"><span class="symbol">version</span>（<span class="number">8</span> 位）：在 <span class="built_in">C0</span> 中，该字段标识客户端请求的 RTMP 版本。 在 <span class="built_in">S0</span> 中，该字段标识服务器选择的 RTMP 版本。 本规范定义的版本是 <span class="number">3</span>。值 <span class="number">0</span>-<span class="number">2</span> 是早期专有产品不推荐使用的值； <span class="number">4</span>-<span class="number">31</span> 保留用于将来的实现； 和 <span class="number">32</span>-<span class="number">255</span> 是不允许的（以允许将 RTMP 与基于文本的协议区分开来，后者总是以可打印字符开头）。 无法识别客户端请求版本的服务器应该以 <span class="number">3</span> 响应。客户端可以选择降级到版本 <span class="number">3</span>，或者放弃握手。</span><br></pre></td></tr></table></figure>

<h5 id="C1-and-S1-Format"><a href="#C1-and-S1-Format" class="headerlink" title="C1 and S1 Format"></a>C1 and S1 Format</h5><p>The C1 and S1 packets are 1536 octets long, consisting of the following fields:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0</span>                   <span class="number">1</span>                   <span class="number">2</span>                   <span class="number">3</span></span><br><span class="line">  <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                        <span class="built_in">time</span> (<span class="number">4</span> <span class="keyword">bytes</span>)                         |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                        <span class="literal">zero</span> (<span class="number">4</span> <span class="keyword">bytes</span>)                         |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                        <span class="built_in">random</span> <span class="keyword">bytes</span>                           |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                        <span class="built_in">random</span> <span class="keyword">bytes</span>                           |</span><br><span class="line"> |                           (cont)                              |</span><br><span class="line"> |                            ....                               |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"></span><br><span class="line">                         C1 <span class="keyword">and</span> S1 bits</span><br><span class="line">Time (<span class="number">4</span> <span class="keyword">bytes</span>): This field <span class="keyword">contains</span> <span class="keyword">a</span> timestamp, which SHOULD be used <span class="keyword">as</span> <span class="keyword">the</span> epoch <span class="keyword">for</span> all future chunks sent <span class="built_in">from</span> this endpoint. This may be <span class="number">0</span>, <span class="keyword">or</span> some arbitrary <span class="built_in">value</span>. To synchronize multiple chunkstreams, <span class="keyword">the</span> endpoint may wish <span class="built_in">to</span> <span class="built_in">send</span> <span class="keyword">the</span> current <span class="built_in">value</span> <span class="keyword">of</span> <span class="keyword">the</span> other chunkstream’s timestamp.</span><br><span class="line">Zero (<span class="number">4</span> <span class="keyword">bytes</span>): This field MUST be all <span class="number">0</span>s.</span><br><span class="line">Random data (<span class="number">1528</span> <span class="keyword">bytes</span>): This field can contain <span class="keyword">any</span> arbitrary values. Since <span class="keyword">each</span> endpoint has <span class="built_in">to</span> distinguish between <span class="keyword">the</span> response <span class="built_in">to</span> <span class="keyword">the</span> handshake <span class="keyword">it</span> has initiated <span class="keyword">and</span> <span class="keyword">the</span> handshake initiated <span class="keyword">by</span> its peer,this data SHOULD <span class="built_in">send</span> something sufficiently <span class="built_in">random</span>. But there is no need <span class="keyword">for</span> cryptographically-secure randomness, <span class="keyword">or</span> even dynamic values.</span><br></pre></td></tr></table></figure>


<h5 id="C2-and-S2-Format"><a href="#C2-and-S2-Format" class="headerlink" title="C2 and S2 Format"></a>C2 and S2 Format</h5><p>The C2 and S2 packets are 1536 octets long, and nearly an echo of S1 and C1 (respectively), consisting of the following fields:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0</span>                   <span class="number">1</span>                   <span class="number">2</span>                   <span class="number">3</span></span><br><span class="line">  <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                        <span class="built_in">time</span> (<span class="number">4</span> <span class="keyword">bytes</span>)                         |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                       time2 (<span class="number">4</span> <span class="keyword">bytes</span>)                         |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                         <span class="built_in">random</span> echo                           |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                         <span class="built_in">random</span> echo                           |</span><br><span class="line"> |                            (cont)                             |</span><br><span class="line"> |                             ....                              |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"></span><br><span class="line">                          C2 <span class="keyword">and</span> S2 bits</span><br><span class="line">Time (<span class="number">4</span> <span class="keyword">bytes</span>): This field MUST contain <span class="keyword">the</span> timestamp sent <span class="keyword">by</span> <span class="keyword">the</span> peer <span class="keyword">in</span> S1 (<span class="keyword">for</span> C2) <span class="keyword">or</span> C1 (<span class="keyword">for</span> S2).</span><br><span class="line">Time2 (<span class="number">4</span> <span class="keyword">bytes</span>): This field MUST contain <span class="keyword">the</span> timestamp <span class="keyword">at</span> which <span class="keyword">the</span> previous packet(s1 <span class="keyword">or</span> c1) sent <span class="keyword">by</span> <span class="keyword">the</span> peer was <span class="built_in">read</span>.</span><br><span class="line">Random echo (<span class="number">1528</span> <span class="keyword">bytes</span>): This field MUST contain <span class="keyword">the</span> <span class="built_in">random</span> data field sent <span class="keyword">by</span> <span class="keyword">the</span> peer <span class="keyword">in</span> S1 (<span class="keyword">for</span> C2) <span class="keyword">or</span> S2 (<span class="keyword">for</span> C1). Either peer can use <span class="keyword">the</span> <span class="built_in">time</span> <span class="keyword">and</span> time2 fields together <span class="keyword">with</span> <span class="keyword">the</span> current timestamp <span class="keyword">as</span> <span class="keyword">a</span> quick estimate <span class="keyword">of</span> <span class="keyword">the</span> bandwidth <span class="keyword">and</span>/<span class="keyword">or</span> latency <span class="keyword">of</span> <span class="keyword">the</span> connection, but this is unlikely <span class="built_in">to</span> be useful.</span><br></pre></td></tr></table></figure>
<h5 id="交互图"><a href="#交互图" class="headerlink" title="交互图"></a>交互图</h5><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">+-------------+                            +-------------+</span><br><span class="line">|<span class="string">   Client    </span>|<span class="string">        TCP/IP Network      </span>|<span class="string">    Server   </span>|</span><br><span class="line">+-------------+             |<span class="string">              +-------------+</span></span><br><span class="line"><span class="string">       </span>|<span class="string">                    </span>|<span class="string">                     </span>|</span><br><span class="line">Uninitialized               |<span class="string">               Uninitialized</span></span><br><span class="line"><span class="string">       </span>|<span class="string">           C0       </span>|<span class="string">                     </span>|</span><br><span class="line">       |<span class="string">-------------------&gt;</span>|<span class="string">         C0          </span>|</span><br><span class="line">       |<span class="string">                    </span>|<span class="string">--------------------&gt;</span>|</span><br><span class="line">       |<span class="string">           C1       </span>|<span class="string">                     </span>|</span><br><span class="line">       |<span class="string">-------------------&gt;</span>|<span class="string">         S0          </span>|</span><br><span class="line">       |<span class="string">                    </span>|<span class="string">&lt;--------------------</span>|</span><br><span class="line">       |<span class="string">                    </span>|<span class="string">         S1          </span>|</span><br><span class="line"> Version sent               |<span class="string">&lt;--------------------</span>|</span><br><span class="line">       |<span class="string">           S0       </span>|<span class="string">                     </span>|</span><br><span class="line">       |<span class="string">&lt;-------------------</span>|<span class="string">                     </span>|</span><br><span class="line">       |<span class="string">           S1       </span>|<span class="string">                     </span>|</span><br><span class="line">       |<span class="string">&lt;-------------------</span>|<span class="string">                Version sent</span></span><br><span class="line"><span class="string">       </span>|<span class="string">                    </span>|<span class="string">         C1          </span>|</span><br><span class="line">       |<span class="string">                    </span>|<span class="string">--------------------&gt;</span>|</span><br><span class="line">       |<span class="string">           C2       </span>|<span class="string">                     </span>|</span><br><span class="line">       |<span class="string">-------------------&gt;</span>|<span class="string">         S2          </span>|</span><br><span class="line">       |<span class="string">                    </span>|<span class="string">&lt;--------------------</span>|</span><br><span class="line">    Ack sent                |<span class="string">                  Ack Sent</span></span><br><span class="line"><span class="string">       </span>|<span class="string">           S2       </span>|<span class="string">                     </span>|</span><br><span class="line">       |<span class="string">&lt;-------------------</span>|<span class="string">                     </span>|</span><br><span class="line">       |<span class="string">                    </span>|<span class="string">         C2          </span>|</span><br><span class="line">       |<span class="string">                    </span>|<span class="string">--------------------&gt;</span>|</span><br><span class="line"> Handshake Done             |<span class="string">              Handshake Done</span></span><br><span class="line"><span class="string">       </span>|<span class="string">                    </span>|<span class="string">                     </span>|</span><br><span class="line"></span><br><span class="line">          Pictorial Representation of Handshake</span><br></pre></td></tr></table></figure>
<p>注意就是整个rtmp握手包的格式，没有额外的头；</p>
<h4 id="5-chunking"><a href="#5-chunking" class="headerlink" title="5 chunking:"></a>5 chunking:</h4><ul>
<li><p>在握手之后，该连接多路复用一个或多个chunk streams.每个chunk stream从一个消息流携带一种类型的消息。每个chunk 被创建时有一个独立的ID,关联到，称为chunk streamID。这个chunks被网络进行传输。</p>
</li>
<li><p>当传输时，每个chunk 必须被完全发送，在发送下个chunk之前。 在接收方，多个chunks被组装为message，基于chunk ID。</p>
</li>
<li><p>chunking允许将高层协议的大message分解为小的messages， 例如，为了避免大的低优先级的message(如视频），阻塞了小的高优先级message(如音频或控制）</p>
</li>
<li><p>chunking也允许小message携带少的头发送信息，as the chunk header contains a compressed representation of information that would otherwise have to be included in the message itself. </p>
</li>
<li><p>chunk size是可配置的。他能被Set Chunk Size 控制message设置。 更大的chunk size 减少了cpu的使用，但也导致更大的写入，这可能会延迟较低带宽上的其他内容。<br>Smaller chunks are not good for high bit rate streaming. Chunk size is maintained independently for each direction.</p>
</li>
</ul>
<h5 id="chunk头格式"><a href="#chunk头格式" class="headerlink" title="chunk头格式"></a>chunk头格式</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> +<span class="comment">--------------+----------------+--------------------+--------------+</span></span><br><span class="line"> | Basic <span class="keyword">Header</span> | Message <span class="keyword">Header</span> | Extended <span class="type">Timestamp</span> |  Chunk Data  |</span><br><span class="line"> +<span class="comment">--------------+----------------+--------------------+--------------+</span></span><br><span class="line"> |                                                    |</span><br><span class="line"> |&lt;<span class="comment">------------------- Chunk Header -----------------&gt;|</span></span><br><span class="line"></span><br><span class="line">                                Chunk <span class="keyword">Format</span></span><br><span class="line">Basic <span class="keyword">Header</span> (<span class="number">1</span> <span class="keyword">to</span> <span class="number">3</span> bytes): This field encodes the chunk stream ID <span class="keyword">and</span> the chunk <span class="keyword">type</span>. Chunk <span class="keyword">type</span> determines the <span class="keyword">format</span> <span class="keyword">of</span> the encoded message <span class="keyword">header</span>. </span><br><span class="line">                             The length <span class="keyword">depends</span> entirely <span class="keyword">on</span> the chunk stream ID, which <span class="keyword">is</span> a variable-length field.</span><br><span class="line">Message <span class="keyword">Header</span> (<span class="number">0</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="keyword">or</span> <span class="number">11</span> bytes): This field encodes information about the message being sent (whether <span class="keyword">in</span> whole <span class="keyword">or</span> <span class="keyword">in</span> part). </span><br><span class="line">                        The length can be determined <span class="keyword">using</span> the chunk <span class="keyword">type</span> specified <span class="keyword">in</span> the chunk <span class="keyword">header</span>.</span><br><span class="line">Extended <span class="type">Timestamp</span> (<span class="number">0</span> <span class="keyword">or</span> <span class="number">4</span> bytes): This field <span class="keyword">is</span> present <span class="keyword">in</span> certain circumstances depending <span class="keyword">on</span> the encoded <span class="type">timestamp</span> <span class="keyword">or</span> <span class="type">timestamp</span> delta field <span class="keyword">in</span> the Chunk Message <span class="keyword">header</span>. </span><br><span class="line">                                  See next <span class="keyword">for</span> more information.</span><br><span class="line">Chunk Data (variable size): The payload <span class="keyword">of</span> this chunk, up <span class="keyword">to</span> the configured maximum chunk size.</span><br></pre></td></tr></table></figure>
<ul>
<li><p>几个问题：chunk 大小，和tcp数据流的关系，rtmp能不能基于udp? chunk大小和实际流有关吗？一个chunk可以包含多个message?<br> rtmp 基于流的，streamid,分message chunk, 有message header,chunk header</p>
</li>
<li><p>字段basic header：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1</span>) basic header 的大小取决于chunk stream id的大小；它编码了chunk stream ID和chunk type(由fmt域进行配置）。 </span><br><span class="line"><span class="attribute">chunk</span> type决定了编码messag header的格式。chunk basic 头可能是<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> 字节，取决于chunk stream ID大小。实现应该使用最小的能表示ID的。</span><br><span class="line"><span class="attribute">2</span>）协议支持到<span class="number">65597</span>个streamID ，为<span class="number">3</span>-<span class="number">65599</span>值。 IDs <span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>，为保留。</span><br><span class="line"><span class="attribute">3</span>）IDs为<span class="number">0</span>时即cs id这个字节为<span class="number">0</span> 意思是两个字节来形成一个ID,在范围 <span class="number">64</span>-<span class="number">319</span>，(即第二个字节+<span class="number">64</span> ：<span class="number">255</span>+<span class="number">64</span>-&gt;<span class="number">309</span>). 字节值为<span class="number">1</span>表示<span class="number">3</span>个字节来形成这个ID:<span class="number">64</span>-<span class="number">65599</span>((the third byte)*<span class="number">256</span> + the second byte + <span class="number">64</span>).</span><br><span class="line"><span class="attribute">4</span>）值为： <span class="number">3</span>-<span class="number">63</span> represent the complete stream ID。一个字节足已。Chunk Stream ID with value <span class="number">2</span> is reserved for low-level</span><br><span class="line"></span><br><span class="line"><span class="attribute">5</span>）The bits <span class="number">0</span>-<span class="number">5</span> (least significant) in the chunk basic header represent the chunk stream ID.</span><br></pre></td></tr></table></figure></li>
<li><p>Chunk stream IDs 2-63 can be encoded in the 1-byte version of this field.</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"> 0 1 2 3 4 5 6 7</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|fmt|   cs id   |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+</span></span><br><span class="line"></span><br><span class="line">Chunk basic header 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>Chunk stream IDs 64-319 can be encoded in the 2-byte form of the header. ID is computed as (the second byte + 64).</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="code"> 0                   1</span></span><br><span class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|fmt|     0     |   cs id - 64  |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"></span><br><span class="line">Chunk basic header 2</span><br></pre></td></tr></table></figure></li>
<li><p>Chunk stream IDs 64-65599 can be encoded in the 3-byte version of this field. ID is computed as ((the third byte)*256 + (the second byte) + 64).</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|fmt|     1     |          cs id - 64           |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"></span><br><span class="line">Chunk basic header 3</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="chunk-message-header"><a href="#chunk-message-header" class="headerlink" title="chunk message header:"></a>chunk message header:</h5><ul>
<li><p>fmt两位决定了四种类型00,01,,10,11:  （实现应使用每个块消息标头的最紧凑的表示。）</p>
</li>
<li><p>这里的fmt永远是两位，则决定了 chunk message header的类型；注意不是message的类型；<br>主要指示流中的首个message chunk和message和chunk的切分情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span> 0-3; </span><br><span class="line">/**</span><br><span class="line"> * parse the message header.</span><br><span class="line"> *   3bytes: timestamp delta,    <span class="built_in">fmt</span>=0,1,2 即0,1,2都有的字段</span><br><span class="line"> *   3bytes: payload length,     <span class="built_in">fmt</span>=0,1 即0,1都有的字段</span><br><span class="line"> *   1bytes: message <span class="built_in">type</span>,       <span class="built_in">fmt</span>=0,1</span><br><span class="line"> *   4bytes: stream <span class="built_in">id</span>,          <span class="built_in">fmt</span>=0</span><br><span class="line"> * <span class="built_in">where</span>:</span><br><span class="line"> *   <span class="built_in">fmt</span>=0, 0x0X</span><br><span class="line"> *   <span class="built_in">fmt</span>=1, 0x4X</span><br><span class="line"> *   <span class="built_in">fmt</span>=2, 0x8X</span><br><span class="line"> *   <span class="built_in">fmt</span>=3, 0xCX</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>

</li>
<li><p>type 0: 是chunk stream的开始使用以及每当流时间戳回滚？11Bytes。 This type MUST be used at the start of a chunk stream, and whenever the stream timestamp goes backward (e.g., because of a backward seek).</p>
</li>
</ul>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="code"> 0                   1                   2                   3</span></span><br><span class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|                   timestamp                   |message length |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|     message length (cont)     |message type id| msg stream id |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|           message stream id (cont)            |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"></span><br><span class="line"><span class="code">                  Chunk Message Header - Type 0</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>type 1: 不含streamid，意味着和前一个chunk的streamid相同，所以第一个不能是1，带message length和type意味着Streams with variable-sized messages (for example, many video formats) SHOULD use this format for the first chunk of each new message after the first.<br>7Bytes</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="code"> 0                   1                   2                   3</span></span><br><span class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|                timestamp delta                |message length |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|     message length (cont)     |message type id|</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"></span><br><span class="line"><span class="code">                   Chunk Message Header - Type 1</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>type 2：只含timestamp delta: 意味着streamid从前一个拿，message length也和前一个chunk相同，一般在固定长度的chunksize下用，非可变chunk. 和type<br>3bytes:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="code"> 0                   1                   2</span></span><br><span class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|                timestamp delta                |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"></span><br><span class="line"><span class="code">          Chunk Message Header - Type 2</span></span><br></pre></td></tr></table></figure></li>
<li><p>type 3:  不带头，即type3的chunk ，和前一个chunk属于同一个message;它的streamid和其他字段和前面的一样，意味着其实timestamp应该加上之前的chunk;</p>
</li>
</ul>
<h5 id="message组织方式："><a href="#message组织方式：" class="headerlink" title="message组织方式："></a>message组织方式：</h5><ul>
<li>当一个message被拆成chunk时，除了第一个message chunk外的所有message chunk都用这个类型；Refer to Example 2 (Section 5.3.2.2). A stream consisting of messages of exactly the same size, stream ID and spacing in time SHOULD use this type for all chunks after a chunk of Type 2. Refer to Example 1 (Section 5.3.2.1). If the delta between the first message and the second message is same as the timestamp of the first message, then a chunk of Type 3 could immediately follow the chunk of Type 0 as there is no need for a chunk of Type 2 to register the delta. If a Type 3 chunk follows a Type 0 chunk, then the timestamp delta for this Type 3 chunk is the same as the timestamp of the Type 0 chunk. 看github文档例子</li>
<li>请注意，从两个示例中可以看出，块类型 3 可以以两种不同的方式使用。第一个是指定消息的延续。第二个是指定一个新消息的开始，它的头可以从现有的状态数据中导出。</li>
<li>总结： 流开始为type 0 ,中间依情况为1,2位message的首chunk,当message 被分割为多个chunk时，出现type3,此时当第一个chunk为type0时，message的长度在第一个chunk指示；可以算出来总长；或者当type0,type2,type3的情况时，type0chunk 的message length&#x3D;&#x3D;type2&#x3D;&#x3D;type3;</li>
<li>其他情况根据具体实现决定；比如type1会带message size此时可能和0-3一样；</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">messageheader的 实际取的是chunk message header;</span><br><span class="line">streamid: 流id，流维度的，一般在一个流下不变；<span class="number">4</span>B</span><br><span class="line">message length: message 的长度；实际情况？ tag? 在huya的rtmp-&gt;flvs，是取message header里面的message length认为是一个tag的长度，<span class="number">3</span>个字节</span><br><span class="line">message <span class="keyword">type</span> id : message类型；<span class="number">1</span>B</span><br><span class="line">timestamp stamp: 应该是dts? <span class="number">3</span>B</span><br><span class="line">          关于extend TImeStamp是可选的(至少我在实际抓包没看到这个), <span class="number">5.3</span>.<span class="number">1.3</span>. Extended <span class="constructor">Timestamp(<span class="params">https</span>:<span class="operator">/</span><span class="operator">/</span><span class="params">github</span>.<span class="params">com</span><span class="operator">/</span><span class="params">melpon</span><span class="operator">/</span><span class="params">rfc</span><span class="operator">/</span><span class="params">blob</span><span class="operator">/</span><span class="params">master</span><span class="operator">/</span><span class="params">rtmp</span>.<span class="params">md</span>)</span></span><br><span class="line">          总结：</span><br><span class="line">          上层传入message( 可能是一个message为一个flv tag），一个message如果过大可以被拆解为多个message。接着每个message被拆为<span class="number">1</span>个或多个chunk, 每个chunk都有一个chunk basic header,见上，以及根据fmt类型来决定的message header。</span><br><span class="line">虽然协议上貌似没看到chunk跨message的说明，但是一个message最好由数个chunk组成，则最后一个chunk结束时，也是该message的结束。</span><br></pre></td></tr></table></figure>
<h5 id="Example-1"><a href="#Example-1" class="headerlink" title="Example 1"></a>Example 1</h5><p>This example shows a simple stream of audio messages. This example demonstrates the redundancy of information.</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">+---------+-----------------+-----------------+-----------------+</span><br><span class="line">|<span class="string">         </span>|<span class="string">Message Stream ID</span>|<span class="string"> Message TYpe ID </span>|<span class="string"> Time  </span>|<span class="string"> Length  </span>|</span><br><span class="line">+---------+-----------------+-----------------+-------+---------+</span><br><span class="line">|<span class="string"> Msg # 1 </span>|<span class="string">     12345       </span>|<span class="string">        8        </span>|<span class="string"> 1000  </span>|<span class="string">   32    </span>|</span><br><span class="line">+---------+-----------------+-----------------+-------+---------+</span><br><span class="line">|<span class="string"> Msg # 2 </span>|<span class="string">     12345       </span>|<span class="string">        8        </span>|<span class="string"> 1020  </span>|<span class="string">   32    </span>|</span><br><span class="line">+---------+-----------------+-----------------+-------+---------+</span><br><span class="line">|<span class="string"> Msg # 3 </span>|<span class="string">     12345       </span>|<span class="string">        8        </span>|<span class="string"> 1040  </span>|<span class="string">   32    </span>|</span><br><span class="line">+---------+-----------------+-----------------+-------+---------+</span><br><span class="line">|<span class="string"> Msg # 4 </span>|<span class="string">     12345       </span>|<span class="string">        8        </span>|<span class="string"> 1060  </span>|<span class="string">   32    </span>|</span><br><span class="line">+---------+-----------------+-----------------+-------+---------+</span><br><span class="line"></span><br><span class="line">       Sample audio messages to be made into chunks</span><br><span class="line"></span><br><span class="line">+--------+---------+-----+------------+-----------+------------+</span><br><span class="line">|<span class="string">        </span>|<span class="string">  Chunk  </span>|<span class="string">Chunk</span>|<span class="string">Header Data </span>|<span class="string">No.of Bytes</span>|<span class="string">Total No.of </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">Stream ID</span>|<span class="string">Type </span>|<span class="string">            </span>|<span class="string">  After    </span>|<span class="string">Bytes in the</span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">         </span>|<span class="string">     </span>|<span class="string">            </span>|<span class="string">Header     </span>|<span class="string">Chunk       </span>|</span><br><span class="line">+--------+---------+-----+------------+-----------+------------+</span><br><span class="line">|<span class="string">Chunk#1 </span>|<span class="string">    3    </span>|<span class="string">  0  </span>|<span class="string"> delta: 1000</span>|<span class="string">    32     </span>|<span class="string">     44     </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">         </span>|<span class="string">     </span>|<span class="string"> length: 32,</span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">         </span>|<span class="string">     </span>|<span class="string"> type: 8,   </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">         </span>|<span class="string">     </span>|<span class="string"> stream ID: </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">         </span>|<span class="string">     </span>|<span class="string"> 12345 (11  </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">         </span>|<span class="string">     </span>|<span class="string"> bytes)     </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">+--------+---------+-----+------------+-----------+------------+</span><br><span class="line">|<span class="string">Chunk#2 </span>|<span class="string">    3    </span>|<span class="string">  2  </span>|<span class="string"> 20 (3      </span>|<span class="string">    32     </span>|<span class="string">     36     </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">         </span>|<span class="string">     </span>|<span class="string"> bytes)     </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">+--------+---------+-----+----+-------+-----------+------------+</span><br><span class="line">|<span class="string">Chunk#3 </span>|<span class="string">    3    </span>|<span class="string">  3  </span>|<span class="string"> none (0    </span>|<span class="string">    32     </span>|<span class="string">     33     </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">         </span>|<span class="string">     </span>|<span class="string"> bytes)     </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">+--------+---------+-----+------------+-----------+------------+</span><br><span class="line">|<span class="string">Chunk#4 </span>|<span class="string">    3    </span>|<span class="string">  3  </span>|<span class="string"> none (0    </span>|<span class="string">    32     </span>|<span class="string">     33     </span>|</span><br><span class="line">|<span class="string">        </span>|<span class="string">         </span>|<span class="string">     </span>|<span class="string"> bytes)     </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">+--------+---------+-----+------------+-----------+------------+</span><br><span class="line"></span><br><span class="line">     Format of each of the chunks of audio messages</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>PS:<br>有点奇怪这里，chunk3 和chunk4是message3和message4的，他们时间戳不同，这里按理说应该是type2.但是是type3，虽然解释说有优化，但是还是奇怪。<br>The next table shows chunks produced in this stream. From message 3 onward, data transmission is optimized. There is only 1 byte of overhead per message beyond this point.</p>
<h5 id="example2-这里假设chunk的最大是128，这里的message超出了；会被分为多个chunk"><a href="#example2-这里假设chunk的最大是128，这里的message超出了；会被分为多个chunk" class="headerlink" title="example2: 这里假设chunk的最大是128，这里的message超出了；会被分为多个chunk."></a>example2: 这里假设chunk的最大是128，这里的message超出了；会被分为多个chunk.</h5><p>This example illustrates a message that is too long to fit in a 128 byte chunk and is broken into several chunks.</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">+-----------+-------------------+-----------------+-----------------+</span><br><span class="line">|<span class="string">           </span>|<span class="string"> Message Stream ID </span>|<span class="string"> Message TYpe ID </span>|<span class="string">  Time  </span>|<span class="string"> Length </span>|</span><br><span class="line">+-----------+-------------------+-----------------+-----------------+</span><br><span class="line">|<span class="string">  Msg # 1  </span>|<span class="string">      12346        </span>|<span class="string">    9 (video)    </span>|<span class="string">  1000  </span>|<span class="string">  307   </span>|</span><br><span class="line">+-----------+-------------------+-----------------+-----------------+</span><br><span class="line"></span><br><span class="line">+-------+------+-----+-------------+-----------+------------+</span><br><span class="line">|<span class="string">       </span>|<span class="string">Chunk </span>|<span class="string">Chunk</span>|<span class="string">Header       </span>|<span class="string">No. of     </span>|<span class="string">Total No. of</span>|</span><br><span class="line">|<span class="string">       </span>|<span class="string">Stream</span>|<span class="string"> Type</span>|<span class="string">Data         </span>|<span class="string">Bytes after</span>|<span class="string"> bytes in   </span>|</span><br><span class="line">|<span class="string">       </span>|<span class="string"> ID   </span>|<span class="string">     </span>|<span class="string">             </span>|<span class="string"> Header    </span>|<span class="string"> the chunk  </span>|</span><br><span class="line">+-------+------+-----+-------------+-----------+------------+</span><br><span class="line">|<span class="string">Chunk#1</span>|<span class="string">   4  </span>|<span class="string">  0  </span>|<span class="string"> delta: 1000 </span>|<span class="string">    128    </span>|<span class="string">     140    </span>|</span><br><span class="line">|<span class="string">       </span>|<span class="string">      </span>|<span class="string">     </span>|<span class="string"> length: 307 </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">|<span class="string">       </span>|<span class="string">      </span>|<span class="string">     </span>|<span class="string"> type: 9,    </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">|<span class="string">       </span>|<span class="string">      </span>|<span class="string">     </span>|<span class="string"> stream ID:  </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">|<span class="string">       </span>|<span class="string">      </span>|<span class="string">     </span>|<span class="string"> 12346 (11   </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">|<span class="string">       </span>|<span class="string">      </span>|<span class="string">     </span>|<span class="string"> bytes)      </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">+-------+------+-----+-------------+-----------+------------+</span><br><span class="line">|<span class="string">Chunk#2</span>|<span class="string">   4  </span>|<span class="string">  3  </span>|<span class="string"> none (0     </span>|<span class="string">    128    </span>|<span class="string">     129    </span>|</span><br><span class="line">|<span class="string">       </span>|<span class="string">      </span>|<span class="string">     </span>|<span class="string"> bytes)      </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">+-------+------+-----+-------------+-----------+------------+</span><br><span class="line">|<span class="string">Chunk#3</span>|<span class="string">   4  </span>|<span class="string">  3  </span>|<span class="string"> none (0     </span>|<span class="string">     51    </span>|<span class="string">      52    </span>|</span><br><span class="line">|<span class="string">       </span>|<span class="string">      </span>|<span class="string">     </span>|<span class="string"> bytes)      </span>|<span class="string">           </span>|<span class="string">            </span>|</span><br><span class="line">+-------+------+-----+-------------+-----------+------------+</span><br><span class="line"></span><br><span class="line">                 Format of each of the chunks</span><br></pre></td></tr></table></figure>
<p>一般实现会把chunk size设置比较大，这样message不会出现上述被分割为多个chunk的情况，则chunk basic header基本只会出现一次，对一个message来说，而message header内容也是一样的，也简化了处理。</p>
<h4 id="message分类等："><a href="#message分类等：" class="headerlink" title="message分类等："></a>message分类等：</h4><h5 id="message-type-id"><a href="#message-type-id" class="headerlink" title="message type id:"></a>message type id:</h5><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Protocol Control Messages：</span><br><span class="line"> <span class="keyword">type</span> <span class="type">1：set </span>chunk size</span><br><span class="line"> <span class="keyword">type</span> <span class="type">2 </span>: <span class="keyword">Abort</span> Message</span><br><span class="line"> <span class="keyword">type</span> <span class="type">3: </span>Acknowledgement</span><br><span class="line"> <span class="keyword">type</span> <span class="type">5: </span>Window Acknowledgement Size </span><br><span class="line"> <span class="keyword">type</span> <span class="type">6: </span>Set Peer Bandwidth </span><br><span class="line"></span><br><span class="line">User Control Message:</span><br><span class="line"><span class="keyword">type</span> <span class="type">4: </span>User Control Messages</span><br><span class="line"> +<span class="comment">------------------------------+-------------------------</span></span><br><span class="line"> |     Event <span class="keyword">Type</span> <span class="type">(16 </span>bits)     | Event Data</span><br><span class="line"> +<span class="comment">------------------------------+-------------------------</span></span><br><span class="line"></span><br><span class="line">    Payload <span class="keyword">for</span> the ‘User Control’ protocol message</span><br><span class="line">    </span><br><span class="line">RTMP Command Messages:</span><br><span class="line"><span class="keyword">type</span> <span class="type">17: </span>command Message <span class="keyword">with</span> AMF3 :are sent to perform <span class="keyword">some</span> operations like connect, createStream, publish, play, pause on the peer. </span><br><span class="line"><span class="keyword">type</span> <span class="type">20: </span>command Message <span class="keyword">with</span> AMF0</span><br><span class="line"><span class="keyword">type</span> <span class="type">18: </span>Data Message <span class="keyword">with</span> AMF0:  send Metadata <span class="keyword">or</span> any user data to the peer. </span><br><span class="line"><span class="keyword">type</span> <span class="type">15: </span>Data Message <span class="keyword">with</span> AMF3</span><br><span class="line"><span class="keyword">type</span> <span class="type">19: </span>Shared Object Message  <span class="keyword">with</span> AMF0 :A shared object <span class="keyword">is</span> a Flash object (a collection <span class="keyword">of</span> name value pairs) that are <span class="keyword">in</span> synchronization across multiple clients, instances, <span class="keyword">and</span> so on</span><br><span class="line"><span class="keyword">type</span> <span class="type">16: </span>Shared Object Message  <span class="keyword">with</span> AMF3</span><br><span class="line"><span class="keyword">type</span> <span class="type">8: </span>Audio Message</span><br><span class="line"><span class="keyword">type</span> <span class="type">9: </span>Video Message</span><br><span class="line"><span class="keyword">type</span> <span class="type">22: </span>Aggregate Message: An aggregate message <span class="keyword">is</span> a single message that contains a series <span class="keyword">of</span> RTMP sub-messages using the format described <span class="keyword">in</span> Section <span class="number">6.1</span>. Message</span><br></pre></td></tr></table></figure>

<h5 id="关于Protocol-Control-Messages："><a href="#关于Protocol-Control-Messages：" class="headerlink" title="关于Protocol Control Messages："></a>关于Protocol Control Messages：</h5><h6 id="set-chunk-size"><a href="#set-chunk-size" class="headerlink" title="set chunk size:"></a>set chunk size:</h6><p>is used to notify the peer of a new maximum chunk size. 默认值是128bytes, 但client和server可以改变这个值。然后updates its peer using this message;<br>例如一个client想发送131bytes 的音频数据，然后此时的chunk size是128，这种情况下，client可以发送这个消息来通知server,现在的chunk size是131，然后client就可以在一个chunk 中发送131大小的数据了；The maximum chunk size is maintained independently for each direction.</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0                   1                   2                   3</span><br><span class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|0|                     chunk size (31 bits)                    |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"></span><br><span class="line"><span class="code">       Payload for the ‘Set Chunk Size’ protocol message</span></span><br></pre></td></tr></table></figure>
<ul>
<li>0: This bit MUST be zero.</li>
<li>chunk size (31 bits):  填新的max chunk size,字节为单位，有效长是1-2147483647 (0x7FFFFFFF) ，然而，所有大于16777215 (0xFFFFFF) 是相等的，因为<br>没有chunk 大于一个message,而message的最大值是16777215 bytes. 字段大小长度限制；</li>
</ul>
<h6 id="Abort-Message-detail"><a href="#Abort-Message-detail" class="headerlink" title="Abort Message detail:"></a>Abort Message detail:</h6><p> is used to notify the peer if it is waiting for chunks to complete a message, then to discard the partially received message over a chunk stream<br>用来通知对端，若正在等待chunks 来完成一个message，则丢弃已经收到message的部分chunk.<br>The peer receives the chunk stream ID as this protocol message’s payload. An application may send this message when closing in order to indicate that further processing of the messages is not required.<br>对端收到这个后。一个app可能会发送这个消息，当有序关闭时，暗示之后对这个messages的processing不被required;  </p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="code"> 0                   1                   2                   3</span></span><br><span class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|                       chunk stream id (32 bits)               |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"></span><br><span class="line"><span class="code">       Payload for the ‘Abort Message’ protocol message</span></span><br></pre></td></tr></table></figure>
<ul>
<li>chunk stream ID (32 bits): This field holds the chunk stream ID, whose current message is to be discarded.</li>
</ul>
<h6 id="Acknowledgement-即ack-因为rtmp目前主流实现是基于tcp的，所以这个基本没怎么用到。"><a href="#Acknowledgement-即ack-因为rtmp目前主流实现是基于tcp的，所以这个基本没怎么用到。" class="headerlink" title="Acknowledgement:即ack  因为rtmp目前主流实现是基于tcp的，所以这个基本没怎么用到。"></a>Acknowledgement:即ack  因为rtmp目前主流实现是基于tcp的，所以这个基本没怎么用到。</h6><p>客户端或服务器必须在收到等于窗口大小的字节后向对等方发送确认。窗口大小是发送方在未收到接收方确认的情况下发送的最大字节数。此消息指定序列号，即到目前为止接收到的字节数。</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0                  <span class="number"> 1 </span>                 <span class="number"> 2 </span>                  3</span><br><span class="line"> <span class="number"> 0 </span>1<span class="number"> 2 </span>3<span class="number"> 4 </span>5<span class="number"> 6 </span>7<span class="number"> 8 </span>9<span class="number"> 0 </span>1<span class="number"> 2 </span>3<span class="number"> 4 </span>5<span class="number"> 6 </span>7<span class="number"> 8 </span>9<span class="number"> 0 </span>1<span class="number"> 2 </span>3<span class="number"> 4 </span>5<span class="number"> 6 </span>7<span class="number"> 8 </span>9<span class="number"> 0 </span>1</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                        sequence number (4 bytes)                     |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"></span><br><span class="line">        Payload for the ‘Acknowledgement’ protocol message</span><br></pre></td></tr></table></figure>
<ul>
<li>sequence number (32 bits): This field holds the number of bytes received so far.</li>
</ul>
<h6 id="Window-Ack-size-即多久-多少数据传输了要发ack"><a href="#Window-Ack-size-即多久-多少数据传输了要发ack" class="headerlink" title="Window Ack size: 即多久(多少数据传输了要发ack)"></a>Window Ack size: 即多久(多少数据传输了要发ack)</h6><p>和上面的关联：<br>客户端或服务器发送此消息以通知对等方要在发送确认之间使用的窗口大小。在发送方发送窗口大小字节后，发送方希望得到其对等方的确认。接收对等方必须在收到自上次发送确认后指定的字节数后发送确认（第 5.4.3 节），或者从会话开始（如果尚未发送确认）。、</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="code"> 0                   1                   2                   3</span></span><br><span class="line"><span class="section"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="section">|                   Acknowledgement Window size (4 bytes)       |</span></span><br><span class="line"><span class="section">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"></span><br><span class="line"><span class="code">  Payload for the ‘Window Acknowledgement Size’ protocol message</span></span><br></pre></td></tr></table></figure>
<h6 id="set-peer-bandwidth"><a href="#set-peer-bandwidth" class="headerlink" title="set peer bandwidth:"></a>set peer bandwidth:</h6><ul>
<li><p>The client or the server sends this message to limit the output bandwidth of its peer. The peer receiving this message limits its output bandwidth by limiting the amount of sent but unacknowledged data to the window size indicated in this message. The peer receiving this message SHOULD respond with a Window Acknowledgement Size message if the window size is different from the last one sent to the sender of this message.</p>
</li>
<li><p>client或server发送这个message去限制对端的output bandwidth. 对端收到这个message后，限制它的output bandwidth 通过限制已发送但未确认的数据到这个消息指示的windows size. (PS:对端输出时，需要等这个message指示的window size范围的数据被ack后才能继续发，意味着如果小了，则输出会变小).</p>
</li>
<li><p>接收方收到这个message 应该response with a window ack size message ，如果它的window size 和这个message中的不同；</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number"> 0 </span>                 <span class="number"> 1 </span>                 <span class="number"> 2 </span>                  3</span><br><span class="line"> <span class="number"> 0 </span>1<span class="number"> 2 </span>3<span class="number"> 4 </span>5<span class="number"> 6 </span>7<span class="number"> 8 </span>9<span class="number"> 0 </span>1<span class="number"> 2 </span>3<span class="number"> 4 </span>5<span class="number"> 6 </span>7<span class="number"> 8 </span>9<span class="number"> 0 </span>1<span class="number"> 2 </span>3<span class="number"> 4 </span>5<span class="number"> 6 </span>7<span class="number"> 8 </span>9<span class="number"> 0 </span>1</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                   Acknowledgement Window size                                       |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |  Limit Type         |</span><br><span class="line"> +-+-+-+-+-+-+-+-+</span><br><span class="line">Payload for the ‘Set Peer Bandwidth’ protocol message </span><br></pre></td></tr></table></figure>
</li>
<li><p>The Limit Type is one of the following values:</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">0 </span>- Hard: The peer SHOULD limit its output bandwidth <span class="keyword">to</span> the indicated <span class="keyword">window</span> size.对方应该将其输出带宽限制在指示的窗口大小。</span><br><span class="line"><span class="symbol">1 </span>- Soft: The peer SHOULD limit its output bandwidth <span class="keyword">to</span> the the <span class="keyword">window</span> indicated in this message <span class="keyword">or</span> the limit already in effect, whichever is smaller.对方应该将其输出带宽限制在此消息中指示的窗口或已经生效的限制，以较小者为准。</span><br><span class="line"><span class="symbol">2 </span>- Dynamic: <span class="keyword">If</span> the previous Limit Type was Hard, treat this message as though it was marked Hard, otherwise ignore this message.如果先前的限制类型为Hard，请处理此消息，将其视为hard. 否则忽略此消息。</span><br></pre></td></tr></table></figure>
<h6 id="shared-obj-message-detail"><a href="#shared-obj-message-detail" class="headerlink" title="shared obj message detail:"></a>shared obj message detail:</h6><p>共享对象是在多个客户端、实例等之间同步的 Flash 对象（名称值对的集合）。 AMF0 的消息类型 19 和 AMF3 的消息类型 16 保留用于共享对象事件。每条消息可以包含多个事件。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"> +------+------+-------+-----+-----+------+-----+ +-----+------+-----+</span><br><span class="line"> |<span class="string">Header</span>|<span class="string">Shared</span>|<span class="string">Current</span>|<span class="string">Flags</span>|<span class="string">Event</span>|<span class="string">Event </span>|<span class="string">Event</span>|<span class="string">.</span>|<span class="string">Event</span>|<span class="string">Event </span>|<span class="string">Event</span>|</span><br><span class="line"> |<span class="string">      </span>|<span class="string">Object</span>|<span class="string">Version</span>|<span class="string">     </span>|<span class="string">Type </span>|<span class="string">data  </span>|<span class="string">data </span>|<span class="string">.</span>|<span class="string">Type </span>|<span class="string">data  </span>|<span class="string">data </span>|</span><br><span class="line"> |<span class="string">      </span>|<span class="string">Name  </span>|<span class="string">       </span>|<span class="string">     </span>|<span class="string">     </span>|<span class="string">length</span>|<span class="string">     </span>|<span class="string">.</span>|<span class="string">     </span>|<span class="string">length</span>|<span class="string">     </span>|</span><br><span class="line"> +------+------+-------+-----+-----+------+-----+ +-----+------+-----+</span><br><span class="line">        |<span class="string">                                                            </span>|</span><br><span class="line">        |<span class="string">&lt;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - &gt;</span>|</span><br><span class="line">        |<span class="string">              AMF Shared Object Message body                </span>|</span><br><span class="line"></span><br><span class="line">            The shared object message format</span><br><span class="line">The following event types are supported:</span><br><span class="line"></span><br><span class="line"> +---------------+--------------------------------------------------+</span><br><span class="line"> |<span class="string"> Event         </span>|<span class="string"> Description                                      </span>|</span><br><span class="line"> +---------------+--------------------------------------------------+</span><br><span class="line"> |<span class="string"> Use(=1)       </span>|<span class="string"> The client sends this event to inform the server </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> about the creation of a named shared object.     </span>|</span><br><span class="line"> +---------------+--------------------------------------------------+</span><br><span class="line"> |<span class="string"> Release(=2)   </span>|<span class="string"> The client sends this event to the server when   </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> the shared object is deleted on the client side. </span>|</span><br><span class="line"> +---------------+--------------------------------------------------+</span><br><span class="line"> |<span class="string"> Request Change</span>|<span class="string"> The client sends this event to request that the  </span>|</span><br><span class="line"> |<span class="string"> (=3)          </span>|<span class="string"> change the value associated with a named         </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> parameter of the shared object.                  </span>|</span><br><span class="line"> +---------------+--------------------------------------------------+</span><br><span class="line"> |<span class="string"> Change (=4)   </span>|<span class="string"> The server sends this event to notify all        </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> clients, except the client originating the       </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> request, of a change in the value of a named     </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> parameter.                                       </span>|</span><br><span class="line"> +---------------+--------------------------------------------------+</span><br><span class="line"> |<span class="string"> Success (=5)  </span>|<span class="string"> The server sends this event to the requesting    </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> client in response to RequestChange event if the </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> request is accepted.                             </span>|</span><br><span class="line"> +---------------+--------------------------------------------------+</span><br><span class="line"> |<span class="string"> SendMessage   </span>|<span class="string"> The client sends this event to the server to     </span>|</span><br><span class="line"> |<span class="string"> (=6)          </span>|<span class="string"> broadcast a message. On receiving this event,    </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> the server broadcasts a message to all the       </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> clients, including the sender.                   </span>|</span><br><span class="line"> +---------------+--------------------------------------------------+</span><br><span class="line"> |<span class="string"> Status (=7)   </span>|<span class="string"> The server sends this event to notify clients    </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> about error conditions.                          </span>|</span><br><span class="line"> +---------------+--------------------------------------------------+</span><br><span class="line"> |<span class="string"> Clear (=8)    </span>|<span class="string"> The server sends this event to the client to     </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> clear a shared object. The server also sends     </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> this event in response to Use event that the     </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> client sends on connect.                         </span>|</span><br><span class="line"> +---------------+--------------------------------------------------+</span><br><span class="line"> |<span class="string"> Remove (=9)   </span>|<span class="string"> The server sends this event to have the client   </span>|</span><br><span class="line"> |<span class="string">               </span>|<span class="string"> delete a slot.                                   </span>|</span><br><span class="line"> +---------------+--------------------------------------------------+</span><br><span class="line"> |<span class="string"> Request Remove</span>|<span class="string"> The client sends this event to have the client   </span>|</span><br><span class="line"> |<span class="string"> (=10)         </span>|<span class="string"> delete a slot.                                   </span>|</span><br><span class="line"> +---------------+--------------------------------------------------+</span><br><span class="line"> |<span class="string"> Use Success   </span>|<span class="string"> The server sends this event to the client on a   </span>|</span><br><span class="line"> |<span class="string"> (=11)         </span>|<span class="string"> successful connection.                           </span>|</span><br><span class="line"> +---------------+--------------------------------------------------+</span><br></pre></td></tr></table></figure></li>
</ul>
<h6 id="Aggregate-Message-detail"><a href="#Aggregate-Message-detail" class="headerlink" title="Aggregate Message detail:"></a>Aggregate Message detail:</h6><p>An aggregate message is a single message that contains a series of RTMP sub-messages using the format described  follow:</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> +---------+-------------------------+</span><br><span class="line"> |<span class="string"> Header  </span>|<span class="string"> Aggregate Message body  </span>|</span><br><span class="line"> +---------+-------------------------+</span><br><span class="line"></span><br><span class="line">   The Aggregate Message format</span><br><span class="line"></span><br><span class="line"> +--------+-------+---------+--------+-------+---------+ - - - -</span><br><span class="line"> |<span class="string">Header 0</span>|<span class="string">Message</span>|<span class="string">Back     </span>|<span class="string">Header 1</span>|<span class="string">Message</span>|<span class="string">Back     </span>|</span><br><span class="line"> |<span class="string">        </span>|<span class="string">Data 0 </span>|<span class="string">Pointer 0</span>|<span class="string">        </span>|<span class="string">Data 1 </span>|<span class="string">Pointer 1</span>|</span><br><span class="line"> +--------+-------+---------+--------+-------+---------+ - - - -</span><br><span class="line"></span><br><span class="line">            The Aggregate Message body format</span><br><span class="line"></span><br><span class="line">在aggregate message中的 message stream id覆盖了 其sub-messages的message stream id;</span><br></pre></td></tr></table></figure>
<p>聚合消息和第一个子消息的时间戳之间的差异是用于将子消息的时间戳重新规范化为流时间尺度的偏移量。偏移量被添加到每个子消息的时间戳中，以达到规范化的流时间。第一个子消息的时间戳应该与聚合消息的时间戳相同，因此偏移量应该为零。</p>
<p>The back pointer contains the size of the previous message including its header. It is included to match the format of FLV file and is used for backward seek.<br>使用这个message 有以下几个性能的好处： </p>
<ul>
<li>1 chunk stream 能在一个chunk中最多发一个message,因此，增加了chunk size并使用aggregate message能减少发送chunk的次数；</li>
<li>2 sub-message被存储在连续的内存中，对系统调用发送到网络上更有效率；</li>
</ul>
<h5 id="关于type4-User-Control-Messages"><a href="#关于type4-User-Control-Messages" class="headerlink" title="关于type4 User Control Messages"></a>关于type4 User Control Messages</h5><ul>
<li>User Control Message detail:The client or the server sends this message to notify the peer about the user control events. </li>
<li>这种消息，它的Chunk basic header和message header 中： message stream id为0， chun steam id为2，timestamp被忽略</li>
<li>This message carries Event type and Event data.</li>
<li>event data字段的大小是可变的。然而，在消息必须通过 RTMP 块流层的情况下，最大块大小（第 5.4.1 节）应该足够大以允许这些消息适合单个块。<br>以下为一些协议上预定义的event type 和描述：<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">+---------------+--------------------------------------------------+</span><br><span class="line">|<span class="string"> Event         </span>|<span class="string"> Description                                      </span>|</span><br><span class="line">+---------------+--------------------------------------------------+</span><br><span class="line">|<span class="string"> Stream Begin  </span>|<span class="string"> The server sends this event to notify the client </span>|</span><br><span class="line">|<span class="string"> (=0)          </span>|<span class="string"> that a stream has become functional and can be   </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> used for communication. By default, this event   </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> is sent on ID 0 after the application connect    </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> command is successfully received from the        </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> client. The event data is 4-byte and represents  </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> the stream ID of the stream that became          </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> functional.                                      </span>|</span><br><span class="line">+---------------+--------------------------------------------------+</span><br><span class="line">|<span class="string"> Stream EOF    </span>|<span class="string"> The server sends this event to notify the client </span>|</span><br><span class="line">|<span class="string"> (=1)          </span>|<span class="string"> that the playback of data is over as requested   </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> on this stream. No more data is sent without     </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> issuing additional commands. The client discards </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> the messages received for the stream. The        </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> 4 bytes of event data represent the ID of the    </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> stream on which playback has ended.              </span>|</span><br><span class="line">+---------------+--------------------------------------------------+</span><br><span class="line">|<span class="string"> StreamDry     </span>|<span class="string"> The server sends this event to notify the client </span>|</span><br><span class="line">|<span class="string"> (=2)          </span>|<span class="string"> that there is no more data on the stream. If the </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> server does not detect any message for a time    </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> period, it can notify the subscribed clients     </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> that the stream is dry. The 4 bytes of event     </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> data represent the stream ID of the dry stream.  </span>|</span><br><span class="line">+---------------+--------------------------------------------------+</span><br><span class="line">|<span class="string"> SetBuffer     </span>|<span class="string"> The client sends this event to inform the server </span>|</span><br><span class="line">|<span class="string"> Length (=3)   </span>|<span class="string"> of the buffer size (in milliseconds) that is     </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> used to buffer any data coming over a stream.    </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> This event is sent before the server starts      </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> processing the stream. The first 4 bytes of the  </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> event data represent the stream ID and the next  </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> 4 bytes represent the buffer length, in          </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> milliseconds.                                    </span>|</span><br><span class="line">+---------------+--------------------------------------------------+</span><br><span class="line">|<span class="string"> StreamIs      </span>|<span class="string"> The server sends this event to notify the client </span>|</span><br><span class="line">|<span class="string"> Recorded (=4) </span>|<span class="string"> that the stream is a recorded stream. The        </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> 4 bytes event data represent the stream ID of    </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> the recorded stream.                             </span>|</span><br><span class="line">+---------------+--------------------------------------------------+</span><br><span class="line">|<span class="string"> PingRequest   </span>|<span class="string"> The server sends this event to test whether the  </span>|</span><br><span class="line">|<span class="string"> (=6)          </span>|<span class="string"> client is reachable. Event data is a 4-byte      </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> timestamp, representing the local server time    </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> when the server dispatched the command. The      </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> client responds with PingResponse on receiving   </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> MsgPingRequest.                                  </span>|</span><br><span class="line">+---------------+--------------------------------------------------+</span><br><span class="line">|<span class="string"> PingResponse  </span>|<span class="string"> The client sends this event to the server in     </span>|</span><br><span class="line">|<span class="string"> (=7)          </span>|<span class="string"> response to the ping request. The event data is  </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> a 4-byte timestamp, which was received with the  </span>|</span><br><span class="line">|<span class="string">               </span>|<span class="string"> PingRequest request.                             </span>|</span><br><span class="line">+---------------+--------------------------------------------------+</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="关于-RTMP-Command-Messages-command-message-detail"><a href="#关于-RTMP-Command-Messages-command-message-detail" class="headerlink" title="关于 RTMP Command Messages: command message detail:"></a>关于 RTMP Command Messages: command message detail:</h5><h6 id="类型：type-of-command"><a href="#类型：type-of-command" class="headerlink" title="类型：type of command:"></a>类型：type of command:</h6><p> 类型1 NetConnection Commands</p>
<ol>
<li><p>connect<br>The client sends the connect command to the server to request connection to a server application instance.<br>The command structure from the client to the server is as follows:</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">+--------------+                              +-------------+</span><br><span class="line">|<span class="string">    Client    </span>|<span class="string">               </span>|<span class="string">              </span>|<span class="string">    Server   </span>|</span><br><span class="line">+------+-------+               |<span class="string">              +------+------+</span></span><br><span class="line"><span class="string">       </span>|<span class="string">               Handshaking done              </span>|</span><br><span class="line">       |<span class="string">                       </span>|<span class="string">                     </span>|</span><br><span class="line">       |<span class="string">                       </span>|<span class="string">                     </span>|</span><br><span class="line">       |<span class="string">                       </span>|<span class="string">                     </span>|</span><br><span class="line">       |<span class="string">                       </span>|<span class="string">                     </span>|</span><br><span class="line">       |<span class="string">----------- Command Message(connect) -------&gt;</span>|</span><br><span class="line">       |<span class="string">                                             </span>|</span><br><span class="line">       |<span class="string">&lt;------- Window Acknowledgement Size --------</span>|</span><br><span class="line">       |<span class="string">                                             </span>|</span><br><span class="line">       |<span class="string">&lt;----------- Set Peer Bandwidth -------------</span>|</span><br><span class="line">       |<span class="string">                                             </span>|</span><br><span class="line">       |<span class="string">-------- Window Acknowledgement Size -------&gt;</span>|</span><br><span class="line">       |<span class="string">                                             </span>|</span><br><span class="line">       |<span class="string">&lt;------ User Control Message(StreamBegin) ---</span>|</span><br><span class="line">       |<span class="string">                                             </span>|</span><br><span class="line">       |<span class="string">&lt;------------ Command Message ---------------</span>|</span><br><span class="line">       |<span class="string">         (_result- connect response)         </span>|</span><br><span class="line">       |<span class="string">                                             </span>|</span><br><span class="line"></span><br><span class="line">            Message flow in the connect command</span><br></pre></td></tr></table></figure></li>
<li><p>call:     The call method of the NetConnection object runs remote procedure calls (RPC) at the receiving end. The called RPC name is passed as a parameter to the call command.<br>req: format…<br>rsp: format…</p>
</li>
<li><p>close</p>
</li>
<li><p>createStream</p>
</li>
</ol>
<p>类型2 NetStream Commands<br>NetStream定义了流媒体音频，视频和数据消息的通道可以通过将客户端连接到服务器的NetConnection流过。 NetConnection对象可以支持多个数据流的多个NetStream。<br>The following commands can be sent on the NetStream by the client to the server:</p>
<ol>
<li>play</li>
<li>play2</li>
<li>deleteStream</li>
<li>closeStream</li>
<li>receiveAudio</li>
<li>receiveVideo</li>
<li>publish</li>
<li>seek</li>
<li>pause<br>The server sends NetStream status updates to the client using the “onStatus” command:服务器使用“onStatus”命令向客户端发送 NetStream 状态更新：</li>
</ol>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">+--------------+----------+----------------------------------------+</span><br><span class="line">|<span class="string"> Field Name   </span>|<span class="string"> Type     </span>|<span class="string"> Description                            </span>|</span><br><span class="line">+--------------+----------+----------------------------------------+</span><br><span class="line">|<span class="string"> Command Name </span>|<span class="string"> String   </span>|<span class="string"> The command name &quot;onStatus&quot;.           </span>|</span><br><span class="line">+--------------+----------+----------------------------------------+</span><br><span class="line">|<span class="string"> Transaction  </span>|<span class="string"> Number   </span>|<span class="string"> Transaction ID set to 0.               </span>|</span><br><span class="line">|<span class="string"> ID           </span>|<span class="string">          </span>|<span class="string">                                        </span>|</span><br><span class="line">+--------------+----------+----------------------------------------+</span><br><span class="line">|<span class="string"> Command      </span>|<span class="string"> Null     </span>|<span class="string"> There is no command object for         </span>|</span><br><span class="line">|<span class="string"> Object       </span>|<span class="string">          </span>|<span class="string"> onStatus messages.                     </span>|</span><br><span class="line">+--------------+----------+----------------------------------------+</span><br><span class="line">|<span class="string"> Info Object  </span>|<span class="string"> Object   </span>|<span class="string"> An AMF object having at least the      </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> following three properties: &quot;level&quot;    </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> (String): the level for this message,  </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> one of &quot;warning&quot;, &quot;status&quot;, or &quot;error&quot;;</span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> &quot;code&quot; (String): the message code, for </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> example &quot;NetStream.Play.Start&quot;; and    </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> &quot;description&quot; (String): a human-       </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> readable description of the message.   </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> The Info object MAY contain other      </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> properties as appropriate to the code. </span>|</span><br><span class="line">+--------------+----------+----------------------------------------+</span><br><span class="line"></span><br><span class="line">          Format of NetStream status message commands.</span><br></pre></td></tr></table></figure>
<ul>
<li><p>客户端向服务端请求拉流： play<br>client发送这个指令要求server play a stream. A playlist can also be created using this command multiple times.<br>若你想创建一个动态playlist 能再不同的直播或已记录流中切换。调用play多次和传递false去重置，每次。 相反，如果您想立即播放指定的流，清除排队等待播放的任何其他流，请传递 true 以进行重置。<br>The command structure from the client to the server is as follows:</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">+--------------+----------+-----------------------------------------+</span><br><span class="line">|<span class="string"> Field Name   </span>|<span class="string"> Type     </span>|<span class="string"> Description                             </span>|</span><br><span class="line">+--------------+----------+-----------------------------------------+</span><br><span class="line">|<span class="string"> Command Name </span>|<span class="string"> String   </span>|<span class="string"> Name of the command. Set to &quot;play&quot;.     </span>|</span><br><span class="line">+--------------+----------+-----------------------------------------+</span><br><span class="line">|<span class="string"> Transaction  </span>|<span class="string"> Number   </span>|<span class="string"> Transaction ID set to 0.                </span>|</span><br><span class="line">|<span class="string"> ID           </span>|<span class="string">          </span>|<span class="string">                                         </span>|</span><br><span class="line">+--------------+----------+-----------------------------------------+</span><br><span class="line">|<span class="string"> Command      </span>|<span class="string"> Null     </span>|<span class="string"> Command information does not exist.     </span>|</span><br><span class="line">|<span class="string"> Object       </span>|<span class="string">          </span>|<span class="string"> Set to null type.                       </span>|</span><br><span class="line">+--------------+----------+-----------------------------------------+</span><br><span class="line">|<span class="string"> Stream Name  </span>|<span class="string"> String   </span>|<span class="string"> Name of the stream to play.             </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> To play video (FLV) files, specify the  </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> name of the stream without a file       </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> extension (for example, &quot;sample&quot;). To   </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> play back MP3 or ID3 tags, you must     </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> precede the stream name with mp3:       </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> (for example, &quot;mp3:sample&quot;. To play     </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> H.264/AAC files, you must precede the   </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> stream name with mp4: and specify the   </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> file extension. For example, to play the</span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> file sample.m4v,specify &quot;mp4:sample.m4v&quot;</span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string">                                         </span>|</span><br><span class="line">+--------------+----------+-----------------------------------------+</span><br><span class="line">|<span class="string"> Start        </span>|<span class="string"> Number   </span>|<span class="string"> An optional parameter that specifies    </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> the start time in seconds. The default  </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> value is -2, which means the subscriber </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> first tries to play the live stream     </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> specified in the Stream Name field. If a</span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> live stream of that name is not found,it</span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> plays the recorded stream of the same   </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> name. If there is no recorded stream    </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> with that name, the subscriber waits for</span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> a new live stream with that name and    </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> plays it when available. If you pass -1 </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> in the Start field, only the live stream</span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> specified in the Stream Name field is   </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> played. If you pass 0 or a positive     </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> number in the Start field, a recorded   </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> stream specified in the Stream Name     </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> field is played beginning from the time </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> specified in the Start field. If no     </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> recorded stream is found, the next item </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> in the playlist is played.              </span>|</span><br><span class="line">+--------------+----------+-----------------------------------------+</span><br><span class="line">|<span class="string"> Duration     </span>|<span class="string"> Number   </span>|<span class="string"> An optional parameter that specifies the</span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> duration of playback in seconds. The    </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> default value is -1. The -1 value means </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> a live stream is played until it is no  </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> longer available or a recorded stream is</span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> played until it ends. If you pass 0, it </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> plays the single frame since the time   </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> specified in the Start field from the   </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> beginning of a recorded stream. It is   </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> assumed that the value specified in     </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> the Start field is equal to or greater  </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> than 0. If you pass a positive number,  </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> it plays a live stream for              </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> the time period specified in the        </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> Duration field. After that it becomes   </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> available or plays a recorded stream    </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> for the time specified in the Duration  </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> field. (If a stream ends before the     </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> time specified in the Duration field,   </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> playback ends when the stream ends.)    </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> If you pass a negative number other     </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> than -1 in the Duration field, it       </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> interprets the value as if it were -1.  </span>|</span><br><span class="line">+--------------+----------+-----------------------------------------+</span><br><span class="line">|<span class="string"> Reset        </span>|<span class="string"> Boolean  </span>|<span class="string"> An optional Boolean value or number     </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> that specifies whether to flush any     </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> previous playlist.                      </span>|</span><br><span class="line">+--------------+----------+-----------------------------------------+</span><br><span class="line"></span><br><span class="line">      +-------------+                             +----------+</span><br><span class="line">      |<span class="string"> Play Client </span>|<span class="string">             </span>|<span class="string">               </span>|<span class="string">  Server  </span>|</span><br><span class="line">      +------+------+             |<span class="string">               +-----+----+</span></span><br><span class="line"><span class="string">             </span>|<span class="string">        Handshaking and Application       </span>|</span><br><span class="line">             |<span class="string">             connect done                 </span>|</span><br><span class="line">             |<span class="string">                    </span>|<span class="string">                     </span>|</span><br><span class="line">             |<span class="string">                    </span>|<span class="string">                     </span>|</span><br><span class="line">             |<span class="string">                    </span>|<span class="string">                     </span>|</span><br><span class="line">             |<span class="string">                    </span>|<span class="string">                     </span>|</span><br><span class="line">   ---+----  |<span class="string">------Command Message(createStream) -----&gt;</span>|</span><br><span class="line">Create|<span class="string">      </span>|<span class="string">                                          </span>|</span><br><span class="line">Stream|<span class="string">      </span>|<span class="string">                                          </span>|</span><br><span class="line">   ---+----  |<span class="string">&lt;---------- Command Message --------------</span>|</span><br><span class="line">             |<span class="string">     (_result- createStream response)     </span>|</span><br><span class="line">             |<span class="string">                                          </span>|</span><br><span class="line">   ---+----  |<span class="string">------ Command Message (play) -----------&gt;</span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">                                          </span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">&lt;------------  SetChunkSize --------------</span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">                                          </span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">&lt;---- User Control (StreamIsRecorded) ----</span>|</span><br><span class="line"> Play |<span class="string">      </span>|<span class="string">                                          </span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">&lt;---- UserControl (StreamBegin) ----------</span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">                                          </span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">&lt;--Command Message(onStatus-play reset) --</span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">                                          </span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">&lt;--Command Message(onStatus-play start) --</span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">                                          </span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">&lt;-------------Audio Message---------------</span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">                                          </span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">&lt;-------------Video Message---------------</span>|</span><br><span class="line">      |<span class="string">      </span>|<span class="string">                    </span>|<span class="string">                     </span>|</span><br><span class="line">                                  |<span class="string"></span></span><br><span class="line"><span class="string">           Keep receiving audio and video stream till finishes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">              Message flow in the play command</span></span><br></pre></td></tr></table></figure>
<p>流程如下：<br>The message flow during the execution of the command is:</p>
<ul>
<li>The client sends the play command after receiving result of the createStream command as success from the server.</li>
<li>On receiving the play command, the server sends a protocol message to set the chunk size.</li>
<li>The server sends another protocol message (user control) specifying the event ’StreamIsRecorded’ and the stream ID in that message. The message carries the event type in the first 2 bytes and the stream ID in the last 4 bytes.</li>
<li>The server sends another protocol message (user control) specifying the event ’StreamBegin’, to indicate beginning of the streaming to the client.</li>
<li>The server sends an onStatus command messages NetStream.Play.Start &amp; NetStream.Play.Reset if the play command sent by the client is successful. NetStream.Play.Reset is sent by the server only if the play command sent by the client has set the reset flag. If the stream to be played is not found, the Server sends the onStatus message NetStream.Play.StreamNotFound.</li>
<li>After this, the server sends audio and video data, which the client plays.</li>
</ul>
</li>
<li><p>play2:<br>不像play command.play2能切换到不同的码率流，而不用改变播放的内容的时间表。服务器为客户端可以在 play2 </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">+--------------+----------+----------------------------------------+</span><br><span class="line">|<span class="string"> Field Name   </span>|<span class="string"> Type     </span>|<span class="string"> Description                            </span>|</span><br><span class="line">+--------------+----------+----------------------------------------+</span><br><span class="line">|<span class="string"> Command Name </span>|<span class="string"> String   </span>|<span class="string"> Name of the command, set to &quot;play2&quot;.   </span>|</span><br><span class="line">+--------------+----------+----------------------------------------+</span><br><span class="line">|<span class="string"> Transaction  </span>|<span class="string"> Number   </span>|<span class="string"> Transaction ID set to 0.               </span>|</span><br><span class="line">|<span class="string"> ID           </span>|<span class="string">          </span>|<span class="string">                                        </span>|</span><br><span class="line">+--------------+----------+----------------------------------------+</span><br><span class="line">|<span class="string"> Command      </span>|<span class="string"> Null     </span>|<span class="string"> Command information does not exist.    </span>|</span><br><span class="line">|<span class="string"> Object       </span>|<span class="string">          </span>|<span class="string"> Set to null type.                      </span>|</span><br><span class="line">+--------------+----------+----------------------------------------+</span><br><span class="line">|<span class="string"> Parameters   </span>|<span class="string"> Object   </span>|<span class="string"> An AMF encoded object whose properties </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> are the public properties described    </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> for the flash.net.NetStreamPlayOptions </span>|</span><br><span class="line">|<span class="string">              </span>|<span class="string">          </span>|<span class="string"> ActionScript object.                   </span>|</span><br><span class="line">+--------------+----------+----------------------------------------+</span><br><span class="line"></span><br><span class="line">    +--------------+                          +-------------+</span><br><span class="line">    |<span class="string"> Play2 Client </span>|<span class="string">             </span>|<span class="string">            </span>|<span class="string">   Server    </span>|</span><br><span class="line">    +--------+-----+             |<span class="string">            +------+------+</span></span><br><span class="line"><span class="string">             </span>|<span class="string">      Handshaking and Application      </span>|</span><br><span class="line">             |<span class="string">             connect done              </span>|</span><br><span class="line">             |<span class="string">                   </span>|<span class="string">                   </span>|</span><br><span class="line">             |<span class="string">                   </span>|<span class="string">                   </span>|</span><br><span class="line">             |<span class="string">                   </span>|<span class="string">                   </span>|</span><br><span class="line">             |<span class="string">                   </span>|<span class="string">                   </span>|</span><br><span class="line">    ---+---- |<span class="string">---- Command Message(createStream) ---&gt;</span>|</span><br><span class="line">Create |<span class="string">     </span>|<span class="string">                                       </span>|</span><br><span class="line">Stream |<span class="string">     </span>|<span class="string">                                       </span>|</span><br><span class="line">    ---+---- |<span class="string">&lt;---- Command Message (_result) -------</span>|</span><br><span class="line">             |<span class="string">                                       </span>|</span><br><span class="line">    ---+---- |<span class="string">------ Command Message (play) --------&gt;</span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">                                       </span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">&lt;------------ SetChunkSize ------------</span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">                                       </span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">&lt;--- UserControl (StreamIsRecorded)----</span>|</span><br><span class="line">  Play |<span class="string">     </span>|<span class="string">                                       </span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">&lt;------- UserControl (StreamBegin)-----</span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">                                       </span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">&lt;--Command Message(onStatus-playstart)-</span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">                                       </span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">&lt;---------- Audio Message -------------</span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">                                       </span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">&lt;---------- Video Message -------------</span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">                                       </span>|</span><br><span class="line">       |<span class="string">     </span>|</span><br><span class="line">    ---+---- |<span class="string">-------- Command Message(play2) ------&gt;</span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">                                       </span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">&lt;------- Audio Message (new rate) -----</span>|</span><br><span class="line"> Play2 |<span class="string">     </span>|<span class="string">                                       </span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">&lt;------- Video Message (new rate) -----</span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">                  </span>|<span class="string">                    </span>|</span><br><span class="line">       |<span class="string">     </span>|<span class="string">                  </span>|<span class="string">                    </span>|</span><br><span class="line">       |<span class="string"> Keep receiving audio and video stream till finishes</span></span><br><span class="line"><span class="string">                                </span>|</span><br><span class="line"></span><br><span class="line">           Message flow in the play2 command</span><br></pre></td></tr></table></figure></li>
<li><p>deleteStream:<br>NetStream sends the deleteStream command when the NetStream object is getting destroyed.</p>
</li>
</ul>
<p>The command structure from the client to the server is as follows:</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+--------------+</span>----------<span class="code">+----------------------------------------+</span></span><br><span class="line"><span class="section">| Field Name   | Type     | Description                            |</span></span><br><span class="line"><span class="section">+--------------+----------+----------------------------------------+</span></span><br><span class="line">| Command Name | String   | Name of the command, set to            |</span><br><span class="line"><span class="section">|              |          | &quot;deleteStream&quot;.                        |</span></span><br><span class="line"><span class="section">+--------------+----------+----------------------------------------+</span></span><br><span class="line">| Transaction  | Number   | Transaction ID set to 0.               |</span><br><span class="line"><span class="section">| ID           |          |                                        |</span></span><br><span class="line"><span class="section">+--------------+----------+----------------------------------------+</span></span><br><span class="line">| Command      | Null     | Command information object does not    |</span><br><span class="line"><span class="section">| Object       |          | exist. Set to null type.               |</span></span><br><span class="line"><span class="section">+--------------+----------+----------------------------------------+</span></span><br><span class="line">| Stream ID    | Number   | The ID of the stream that is destroyed |</span><br><span class="line"><span class="section">|              |          | on the server.                         |</span></span><br><span class="line"><span class="section">+--------------+----------+----------------------------------------+</span></span><br></pre></td></tr></table></figure>
<p>The server does not send any response.<br>receiveAudio: NetStream发送这个command消息通知服务器是否发送音频给客户端。</p>
<ul>
<li>receiveVideo:和24类似</li>
<li>publish: 客户端发送publish去发布一个命名流给到服务器。使用这个名字，任何client能play这个流和接收发布的音视频和data message.</li>
<li>seek: client发送seek command去在媒体文件或播放列表中寻求偏移量（以毫秒为单位）。</li>
<li>pause： client发送pause command告诉服务器暂停和启动playing</li>
</ul>
<h4 id="Message-Exchange-Examples"><a href="#Message-Exchange-Examples" class="headerlink" title="Message Exchange Examples"></a>Message Exchange Examples</h4><p>略：</p>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>rtmp节点的flv tag直接是取rtmp协议中header中的messagelen<br>流程： 客户端向服务端请求推流； publish</p>
<ol>
<li>srs_rtmp_handshake ：c0c1 s0s1s2 c2 握手</li>
<li>srs_rtmp_connect_app : 带各种键值对： tcurl,swfurl,…  连接</li>
<li>一些protocol control message: SetChunkSize</li>
<li>访问rtmp流： 推流端：对于推流端，客户端要向服务器发送一个releaseStream命令消息，之后是createStream命令消息，对于拉流端，则要发送play消息请求视频资源。我们来先看看createStream消息，RTMP客户端发送此消息到服务端，创建一个逻辑通道，用于消息通信。音频、视频、元数据均通过createStream创建的数据通道进行交互，而releaseStream与createStream相对应，为什么有的时候会在createStream之前先来一次releaseStream呢？这就像我们很多的服务实现中，先进行一次stop，然后再进行start一样。因为我们每次开启新的流程，并不能确保之前的流程是否正常走完，是否出现了异常情况，异常的情况是否已经处理等等，所以，做一个类似于恢复初始状态的操作，releaseStream就是这个作用。<br> releaseStream, FCPUBLISH , CreateStream 用于创建一个新的通道；</li>
<li>等待server返回结果： 返回streamID等</li>
<li>推流，需要publish stream: 主要携带流名称；</li>
<li>推流信令的返回response</li>
<li>创建chunk 后发送媒体数据</li>
</ol>
<h4 id="ref-https-github-com-melpon-rfc-blob-master-rtmp-md"><a href="#ref-https-github-com-melpon-rfc-blob-master-rtmp-md" class="headerlink" title="ref: https://github.com/melpon/rfc/blob/master/rtmp.md"></a>ref: <a target="_blank" rel="noopener" href="https://github.com/melpon/rfc/blob/master/rtmp.md">https://github.com/melpon/rfc/blob/master/rtmp.md</a></h4>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/rtmp/" rel="tag"># rtmp</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/02/live-rtp/" rel="prev" title="live_rtp">
      <i class="fa fa-chevron-left"></i> live_rtp
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/04/02/lua/" rel="next" title="lua">
      lua <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-rtmp%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9A"><span class="nav-number">1.</span> <span class="nav-text">1 rtmp是什么：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-rtmp%E4%B8%AD%E7%9A%84%E5%85%83%E7%B4%A0%EF%BC%9A"><span class="nav-number">2.</span> <span class="nav-text">2 rtmp中的元素：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%AD%97%E8%8A%82%E5%BA%8F%EF%BC%8C%E5%AF%B9%E9%BD%90%E5%92%8C%E6%97%B6%E9%97%B4%E6%A0%BC%E5%BC%8F%EF%BC%9A"><span class="nav-number">3.</span> <span class="nav-text">3 字节序，对齐和时间格式：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-RTMP-CHUNK-STREAM"><span class="nav-number">4.</span> <span class="nav-text">4 RTMP CHUNK STREAM:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-Message-Format"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 Message Format:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-%E6%8F%A1%E6%89%8B%EF%BC%9A"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 握手：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Handshake-Sequence"><span class="nav-number">4.2.1.</span> <span class="nav-text">Handshake Sequence</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#C0-and-S0-Format"><span class="nav-number">4.2.2.</span> <span class="nav-text">C0 and S0 Format</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#C1-and-S1-Format"><span class="nav-number">4.2.3.</span> <span class="nav-text">C1 and S1 Format</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#C2-and-S2-Format"><span class="nav-number">4.2.4.</span> <span class="nav-text">C2 and S2 Format</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%A4%E4%BA%92%E5%9B%BE"><span class="nav-number">4.2.5.</span> <span class="nav-text">交互图</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-chunking"><span class="nav-number">4.3.</span> <span class="nav-text">5 chunking:</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#chunk%E5%A4%B4%E6%A0%BC%E5%BC%8F"><span class="nav-number">4.3.1.</span> <span class="nav-text">chunk头格式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#chunk-message-header"><span class="nav-number">4.3.2.</span> <span class="nav-text">chunk message header:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#message%E7%BB%84%E7%BB%87%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="nav-number">4.3.3.</span> <span class="nav-text">message组织方式：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Example-1"><span class="nav-number">4.3.4.</span> <span class="nav-text">Example 1</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#example2-%E8%BF%99%E9%87%8C%E5%81%87%E8%AE%BEchunk%E7%9A%84%E6%9C%80%E5%A4%A7%E6%98%AF128%EF%BC%8C%E8%BF%99%E9%87%8C%E7%9A%84message%E8%B6%85%E5%87%BA%E4%BA%86%EF%BC%9B%E4%BC%9A%E8%A2%AB%E5%88%86%E4%B8%BA%E5%A4%9A%E4%B8%AAchunk"><span class="nav-number">4.3.5.</span> <span class="nav-text">example2: 这里假设chunk的最大是128，这里的message超出了；会被分为多个chunk.</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#message%E5%88%86%E7%B1%BB%E7%AD%89%EF%BC%9A"><span class="nav-number">4.4.</span> <span class="nav-text">message分类等：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#message-type-id"><span class="nav-number">4.4.1.</span> <span class="nav-text">message type id:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B3%E4%BA%8EProtocol-Control-Messages%EF%BC%9A"><span class="nav-number">4.4.2.</span> <span class="nav-text">关于Protocol Control Messages：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#set-chunk-size"><span class="nav-number">4.4.2.1.</span> <span class="nav-text">set chunk size:</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Abort-Message-detail"><span class="nav-number">4.4.2.2.</span> <span class="nav-text">Abort Message detail:</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Acknowledgement-%E5%8D%B3ack-%E5%9B%A0%E4%B8%BArtmp%E7%9B%AE%E5%89%8D%E4%B8%BB%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%98%AF%E5%9F%BA%E4%BA%8Etcp%E7%9A%84%EF%BC%8C%E6%89%80%E4%BB%A5%E8%BF%99%E4%B8%AA%E5%9F%BA%E6%9C%AC%E6%B2%A1%E6%80%8E%E4%B9%88%E7%94%A8%E5%88%B0%E3%80%82"><span class="nav-number">4.4.2.3.</span> <span class="nav-text">Acknowledgement:即ack  因为rtmp目前主流实现是基于tcp的，所以这个基本没怎么用到。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Window-Ack-size-%E5%8D%B3%E5%A4%9A%E4%B9%85-%E5%A4%9A%E5%B0%91%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E4%BA%86%E8%A6%81%E5%8F%91ack"><span class="nav-number">4.4.2.4.</span> <span class="nav-text">Window Ack size: 即多久(多少数据传输了要发ack)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#set-peer-bandwidth"><span class="nav-number">4.4.2.5.</span> <span class="nav-text">set peer bandwidth:</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#shared-obj-message-detail"><span class="nav-number">4.4.2.6.</span> <span class="nav-text">shared obj message detail:</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Aggregate-Message-detail"><span class="nav-number">4.4.2.7.</span> <span class="nav-text">Aggregate Message detail:</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B3%E4%BA%8Etype4-User-Control-Messages"><span class="nav-number">4.4.3.</span> <span class="nav-text">关于type4 User Control Messages</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E-RTMP-Command-Messages-command-message-detail"><span class="nav-number">4.4.4.</span> <span class="nav-text">关于 RTMP Command Messages: command message detail:</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%EF%BC%9Atype-of-command"><span class="nav-number">4.4.4.1.</span> <span class="nav-text">类型：type of command:</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Message-Exchange-Examples"><span class="nav-number">4.5.</span> <span class="nav-text">Message Exchange Examples</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="nav-number">4.6.</span> <span class="nav-text">总结：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ref-https-github-com-melpon-rfc-blob-master-rtmp-md"><span class="nav-number">4.7.</span> <span class="nav-text">ref: https:&#x2F;&#x2F;github.com&#x2F;melpon&#x2F;rfc&#x2F;blob&#x2F;master&#x2F;rtmp.md</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="小兴"
      src="/images/headicon2.jpg">
  <p class="site-author-name" itemprop="name">小兴</p>
  <div class="site-description" itemprop="description">始于歧路，愿归于征途</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">94</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xdksx/" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xdksx&#x2F;" rel="noopener" target="_blank"><i class="fa fa-fw fa-github-square"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/ksance@gmail.com" title="E-Mail → ksance@gmail.com"><i class="fa fa-fw fa-envelope"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/572897439" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;572897439" rel="noopener" target="_blank"><i class="fa fa-fw fa-facebook"></i></a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      friendly link
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://yoursite.com/" title="http:&#x2F;&#x2F;yoursite.com" rel="noopener" target="_blank">Title</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小兴</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v6.1.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '06e6b70d396f6928e45a',
      clientSecret: 'cd03b7c657d50a5d76a7fa682c4f8eb48cb15fc3',
      repo        : 'xdksx.github.io',
      owner       : 'xdksx',
      admin       : ['xdksx'],
      id          : '3abd187ade261166eeca502bfb2830e0',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
