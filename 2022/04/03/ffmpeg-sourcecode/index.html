<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xdksx.github.io","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="ffmpeg 源码简介ffmpeg源代码中，有很多函数钩子挂载点，类似linux内核，因为ffmpeg也是c语言写得，所以这样实现，有利于接入新类型，即泛型。也使得代码结构更清晰更容易阅读。">
<meta property="og:type" content="article">
<meta property="og:title" content="ffmpeg_sourcecode">
<meta property="og:url" content="https://xdksx.github.io/2022/04/03/ffmpeg-sourcecode/index.html">
<meta property="og:site_name" content="追光者">
<meta property="og:description" content="ffmpeg 源码简介ffmpeg源代码中，有很多函数钩子挂载点，类似linux内核，因为ffmpeg也是c语言写得，所以这样实现，有利于接入新类型，即泛型。也使得代码结构更清晰更容易阅读。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xdksx.github.io/2022/04/03/ffmpeg-sourcecode/ffmpeg.drawio.png">
<meta property="article:published_time" content="2022-04-03T07:53:55.000Z">
<meta property="article:modified_time" content="2022-04-04T05:08:30.342Z">
<meta property="article:author" content="小兴">
<meta property="article:tag" content="ffmpeg">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xdksx.github.io/2022/04/03/ffmpeg-sourcecode/ffmpeg.drawio.png">

<link rel="canonical" href="https://xdksx.github.io/2022/04/03/ffmpeg-sourcecode/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>ffmpeg_sourcecode | 追光者</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">追光者</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">小兴的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-观影">

    <a href="/movies/" rel="section"><i class="fa fa-fw fa-film"></i>观影</a>

  </li>
        <li class="menu-item menu-item-阅读">

    <a href="/read/" rel="section"><i class="fa fa-fw fa-book"></i>阅读</a>

  </li>
        <li class="menu-item menu-item-心理">

    <a href="/categories/%E5%BF%83%E7%90%86/" rel="section"><i class="fa fa-fw fa-heart"></i>心理</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xdksx.github.io/2022/04/03/ffmpeg-sourcecode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/headicon2.jpg">
      <meta itemprop="name" content="小兴">
      <meta itemprop="description" content="始于歧路，愿归于征途">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追光者">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ffmpeg_sourcecode
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-03 15:53:55" itemprop="dateCreated datePublished" datetime="2022-04-03T15:53:55+08:00">2022-04-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-04 13:08:30" itemprop="dateModified" datetime="2022-04-04T13:08:30+08:00">2022-04-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ffmpeg/" itemprop="url" rel="index"><span itemprop="name">ffmpeg</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="ffmpeg-源码简介"><a href="#ffmpeg-源码简介" class="headerlink" title="ffmpeg 源码简介"></a>ffmpeg 源码简介</h3><p>ffmpeg源代码中，有很多函数钩子挂载点，类似linux内核，因为ffmpeg也是c语言写得，所以这样实现，有利于接入新类型，即泛型。<br>也使得代码结构更清晰更容易阅读。</p>
<span id="more"></span>
<h3 id="ffmpeg源码结构图"><a href="#ffmpeg源码结构图" class="headerlink" title="ffmpeg源码结构图"></a>ffmpeg源码结构图</h3><img src="/2022/04/03/ffmpeg-sourcecode/ffmpeg.drawio.png" class="" title="This is an example image">

<h3 id="ffmpeg-c分析："><a href="#ffmpeg-c分析：" class="headerlink" title="ffmpeg.c分析："></a>ffmpeg.c分析：</h3><p>为了了解ffmpeg的框架结构，先看看ffmpeg工具是如何调用ffmpeg中的接口的。</p>
<h4 id="总体："><a href="#总体：" class="headerlink" title="总体："></a>总体：</h4><p>ffmpeg.c:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i, ret;</span><br><span class="line">    BenchmarkTimeStamps ti;</span><br><span class="line"></span><br><span class="line">    init_dynload();<span class="comment">//win下设置 dll动态库路径（SetDllDirectory(&quot;&quot;);），非关键逻辑。</span></span><br><span class="line"></span><br><span class="line">    register_exit(ffmpeg_cleanup);<span class="comment">//注册或者说挂载退出函数 programe_exit = ffmpeg_cleanup</span></span><br><span class="line"></span><br><span class="line">    setvbuf(stderr,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>); <span class="comment">/* win32 runtime needs this */</span></span><br><span class="line"></span><br><span class="line">    av_log_set_flags(<span class="built_in">AV_LOG_SKIP_REPEATED</span>);<span class="comment">//设置log flag,skip repeated messages</span></span><br><span class="line">    parse_loglevel(argc, argv, options);<span class="comment">//根据输入参数调整log等级</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(argc&gt;<span class="number">1</span> &amp;&amp; !strcmp(argv[<span class="number">1</span>], <span class="string">&quot;-d&quot;</span>))&#123;<span class="comment">//是否有-d,则作为后台程序。</span></span><br><span class="line">        run_as_daemon=<span class="number">1</span>;</span><br><span class="line">        av_log_set_callback(log_callback_null);</span><br><span class="line">        argc--;</span><br><span class="line">        argv++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//注册组件</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_AVDEVICE</span></span><br><span class="line">    avdevice_register_all();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    avformat_network_init();<span class="comment">//win32下需要</span></span><br><span class="line"></span><br><span class="line">    show_banner(argc, argv, options);<span class="comment">//显示打印参数。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* parse options and open all input/output files */</span></span><br><span class="line">    ret = ffmpeg_parse_options(argc, argv);<span class="comment">//解析输入参数，包括input,output,--关键函数1</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        exit_program(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nb_output_files &lt;= <span class="number">0</span> &amp;&amp; nb_input_files == <span class="number">0</span>) &#123;</span><br><span class="line">        show_usage();</span><br><span class="line">        av_log(<span class="literal">NULL</span>, <span class="built_in">AV_LOG_WARNING</span>, <span class="string">&quot;Use -h to get full help or, even better, run &#x27;man %s&#x27;\n&quot;</span>, program_name);</span><br><span class="line">        exit_program(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* file converter / grab */</span></span><br><span class="line">    <span class="keyword">if</span> (nb_output_files &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, <span class="built_in">AV_LOG_FATAL</span>, <span class="string">&quot;At least one output file must be specified\n&quot;</span>);</span><br><span class="line">        exit_program(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nb_output_files; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (strcmp(output_files[i]-&gt;ctx-&gt;oformat-&gt;name, <span class="string">&quot;rtp&quot;</span>))</span><br><span class="line">            want_sdp = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    current_time = ti = get_benchmark_time_stamps();</span><br><span class="line">    <span class="keyword">if</span> (transcode() &lt; <span class="number">0</span>)<span class="comment">//读取接收的媒体数据，进行处理： 主循环，也就这个循环了。--关键函数2</span></span><br><span class="line">        exit_program(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (do_benchmark) &#123;</span><br><span class="line">        int64_t utime, stime, rtime;</span><br><span class="line">        current_time = get_benchmark_time_stamps();</span><br><span class="line">        utime = current_time.user_usec - ti.user_usec;</span><br><span class="line">        stime = current_time.sys_usec  - ti.sys_usec;</span><br><span class="line">        rtime = current_time.real_usec - ti.real_usec;</span><br><span class="line">        av_log(<span class="literal">NULL</span>, <span class="built_in">AV_LOG_INFO</span>,</span><br><span class="line">               <span class="string">&quot;bench: utime=%0.3fs stime=%0.3fs rtime=%0.3fs\n&quot;</span>,</span><br><span class="line">               utime / <span class="number">1000000.0</span>, stime / <span class="number">1000000.0</span>, rtime / <span class="number">1000000.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    av_log(<span class="literal">NULL</span>, <span class="built_in">AV_LOG_DEBUG</span>, <span class="string">&quot;%&quot;</span>PRIu64<span class="string">&quot; frames successfully decoded, %&quot;</span>PRIu64<span class="string">&quot; decoding errors\n&quot;</span>,</span><br><span class="line">           decode_error_stat[<span class="number">0</span>], decode_error_stat[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> ((decode_error_stat[<span class="number">0</span>] + decode_error_stat[<span class="number">1</span>]) * max_error_rate &lt; decode_error_stat[<span class="number">1</span>])</span><br><span class="line">        exit_program(<span class="number">69</span>);</span><br><span class="line"></span><br><span class="line">    exit_program(received_nb_signals ? <span class="number">255</span> : main_return_code);</span><br><span class="line">    <span class="keyword">return</span> main_return_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="解析参数，初始化输入输出"><a href="#解析参数，初始化输入输出" class="headerlink" title="解析参数，初始化输入输出"></a>解析参数，初始化输入输出</h4><p>ffmpeg_parse_options(argc, argv);&#x2F;&#x2F;解析输入参数，包括input,output,–关键函数1<br>分析：</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">int ffmpeg_parse_options(int argc, char <span class="comment">**argv)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    OptionParseContext octx;</span></span><br><span class="line">    uint8_t <span class="keyword">error</span>[128];</span><br><span class="line">    int ret;</span><br><span class="line"></span><br><span class="line">    memset(<span class="variable">&amp;octx</span>, 0, sizeof(octx));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* split the commandline into an internal representation */</span></span><br><span class="line">    ret = split_commandline(<span class="variable">&amp;octx</span>, argc, argv, <span class="keyword">options</span>, groups,</span><br><span class="line">                            FF_ARRAY_ELEMS(groups));//解析参数和初始化octx</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; 0) &#123;</span><br><span class="line">        av_<span class="meta">log</span>(<span class="keyword">NULL</span>, AV_LOG_FATAL, <span class="string">&quot;Error splitting the argument list: &quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* apply global options */</span></span><br><span class="line">    ret = parse_optgroup(<span class="keyword">NULL</span>, <span class="variable">&amp;octx.</span>global_opts);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; 0) &#123;</span><br><span class="line">        av_<span class="meta">log</span>(<span class="keyword">NULL</span>, AV_LOG_FATAL, <span class="string">&quot;Error parsing global options: &quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* configure terminal and setup signal handlers */</span></span><br><span class="line">    term_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* open input files */</span>  //关键函数1_1 初始化输入：</span><br><span class="line">    ret = open_files(<span class="variable">&amp;octx.</span>groups[GROUP_INFILE], <span class="string">&quot;input&quot;</span>, open_input_file);</span><br><span class="line">    <span class="comment">/*&#123;</span></span><br><span class="line"><span class="comment">    ffmpeg_opt.c static int open_input_file(OptionsContext *o, const char *filename)</span></span><br><span class="line"><span class="comment">           err = avformat_open_input(&amp;ic, filename, file_iformat, &amp;o-&gt;g-&gt;format_opts);</span></span><br><span class="line"><span class="comment">             init_input(s, filename, &amp;tmp))  </span></span><br><span class="line"><span class="comment">                if ((ret = s-&gt;io_open(s, &amp;s-&gt;pb, filename, AVIO_FLAG_READ | s-&gt;avio_flags, options)) &lt; 0)</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; 0) &#123;</span><br><span class="line">        av_<span class="meta">log</span>(<span class="keyword">NULL</span>, AV_LOG_FATAL, <span class="string">&quot;Error opening input files: &quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create the complex filtergraphs */</span></span><br><span class="line">    ret = init_complex_filters();</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; 0) &#123;</span><br><span class="line">        av_<span class="meta">log</span>(<span class="keyword">NULL</span>, AV_LOG_FATAL, <span class="string">&quot;Error initializing complex filters.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* open output files */</span>  //关键函数1_2   初始化输出</span><br><span class="line">    ret = open_files(<span class="variable">&amp;octx.</span>groups[GROUP_OUTFILE], <span class="string">&quot;output&quot;</span>, open_output_file);</span><br><span class="line">    <span class="comment">/*&#123;</span></span><br><span class="line"><span class="comment">     ffmpeg_opt.c int open_output_file(OptionsContext *o, const char *filename)</span></span><br><span class="line"><span class="comment">            err = avformat_alloc_output_context2(&amp;oc, NULL, o-&gt;format, filename);</span></span><br><span class="line"><span class="comment">             codec = avcodec_find_encoder_by_name(codec_name);</span></span><br><span class="line"><span class="comment">              c = avcodec_alloc_context3(codec);</span></span><br><span class="line"><span class="comment">     &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; 0) &#123;</span><br><span class="line">        av_<span class="meta">log</span>(<span class="keyword">NULL</span>, AV_LOG_FATAL, <span class="string">&quot;Error opening output files: &quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    check_filter_outputs();</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">    uninit_parse_context(<span class="variable">&amp;octx</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; 0) &#123;</span><br><span class="line">        av_strerror(ret, <span class="keyword">error</span>, sizeof(<span class="keyword">error</span>));</span><br><span class="line">        av_<span class="meta">log</span>(<span class="keyword">NULL</span>, AV_LOG_FATAL, <span class="string">&quot;%s\n&quot;</span>, <span class="keyword">error</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="初始化输入文件："><a href="#初始化输入文件：" class="headerlink" title="初始化输入文件："></a>初始化输入文件：</h5><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">static int open_input_file(OptionsContext *o, const char *filename)</span><br><span class="line">  <span class="number">1</span>) 分配AVFormatContext结构；</span><br><span class="line">    ic = avformat_alloc_context();</span><br><span class="line">       avformat_get_context_defaults(ic);</span><br><span class="line">       static void avformat_get_context_defaults(AVFormatContext *s)</span><br><span class="line">       &#123;</span><br><span class="line">           memset(s, <span class="number">0</span>, sizeof(AVFormatContext));</span><br><span class="line">       </span><br><span class="line">           <span class="function"><span class="title">s</span>-&gt;</span>av_class = &amp;av_format_context_class;</span><br><span class="line">       </span><br><span class="line">           <span class="function"><span class="title">s</span>-&gt;</span>io_open  = io_open_default;<span class="comment">//挂载默认io开启函数，可能是从文件读取或者是url</span></span><br><span class="line">           <span class="function"><span class="title">s</span>-&gt;</span>io_close = io_close_default;<span class="comment">//默认io关闭函数</span></span><br><span class="line">       </span><br><span class="line">           av_opt_set_defaults(s);</span><br><span class="line">       &#125;</span><br><span class="line">   <span class="number">2</span>) <span class="comment">/* open the input file with generic avformat function */</span></span><br><span class="line">   <span class="comment">//初始化读取io, avformat容器格式相关结构,并分配和初始化 AVFormatContext</span></span><br><span class="line">    <span class="function"><span class="title">err</span> = avformat_open_input(&amp;ic, filename, file_iformat, &amp;o-&gt;</span><span class="function"><span class="title">g</span>-&gt;</span>format_opts);</span><br><span class="line">       init_input(s, filename, &amp;tmp))</span><br><span class="line">         <span class="function"><span class="title">s</span>-&gt;</span><span class="function"><span class="title">io_open</span>(s, &amp;s-&gt;</span><span class="function"><span class="title">pb</span>, filename, AVIO_FLAG_READ | s-&gt;</span>avio_flags, options)) </span><br><span class="line">           io_open_default</span><br><span class="line">         av_probe_input_buffer2</span><br><span class="line">            <span class="comment">/* Guess file format. */</span></span><br><span class="line">            *fmt = av_probe_input_format2(&amp;pd, <span class="number">1</span>, &amp;score);</span><br><span class="line">            </span><br><span class="line">   <span class="number">3</span>)  avformat_find_stream_info <span class="comment">//初始化AVFormatContext中的AVStream **stream,创建stream</span></span><br><span class="line">   <span class="function"><span class="title">if</span> ((ret = avformat_find_stream_info(ifmt_ctx, NULL)) &lt; 0) &#123;//解码器相关。  codec = find_probe_decoder(ic, st, st-&gt;</span><span class="function"><span class="title">codecpar</span>-&gt;</span>codec_id);去找解码器；</span><br><span class="line">    关于如何创建nb_streams:</span><br><span class="line">    是被赋值初始化：</span><br><span class="line">    &#123;</span><br><span class="line">       avformat_find_stream_info</span><br><span class="line">            -&gt; read_frame_internal(AVFormatContext *s, AVPacket *pkt)</span><br><span class="line">              -&gt; ff_read_packet(s, pkt);</span><br><span class="line">                 -&gt; <span class="function"><span class="title">err</span> = s-&gt;</span><span class="function"><span class="title">iformat</span>-&gt;</span>read_packet(s, pkt);中</span><br><span class="line"></span><br><span class="line">      <span class="comment">//测试时是读取flv文件，所以这里走到：flv_read_packet//因为要先解出头</span></span><br><span class="line">       <span class="function"><span class="title">if</span> (i == s-&gt;</span>nb_streams) &#123;</span><br><span class="line">        static const enum AVMediaType stream_types[] = &#123;AVMEDIA_TYPE_VIDEO, AVMEDIA_TYPE_AUDIO, AVMEDIA_TYPE_SUBTITLE, AVMEDIA_TYPE_DATA&#125;;</span><br><span class="line">        st = create_stream(s, stream_types[stream_type]);<span class="comment">//这里面创建stream，并为nb_stream累加、</span></span><br><span class="line">        <span class="keyword">if</span> (!st)</span><br><span class="line">            return AVERROR(ENOMEM);</span><br><span class="line">       &#125;</span><br><span class="line">       try_decode_frame(ic, st, pkt,。。) <span class="comment">//头的解码？</span></span><br><span class="line">    &#125;</span><br><span class="line">   <span class="number">4</span>) 循环每个输入流：</span><br><span class="line">   <span class="function"><span class="title">for</span> (i = 0; i &lt; ifmt_ctx-&gt;</span>nb_streams; i++) &#123;</span><br><span class="line">      AVS<span class="function"><span class="title">tream</span> *stream = ifmt_ctx-&gt;</span>streams[i];</span><br><span class="line">      avcodec_find_decoder <span class="comment">////根据id寻找解码器；返回对应的实例；</span></span><br><span class="line">      codec_ctx = avcodec_alloc_context3(dec); <span class="comment">////分配一个AVCodecContext;</span></span><br><span class="line">      <span class="function"><span class="title">ret</span> = avcodec_parameters_to_context(codec_ctx, stream-&gt;</span>codecpar);<span class="comment">//填充参数</span></span><br><span class="line">      <span class="comment">/* Open decoder */</span></span><br><span class="line">            ret = avcodec_open2(codec_ctx, dec, NULL); <span class="comment">//调用AVCodec的init函数进行初始化，注意此时avcodec成员已被赋值的</span></span><br><span class="line"></span><br><span class="line">-----------------------------------------------</span><br><span class="line">   &#123; trace io_open_default函数：</span><br><span class="line">options.c：io_open_default   </span><br><span class="line">    <span class="function"><span class="title">aviobuf</span>.c: ffio_open_whitelist(pb, url, flags, &amp;s-&gt;</span><span class="function"><span class="title">interrupt_callback</span>, options, s-&gt;</span><span class="function"><span class="title">protocol_whitelist</span>, s-&gt;</span>protocol_blacklist);</span><br><span class="line">          err = ffurl_open_whitelist(&amp;h, filename, flags, int_cb, options, whitelist, blacklist, NULL);</span><br><span class="line">              int ret = ffurl_alloc(puc, filename, flags, int_cb);<span class="comment">//根据filename在url_protocol列表中找对应的结构</span></span><br><span class="line">               ret = ffurl_connect(*puc, options);<span class="comment">//调用该结构的 初始化函数。</span></span><br><span class="line">          err = ffio_fdopen(s, h);</span><br><span class="line">                *s = avio_alloc_context(...<span class="comment">//分配AVIOContext</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="初始化输出："><a href="#初始化输出：" class="headerlink" title="初始化输出："></a>初始化输出：</h5><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//输出：</span></span><br><span class="line">avformat<span class="constructor">_alloc_output_context2(&amp;<span class="params">ofmt_ctx</span>, NULL, NULL, <span class="params">out_filename</span>)</span>; <span class="comment">//初始化和分配输出相关context,即初始化AVFormatContext中的oformat</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//编码：</span></span><br><span class="line"> <span class="comment">/* find the mpeg1video encoder */</span> <span class="comment">//可以通过文件名或编码名；</span></span><br><span class="line">    codec = avcodec<span class="constructor">_find_encoder_by_name(<span class="params">codec_name</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//分配编码上下文：</span></span><br><span class="line"> c = avcodec<span class="constructor">_alloc_context3(<span class="params">codec</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//编码：  /* encode the image */ </span></span><br><span class="line">        encode(c, frame, pkt, f); <span class="comment">//传入AVFrame和要填充的pkt</span></span><br><span class="line">                   ret = avcodec<span class="constructor">_send_frame(<span class="params">enc_ctx</span>, <span class="params">frame</span>)</span>;</span><br><span class="line">                    <span class="keyword">while</span> (ret &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                     ret = avcodec<span class="constructor">_receive_packet(<span class="params">enc_ctx</span>, <span class="params">pkt</span>)</span>;</span><br><span class="line">                     </span><br><span class="line">                     </span><br></pre></td></tr></table></figure>
<hr>
<h4 id="分析主循环："><a href="#分析主循环：" class="headerlink" title="分析主循环："></a>分析主循环：</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (transcode<span class="literal">()</span> &lt; <span class="number">0</span>)<span class="comment">//读取接收的媒体数据，进行处理： 主循环，也就这个循环了。--关键函数2</span></span><br><span class="line">分析：</span><br><span class="line"></span><br><span class="line">读取接收的媒体数据，进行处理： 主循环，也就这个循环了。</span><br><span class="line">   transcode</span><br><span class="line">       transcode_init</span><br><span class="line">       transcode<span class="constructor">_step(<span class="params">void</span>)</span></span><br><span class="line">             process_input</span><br><span class="line">                 get<span class="constructor">_input_packet(<span class="params">ifile</span>, &amp;<span class="params">pkt</span>)</span>;</span><br><span class="line">                     av_read_frame<span class="comment">//一次只读一个包，所以需要循环读；</span></span><br><span class="line">                          read_frame_internal</span><br><span class="line">                            ff<span class="constructor">_read_packet(<span class="params">s</span>, <span class="params">pkt</span>)</span>;</span><br><span class="line">                            &#123;</span><br><span class="line">                             <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                                PacketList *pktl = s-&gt;internal-&gt;raw_packet_buffer;</span><br><span class="line">                                const AVPacket *pkt1;</span><br><span class="line">                                err = s-&gt;iformat-&gt;read<span class="constructor">_packet(<span class="params">s</span>, <span class="params">pkt</span>)</span>;</span><br><span class="line">                                <span class="comment">//调用原始的ffurl_read读，所以应该是边读边处理；</span></span><br><span class="line">                                <span class="comment">//从format中读取数据，会调用其 read_packet函数，</span></span><br><span class="line">                                <span class="comment">//这个函数在初始化时被赋值为ffurl_read: </span></span><br><span class="line">                                <span class="comment">//ffio_fdopen中做处理aviobuf.c 填充流的解码相关结构。</span></span><br><span class="line">                            &#125;</span><br><span class="line">                            </span><br><span class="line">                          <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                                PacketList *pktl = s-&gt;internal-&gt;packet_buffer;  <span class="comment">//</span></span><br><span class="line">                 process<span class="constructor">_input_packet(<span class="params">ist</span>, NULL, 1)</span>;</span><br><span class="line">        flush_encoders</span><br><span class="line">        term<span class="constructor">_exit()</span>;</span><br></pre></td></tr></table></figure>


<h3 id="分析输入url的结构框架构建："><a href="#分析输入url的结构框架构建：" class="headerlink" title="分析输入url的结构框架构建："></a>分析输入url的结构框架构建：</h3><p>对应结构：AVIOContext *s,  重要数据结构：<br>以rtmp输入为例：<br>可以用ffmpeg做推拉流，但是主要是client端，传入的filename携带 “rtmp” 关键字；<br>从上面的分析可以看到：<br>open_input_file的时候：会调用：io_open_default<br>接着去找一个URLProtocol结构的实例，然后挂载，那么具体是什么样的？<br>ffmpeg在编译后会生成一个：”libavformat&#x2F;protocol_list.c” 文件，包含一个URLProtocol类型<br>的数组：<br>如：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">static const URLProtocol * const url_protocols[] = &#123;</span><br><span class="line">    <span class="meta">&amp;ff_async_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_cache_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_concat_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_concatf_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_crypto_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_data_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_ffrtmphttp_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_file_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_ftp_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_gopher_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_hls_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_http_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_httpproxy_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_icecast_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_mmsh_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_mmst_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_md5_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_pipe_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_prompeg_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_rtmp_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_rtmpt_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_rtp_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_srtp_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_subfile_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_tee_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_tcp_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_udp_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_udplite_protocol,</span></span><br><span class="line">    <span class="meta">&amp;ff_unix_protocol,</span></span><br><span class="line">    <span class="literal">NULL</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>看下ff_rtmp_protocol:如何被定义：rtmpproto.c:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#define <span class="constructor">RTMP_PROTOCOL_0(<span class="params">flavor</span>)</span></span><br><span class="line">#define <span class="constructor">RTMP_PROTOCOL_1(<span class="params">flavor</span>)</span>                  \</span><br><span class="line">static const AVClass flavor##_class = &#123;          \</span><br><span class="line">    .class_name = #flavor,                       \</span><br><span class="line">    .item_name  = av_default_item_name,          \</span><br><span class="line">    .option     = rtmp_options,                  \</span><br><span class="line">    .version    = LIBAVUTIL_VERSION_INT,         \</span><br><span class="line">&#125;;                                               \</span><br><span class="line">                                                 \</span><br><span class="line">const URLProtocol ff_##flavor##_protocol = &#123;     \</span><br><span class="line">    .name           = #flavor,                   \</span><br><span class="line">    .url_open2      = rtmp_open,                 \</span><br><span class="line">    .url_read       = rtmp_read,                 \</span><br><span class="line">    .url_read_seek  = rtmp_seek,                 \</span><br><span class="line">    .url_read_pause = rtmp_pause,                \</span><br><span class="line">    .url_write      = rtmp_write,                \</span><br><span class="line">    .url_close      = rtmp_close,                \</span><br><span class="line">    .priv_data_size = sizeof(RTMPContext),       \</span><br><span class="line">    .flags          = URL_PROTOCOL_FLAG_NETWORK, \</span><br><span class="line">    .priv_data_class= &amp;flavor##_class,           \</span><br><span class="line">&#125;;</span><br><span class="line">#define <span class="constructor">RTMP_PROTOCOL_2(<span class="params">flavor</span>, <span class="params">enabled</span>)</span>         \</span><br><span class="line">    RTMP_PROTOCOL_ ## enabled(flavor)</span><br><span class="line">#define <span class="constructor">RTMP_PROTOCOL_3(<span class="params">flavor</span>, <span class="params">config</span>)</span>          \</span><br><span class="line">    <span class="constructor">RTMP_PROTOCOL_2(<span class="params">flavor</span>, <span class="params">config</span>)</span></span><br><span class="line">#define <span class="constructor">RTMP_PROTOCOL(<span class="params">flavor</span>, <span class="params">uppercase</span>)</span>         \</span><br><span class="line">    <span class="constructor">RTMP_PROTOCOL_3(<span class="params">flavor</span>, CONFIG_ ## <span class="params">uppercase</span> ## <span class="params">_PROTOCOL</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="constructor">RTMP_PROTOCOL(<span class="params">rtmp</span>,   RTMP)</span></span><br><span class="line"><span class="constructor">RTMP_PROTOCOL(<span class="params">rtmpe</span>,  RTMPE)</span></span><br><span class="line"><span class="constructor">RTMP_PROTOCOL(<span class="params">rtmps</span>,  RTMPS)</span></span><br><span class="line"><span class="constructor">RTMP_PROTOCOL(<span class="params">rtmpt</span>,  RTMPT)</span></span><br><span class="line"><span class="constructor">RTMP_PROTOCOL(<span class="params">rtmpte</span>, RTMPTE)</span></span><br><span class="line"><span class="constructor">RTMP_PROTOCOL(<span class="params">rtmpts</span>, RTMPTS)</span></span><br><span class="line"></span><br><span class="line">在protocols.c  支持各种网络协议： rtmp,rtp等等</span><br><span class="line">extern const URLProtocol ff_async_protocol;</span><br><span class="line">extern const URLProtocol ff_bluray_protocol;</span><br><span class="line">extern const URLProtocol ff_cache_protocol;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>跟踪如何找到URLProtocol 实例：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">io_open_default</span>-&gt;</span></span><br><span class="line">  <span class="function"><span class="title">ffio_open_whitelist</span>-&gt;</span></span><br><span class="line">    <span class="function"><span class="title">ffurl_open_whitelist</span>-&gt;</span></span><br><span class="line">      <span class="function"><span class="title">ffurl_alloc</span>(puc, filename, flags, int_cb);-&gt;</span></span><br><span class="line">        p = url_find_protocol(filename);<span class="comment">//从url_protocol数组中返回一组protocol后，匹配.name和filename挑选一个</span></span><br><span class="line">          url_alloc_for_protocol <span class="comment">//填充</span></span><br><span class="line"></span><br><span class="line">    ffurl_connect</span><br><span class="line">        <span class="function"><span class="title">uc</span>-&gt;</span><span class="function"><span class="title">prot</span>-&gt;</span><span class="function"><span class="title">url_open2</span> ? uc-&gt;</span><span class="function"><span class="title">prot</span>-&gt;</span>url_open2(...)</span><br><span class="line">        <span class="function"><span class="title">uc</span>-&gt;</span><span class="function"><span class="title">prot</span>-&gt;</span>url_open(...)</span><br><span class="line">          -&gt;int rtmp_open(URLContext *s,</span><br><span class="line">           <span class="comment">//把s-&gt;stream-&gt;prot 设置为tcp_protocol 的，这样在发送和接收时都是用的tcp_write和tcp_send</span></span><br><span class="line">           &#123;</span><br><span class="line">             <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* open the tcp connection */</span></span><br><span class="line">                <span class="keyword">if</span> (port &lt; <span class="number">0</span>)</span><br><span class="line">                    port = RTMP_DEFAULT_PORT;</span><br><span class="line">                <span class="function"><span class="title">if</span> (rt-&gt;</span>listen)</span><br><span class="line">                    ff_url_join(buf, sizeof(buf), <span class="string">&quot;tcp&quot;</span>, NULL, hostname, port,</span><br><span class="line">                                <span class="string">&quot;?listen&amp;listen_timeout=%d&amp;tcp_nodelay=%d&quot;</span>,</span><br><span class="line">                                <span class="function"><span class="title">rt</span>-&gt;</span><span class="function"><span class="title">listen_timeout</span> * 1000, rt-&gt;</span>tcp_nodelay);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="function"><span class="title">ff_url_join</span>(buf, sizeof(buf), &quot;tcp&quot;, NULL, hostname, port, &quot;?tcp_nodelay=%d&quot;, rt-&gt;</span>tcp_nodelay);</span><br><span class="line">           &#125;</span><br><span class="line">具体连接的图，见上面；</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>实际运行bt:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">推流到<span class="selector-tag">url</span> 或者说输出的场景：</span><br><span class="line"><span class="selector-tag">Breakpoint</span> <span class="number">4</span>, <span class="selector-tag">tcp_write</span> (h=<span class="number">0</span>x55555715fc80, buf=<span class="number">0</span>x55555713d0c0 <span class="string">&quot;\002&quot;</span>, size=<span class="number">387</span>) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">tcp</span><span class="selector-class">.c</span>:<span class="number">253</span></span><br><span class="line"><span class="number">253</span>	<span class="selector-tag">static</span> <span class="selector-tag">int</span> <span class="selector-tag">tcp_write</span>(URLContext *h, const uint8_t *buf, int size)</span><br><span class="line">(gdb) <span class="selector-tag">bt</span></span><br><span class="line"><span class="selector-id">#0</span>  <span class="selector-tag">tcp_write</span> (h=<span class="number">0</span>x55555715fc80, buf=<span class="number">0</span>x55555713d0c0 <span class="string">&quot;\002&quot;</span>, size=<span class="number">387</span>) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">tcp</span><span class="selector-class">.c</span>:<span class="number">253</span></span><br><span class="line"><span class="selector-id">#1</span>  <span class="selector-tag">tcp_write</span> (h=h<span class="variable">@entry</span>=<span class="number">0</span>x55555715fc80, buf=buf<span class="variable">@entry</span>=<span class="number">0</span>x55555713d0c0 <span class="string">&quot;\002&quot;</span>, size=size<span class="variable">@entry</span>=<span class="number">387</span>) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">tcp</span><span class="selector-class">.c</span>:<span class="number">253</span></span><br><span class="line"><span class="selector-id">#2</span>  <span class="number">0</span><span class="selector-tag">x0000555555954baa</span> <span class="selector-tag">in</span> <span class="selector-tag">retry_transfer_wrapper</span> (transfer_func=<span class="number">0</span>x555555a77f30 &lt;tcp_write&gt;, size_min=<span class="number">387</span>, size=<span class="number">387</span>, buf=<span class="number">0</span>x55555713d0c0 <span class="string">&quot;\002&quot;</span>, h=<span class="number">0</span>x55555715fc80) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">avio</span><span class="selector-class">.c</span>:<span class="number">370</span></span><br><span class="line"><span class="selector-id">#3</span>  <span class="selector-tag">ffurl_write</span> (h=<span class="number">0</span>x55555715fc80, buf=<span class="number">0</span>x55555713d0c0 <span class="string">&quot;\002&quot;</span>, size=<span class="number">387</span>) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">avio</span><span class="selector-class">.c</span>:<span class="number">423</span></span><br><span class="line"><span class="selector-id">#4</span>  <span class="number">0</span><span class="selector-tag">x0000555555ac2bf0</span> <span class="selector-tag">in</span> <span class="selector-tag">ff_rtmp_packet_write</span> (h=<span class="number">0</span>x55555715fc80, pkt=<span class="number">0</span>x5555570e13b8, chunk_size=<span class="number">60000</span>, prev_pkt_ptr=&lt;optimized out&gt;, nb_prev_pkt=&lt;optimized out&gt;) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">rtmppkt</span><span class="selector-class">.c</span>:<span class="number">388</span></span><br><span class="line"><span class="selector-id">#5</span>  <span class="number">0</span><span class="selector-tag">x0000555555a4af67</span> <span class="selector-tag">in</span> <span class="selector-tag">rtmp_send_packet</span> (track=<span class="number">0</span>, pkt=<span class="number">0</span>x5555570e13b8, rt=<span class="number">0</span>x5555570e1340) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">rtmpproto</span><span class="selector-class">.c</span>:<span class="number">3050</span></span><br><span class="line"><span class="selector-id">#6</span>  <span class="selector-tag">rtmp_write</span> (s=s<span class="variable">@entry</span>=<span class="number">0</span>x555557163c40, buf=buf<span class="variable">@entry</span>=<span class="number">0</span>x5555570cc100 <span class="string">&quot;FLV\001\005&quot;</span>, size=size<span class="variable">@entry</span>=<span class="number">479</span>) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">rtmpproto</span><span class="selector-class">.c</span>:<span class="number">3050</span></span><br><span class="line"><span class="selector-id">#7</span>  <span class="number">0</span><span class="selector-tag">x0000555555954baa</span> <span class="selector-tag">in</span> <span class="selector-tag">retry_transfer_wrapper</span> (transfer_func=<span class="number">0</span>x555555a4aca0 &lt;rtmp_write&gt;, size_min=<span class="number">479</span>, size=<span class="number">479</span>, buf=<span class="number">0</span>x5555570cc100 <span class="string">&quot;FLV\001\005&quot;</span>, h=<span class="number">0</span>x555557163c40) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">avio</span><span class="selector-class">.c</span>:<span class="number">370</span></span><br><span class="line"><span class="selector-id">#8</span>  <span class="selector-tag">ffurl_write</span> (h=<span class="number">0</span>x555557163c40, buf=<span class="number">0</span>x5555570cc100 <span class="string">&quot;FLV\001\005&quot;</span>, size=<span class="number">479</span>) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">avio</span><span class="selector-class">.c</span>:<span class="number">423</span></span><br><span class="line"><span class="selector-id">#9</span>  <span class="number">0</span><span class="selector-tag">x00005555559550e7</span> <span class="selector-tag">in</span> <span class="selector-tag">writeout</span> (s=s<span class="variable">@entry</span>=<span class="number">0</span>x55555713d380, data=&lt;optimized out&gt;, len=<span class="number">479</span>) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">aviobuf</span><span class="selector-class">.c</span>:<span class="number">163</span></span><br><span class="line"><span class="selector-id">#10</span> <span class="number">0</span><span class="selector-tag">x0000555555955e73</span> <span class="selector-tag">in</span> <span class="selector-tag">flush_buffer</span> (s=<span class="number">0</span>x55555713d380) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">aviobuf</span><span class="selector-class">.c</span>:<span class="number">184</span></span><br><span class="line"><span class="selector-id">#11</span> <span class="selector-tag">avio_flush</span> (s=<span class="number">0</span>x55555713d380) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">aviobuf</span><span class="selector-class">.c</span>:<span class="number">241</span></span><br><span class="line"><span class="selector-id">#12</span> <span class="number">0</span><span class="selector-tag">x00005555559569a0</span> <span class="selector-tag">in</span> <span class="selector-tag">avio_write_marker</span> (s=&lt;optimized out&gt;, time=&lt;optimized out&gt;, type=&lt;optimized out&gt;) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">aviobuf</span><span class="selector-class">.c</span>:<span class="number">480</span></span><br><span class="line"><span class="selector-id">#13</span> <span class="number">0</span><span class="selector-tag">x0000555555a086a8</span> <span class="selector-tag">in</span> <span class="selector-tag">flush_if_needed</span> (s=<span class="number">0</span>x555557178c00) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">mux</span><span class="selector-class">.c</span>:<span class="number">437</span></span><br><span class="line"><span class="selector-id">#14</span> <span class="selector-tag">avformat_write_header</span> (s=<span class="number">0</span>x555557178c00, options=&lt;optimized out&gt;) <span class="selector-tag">at</span> <span class="selector-tag">libavformat</span>/<span class="selector-tag">mux</span><span class="selector-class">.c</span>:<span class="number">487</span></span><br><span class="line"><span class="selector-id">#15</span> <span class="number">0</span><span class="selector-tag">x00005555556f5783</span> <span class="selector-tag">in</span> <span class="selector-tag">check_init_output_file</span> (of=<span class="number">0</span>x5555571944c0, file_index=<span class="number">0</span>) <span class="selector-tag">at</span> <span class="selector-tag">fftools</span>/<span class="selector-tag">ffmpeg</span><span class="selector-class">.c</span>:<span class="number">3049</span></span><br><span class="line"><span class="selector-id">#16</span> <span class="number">0</span><span class="selector-tag">x00005555556f698d</span> <span class="selector-tag">in</span> <span class="selector-tag">init_output_stream</span> (ost=&lt;optimized out&gt;, frame=&lt;optimized out&gt;, error=&lt;optimized out&gt;, error_len=<span class="number">1024</span>) <span class="selector-tag">at</span> <span class="selector-tag">fftools</span>/<span class="selector-tag">ffmpeg</span><span class="selector-class">.c</span>:<span class="number">3724</span></span><br><span class="line"><span class="selector-id">#17</span> <span class="number">0</span><span class="selector-tag">x00005555556f8b5d</span> <span class="selector-tag">in</span> <span class="selector-tag">init_output_stream_wrapper</span> (fatal=<span class="number">0</span>, frame=<span class="number">0</span>x0, ost=<span class="number">0</span>x555557163080) <span class="selector-tag">at</span> <span class="selector-tag">fftools</span>/<span class="selector-tag">ffmpeg</span><span class="selector-class">.c</span>:<span class="number">992</span></span><br><span class="line"><span class="selector-id">#18</span> <span class="selector-tag">transcode_init</span> () <span class="selector-tag">at</span> <span class="selector-tag">fftools</span>/<span class="selector-tag">ffmpeg</span><span class="selector-class">.c</span>:<span class="number">3802</span></span><br><span class="line"><span class="selector-id">#19</span> <span class="number">0</span><span class="selector-tag">x00005555556fd46e</span> <span class="selector-tag">in</span> <span class="selector-tag">transcode</span> () <span class="selector-tag">at</span> <span class="selector-tag">fftools</span>/<span class="selector-tag">ffmpeg</span><span class="selector-class">.c</span>:<span class="number">4801</span></span><br><span class="line"><span class="selector-id">#20</span> <span class="number">0</span><span class="selector-tag">x00005555556d6e6b</span> <span class="selector-tag">in</span> <span class="selector-tag">main</span> (argc=<span class="number">10</span>, argv=<span class="number">0</span>x7fffffffe108) <span class="selector-tag">at</span> <span class="selector-tag">fftools</span>/<span class="selector-tag">ffmpeg</span><span class="selector-class">.c</span>:<span class="number">5035</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="分析读取文件解析容器格式框架："><a href="#分析读取文件解析容器格式框架：" class="headerlink" title="分析读取文件解析容器格式框架："></a>分析读取文件解析容器格式框架：</h3><p>对应：avformat_open_input ,对应上面调用init_input下子过程<br>读取文件内容解析成flv或其他容器格式： AVPacket的过程：<br>对应结构：AVInputFormat<br>相关结构：猜测容器格式？通过扩展名。 allformats.c 中罗列了所有的扩展名下的容器格式处理结构；</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="built_in">AVOutputFormat</span> ff_flac_muxer;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="built_in">AVInputFormat</span>  ff_flic_demuxer;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="built_in">AVInputFormat</span>  ff_flv_demuxer;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="built_in">AVOutputFormat</span> ff_flv_muxer;</span><br><span class="line">。。。。</span><br></pre></td></tr></table></figure>
<p>demuxer_list结构，在编译后生成：libavformat&#x2F;demuxer_list.c:</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">static const AVInputFormat * const demuxer_list[] = &#123;</span><br><span class="line">    <span class="meta">&amp;ff_aa_demuxer,</span></span><br><span class="line">    <span class="meta">&amp;ff_aac_demuxer,</span></span><br><span class="line">    <span class="meta">&amp;ff_aax_demuxer,</span></span><br><span class="line">    <span class="meta">&amp;ff_ac3_demuxer,</span></span><br><span class="line">    <span class="meta">&amp;ff_ace_demuxer,</span></span><br><span class="line">...</span><br><span class="line">    <span class="meta">&amp;ff_flic_demuxer,</span></span><br><span class="line">    <span class="meta">&amp;ff_flv_demuxer,</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>相关逻辑深入：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">AVInputFormat</span> *av_probe_input_format2(<span class="keyword">const</span> <span class="built_in">AVProbeData</span> *pd,</span><br><span class="line">                                            <span class="type">int</span> is_opened, <span class="type">int</span> *score_max) <span class="comment">//用来匹配扩展名找到对应的处理结构 AVInputFormat,这样在后面调用 av_probe_input_buffer2 中的avio_read 时可以对应到具体格式的函数，填充好格式。</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> score_ret;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">AVInputFormat</span> *fmt = av_probe_input_format3(pd, is_opened, &amp;score_ret);</span><br><span class="line">    <span class="keyword">if</span> (score_ret &gt; *score_max) &#123;</span><br><span class="line">        *score_max = score_ret;</span><br><span class="line">        <span class="keyword">return</span> fmt;</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="寻找解码器的过程："><a href="#寻找解码器的过程：" class="headerlink" title="寻找解码器的过程："></a>寻找解码器的过程：</h3><p>对应open_input_file的子过程：avformat_find_stream_info<br>关键结构：AVCodec<br>allcodecs.c</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="built_in">AVCodec</span> ff_h264_amf_encoder;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="built_in">AVCodec</span> ff_h264_cuvid_decoder;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="built_in">AVCodec</span> ff_aac_mf_encoder;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> <span class="built_in">AVCodec</span> ff_ac3_mf_encoder;</span><br><span class="line">...一堆解码器编码器</span><br></pre></td></tr></table></figure>
<p>codec_list数组，libavcodec&#x2F;codec_list.c</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static const AVCodec * const codec_list[] = &#123;</span><br><span class="line">    <span class="meta">&amp;ff_a64multi_encoder,</span></span><br><span class="line">    <span class="meta">&amp;ff_a64multi5_encoder,</span></span><br><span class="line">    <span class="meta">&amp;ff_alias_pix_encoder,</span></span><br><span class="line">    <span class="meta">&amp;ff_amv_encoder,</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">&amp;ff_h264_decoder,</span></span><br><span class="line">    <span class="meta">&amp;ff_h264_v4l2m2m_decoder</span></span><br></pre></td></tr></table></figure>
<p>关键逻辑：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">codec = find<span class="constructor">_probe_decoder(<span class="params">ic</span>, <span class="params">st</span>, <span class="params">st</span>-&gt;<span class="params">codecpar</span>-&gt;<span class="params">codec_id</span>)</span>;</span><br><span class="line">   codec = find<span class="constructor">_decoder(<span class="params">s</span>, <span class="params">st</span>, <span class="params">codec_id</span>)</span>;</span><br><span class="line">      avcodec<span class="constructor">_find_decoder(<span class="params">codec_id</span>)</span>;</span><br><span class="line">        从而在codec_list中找到合适的解码器，返回。</span><br></pre></td></tr></table></figure>


<h4 id="一些结构解释："><a href="#一些结构解释：" class="headerlink" title="一些结构解释："></a>一些结构解释：</h4><p>AVStream 是流的结构，一个流一个实例，其中这个结构中有AVStreamInternal ，其中又AVCodecContext，<br>即含有编码解码相关结构；</p>
<h3 id="一个场景例子："><a href="#一个场景例子：" class="headerlink" title="一个场景例子："></a>一个场景例子：</h3><p>输入一个url rtmp&#x2F;其他的网上的流， 转码，转封装后，推流到网上。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-re -i <span class="keyword">source</span>.flv  -<span class="keyword">c</span> <span class="keyword">copy</span> -<span class="keyword">f</span> flv -<span class="keyword">y</span>  rtmp://localhos<span class="variable">t:1936</span>/live/livestream</span><br><span class="line"></span><br><span class="line">-re (<span class="built_in">input</span>)</span><br><span class="line">Read <span class="built_in">input</span> at native frame rate. This <span class="keyword">is</span> equivalent <span class="keyword">to</span> setting -readrate <span class="number">1</span>.</span><br><span class="line">-i <span class="built_in">input</span></span><br><span class="line">-<span class="keyword">c</span> <span class="keyword">copy</span> </span><br><span class="line"><span class="keyword">copy</span> <span class="keyword">all</span> stream </span><br><span class="line">-<span class="keyword">f</span> fmt (<span class="built_in">input</span>/output)</span><br><span class="line">Force <span class="built_in">input</span> <span class="built_in">or</span> output <span class="keyword">file</span> format. The format <span class="keyword">is</span> normally auto detected <span class="keyword">for</span> <span class="built_in">input</span> <span class="keyword">files</span> <span class="built_in">and</span> guessed from the <span class="keyword">file</span> extension <span class="keyword">for</span> output <span class="keyword">files</span>, <span class="keyword">so</span> this option <span class="keyword">is</span> not needed in most cases.</span><br><span class="line"></span><br><span class="line">-i url (<span class="built_in">input</span>)</span><br><span class="line"><span class="built_in">input</span> <span class="keyword">file</span> url</span><br><span class="line"></span><br><span class="line">-<span class="keyword">y</span> (<span class="keyword">global</span>)</span><br><span class="line">Overwrite output <span class="keyword">files</span> without asking.</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="关于封装，更多："><a href="#关于封装，更多：" class="headerlink" title="关于封装，更多："></a>关于封装，更多：</h3><p>封装和头： mux.c</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">int avformat_write_header(AVFormatContext *s, AVDictionary **options)</span><br><span class="line">&#123;</span><br><span class="line">    int ret = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="title">int</span> already_initialized = s-&gt;</span><span class="function"><span class="title">internal</span>-&gt;</span>initialized;</span><br><span class="line">    <span class="function"><span class="title">int</span> streams_already_initialized = s-&gt;</span><span class="function"><span class="title">internal</span>-&gt;</span>streams_initialized;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!already_initialized)</span><br><span class="line">        <span class="keyword">if</span> ((ret = avformat_init_output(s, options)) &lt; <span class="number">0</span>)</span><br><span class="line">            return ret;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (!(s-&gt;</span><span class="function"><span class="title">oformat</span>-&gt;</span><span class="function"><span class="title">flags</span> &amp; AVFMT_NOFILE) &amp;&amp; s-&gt;</span>pb)</span><br><span class="line">        <span class="function"><span class="title">avio_write_marker</span>(s-&gt;</span>pb, AV_NOPTS_VALUE, AVIO_DATA_MARKER_HEADER);</span><br><span class="line">    <span class="function"><span class="title">if</span> (s-&gt;</span><span class="function"><span class="title">oformat</span>-&gt;</span>write_header) &#123;</span><br><span class="line">        <span class="function"><span class="title">ret</span> = s-&gt;</span><span class="function"><span class="title">oformat</span>-&gt;</span>write_header(s);  <span class="comment">//找到对应的实例然后调用对应函数</span></span><br><span class="line">        <span class="function"><span class="title">if</span> (ret &gt;= 0 &amp;&amp; s-&gt;</span><span class="function"><span class="title">pb</span> &amp;&amp; s-&gt;</span><span class="function"><span class="title">pb</span>-&gt;</span>error &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="function"><span class="title">ret</span> = s-&gt;</span><span class="function"><span class="title">pb</span>-&gt;</span>error;</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">            goto fail;</span><br><span class="line">        flush_if_needed(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">if</span> (!(s-&gt;</span><span class="function"><span class="title">oformat</span>-&gt;</span><span class="function"><span class="title">flags</span> &amp; AVFMT_NOFILE) &amp;&amp; s-&gt;</span>pb)</span><br><span class="line">        <span class="function"><span class="title">avio_write_marker</span>(s-&gt;</span>pb, AV_NOPTS_VALUE, AVIO_DATA_MARKER_UNKNOWN);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (!s-&gt;</span><span class="function"><span class="title">internal</span>-&gt;</span>streams_initialized) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((ret = init_pts(s)) &lt; <span class="number">0</span>)</span><br><span class="line">            goto fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return streams_already_initialized;</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">    deinit_muxer(s);</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>音频格式中的头怎么封装的？ 其实是 AVFormatContext 中的AVFormatContext 成员，<br>在识别文件名或输入的格式后，去找对应的AVOutputFormat ,预定义的：<br>如： adtsenc.c:</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">const AVOutputFormat ff_adts_muxer = &#123;</span><br><span class="line">    .name              = <span class="string">&quot;adts&quot;</span>,</span><br><span class="line">    .long_name         = NULL_IF_CONFIG_SMALL(<span class="string">&quot;ADTS AAC (Advanced Audio Coding)&quot;</span>),</span><br><span class="line">    .mime_type         = <span class="string">&quot;audio/aac&quot;</span>,</span><br><span class="line">    .extensions        = <span class="string">&quot;aac,adts&quot;</span>,</span><br><span class="line">    .priv_data_size    = sizeof(ADTSContext),</span><br><span class="line">    .audio_codec       = AV_CODEC_ID_AAC,</span><br><span class="line">    .video_codec       = AV_CODEC_ID_NONE,</span><br><span class="line">    .init              = adts_init,</span><br><span class="line">    .write_header      = adts_write_header,</span><br><span class="line">    .write_packet      = adts_write_packet,</span><br><span class="line">    .write_trailer     = adts_write_trailer,</span><br><span class="line">    .priv_class        = <span class="variable">&amp;adts_muxer_class</span>,</span><br><span class="line">    .flags             = AVFMT_NOTIMESTAMPS,</span><br><span class="line">&#125;;</span><br><span class="line">adts_write_packet--&gt;</span><br><span class="line">static int adts_write_frame_header(ADTSContext <span class="comment">*ctx,</span></span><br><span class="line"><span class="comment">                                   uint8_t *buf, int size, int pce_size)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    PutBitContext pb;</span></span><br><span class="line"></span><br><span class="line">    unsigned full_frame_size = (unsigned)ADTS_HEADER_SIZE + size + pce_size;</span><br><span class="line">    <span class="keyword">if</span> (full_frame_size &gt; ADTS_MAX_FRAME_BYTES) &#123;</span><br><span class="line">        av_<span class="meta">log</span>(<span class="keyword">NULL</span>, AV_LOG_ERROR, <span class="string">&quot;ADTS frame size too large: %u (max %d)\n&quot;</span>,</span><br><span class="line">               full_frame_size, ADTS_MAX_FRAME_BYTES);</span><br><span class="line">        <span class="keyword">return</span> AVERROR_INVALIDDATA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    init_put_bits(<span class="variable">&amp;pb</span>, buf, ADTS_HEADER_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* adts_fixed_header */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 12, 0xfff);   <span class="comment">/* syncword */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 1, ctx-&gt;mpeg_id); <span class="comment">/* ID */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 2, 0);        <span class="comment">/* layer */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 1, 1);        <span class="comment">/* protection_absent */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 2, ctx-&gt;objecttype); <span class="comment">/* profile_objecttype */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 4, ctx-&gt;sample_rate_index);</span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 1, 0);        <span class="comment">/* private_bit */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 3, ctx-&gt;channel_conf); <span class="comment">/* channel_configuration */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 1, 0);        <span class="comment">/* original_copy */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 1, 0);        <span class="comment">/* home */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* adts_variable_header */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 1, 0);        <span class="comment">/* copyright_identification_bit */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 1, 0);        <span class="comment">/* copyright_identification_start */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 13, full_frame_size); <span class="comment">/* aac_frame_length */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 11, 0x7ff);   <span class="comment">/* adts_buffer_fullness */</span></span><br><span class="line">    put_bits(<span class="variable">&amp;pb</span>, 2, 0);        <span class="comment">/* number_of_raw_data_blocks_in_frame */</span></span><br><span class="line"></span><br><span class="line">    flush_put_bits(<span class="variable">&amp;pb</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更多格式：<br>allformats.c:<br>还有类似flac等，都可以在这里查到解封装和封装，主要是头，和编解码无关。</p>
<hr>
<h3 id="编解码更多："><a href="#编解码更多：" class="headerlink" title="编解码更多："></a>编解码更多：</h3><p>MPEG2编码器对应的AVCodec结构体ff_mpeg2video_encoder：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">init</span>() -&gt; <span class="built_in">encode_init</span>()</span><br><span class="line"><span class="built_in">encode2</span>() -&gt; <span class="built_in">ff_mpv_encode_picture</span>()</span><br><span class="line"><span class="built_in">close</span>() -&gt; <span class="built_in">ff_mpv_encode_end</span>()</span><br></pre></td></tr></table></figure>
<p>mpeg12enc.c:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">const AVCodec ff_mpeg1video_encoder = &#123;</span><br><span class="line"><span class="meta">    .name</span>                 = <span class="string">&quot;mpeg1video&quot;</span>,</span><br><span class="line"><span class="meta">    .long_name</span>            = NULL_IF_CONFIG_SMALL(<span class="string">&quot;MPEG-1 video&quot;</span>),</span><br><span class="line"><span class="meta">    .type</span>                 = AVMEDIA_TYPE_VIDEO,</span><br><span class="line"><span class="meta">    .id</span>                   = AV_CODEC_ID_MPEG1VIDEO,</span><br><span class="line"><span class="meta">    .priv_data_size</span>       = sizeof(MpegEncContext),</span><br><span class="line"><span class="meta">    .init</span>                 = encode_init,</span><br><span class="line"><span class="meta">    .encode2</span>              = ff_mpv_encode_picture,</span><br><span class="line"><span class="meta">    .close</span>                = ff_mpv_encode_end,</span><br><span class="line"><span class="meta">    .supported_framerates</span> = ff_mpeg12_frame_rate_tab + <span class="number">1</span>,</span><br><span class="line"><span class="meta">    .pix_fmts</span>             = (const enum AVPixelFormat[]) &#123; AV_PIX_FMT_YUV420P,</span><br><span class="line">                                                           AV_PIX_FMT_NONE &#125;,</span><br><span class="line"><span class="meta">    .capabilities</span>         = AV_CODEC_CAP_DELAY | AV_CODEC_CAP_SLICE_THREADS,</span><br><span class="line"><span class="meta">    .caps_internal</span>        = FF_CODEC_CAP_INIT_THREADSAFE | FF_CODEC_CAP_INIT_CLEANUP,</span><br><span class="line"><span class="meta">    .priv_class</span>           = &amp;mpeg1_class,</span><br><span class="line">&#125;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">const AVCodec ff_mpeg2video_encoder = &#123;</span><br><span class="line"><span class="meta">    .name</span>                 = <span class="string">&quot;mpeg2video&quot;</span>,</span><br><span class="line"><span class="meta">    .long_name</span>            = NULL_IF_CONFIG_SMALL(<span class="string">&quot;MPEG-2 video&quot;</span>),</span><br><span class="line"><span class="meta">    .type</span>                 = AVMEDIA_TYPE_VIDEO,</span><br><span class="line"><span class="meta">    .id</span>                   = AV_CODEC_ID_MPEG2VIDEO,</span><br><span class="line"><span class="meta">    .priv_data_size</span>       = sizeof(MpegEncContext),</span><br><span class="line"><span class="meta">    .init</span>                 = encode_init,</span><br><span class="line"><span class="meta">    .encode2</span>              = ff_mpv_encode_picture,</span><br><span class="line"><span class="meta">    .close</span>                = ff_mpv_encode_end,</span><br><span class="line"><span class="meta">    .supported_framerates</span> = ff_mpeg2_frame_rate_tab,</span><br><span class="line"><span class="meta">    .pix_fmts</span>             = (const enum AVPixelFormat[]) &#123; AV_PIX_FMT_YUV420P,</span><br><span class="line">                                                           AV_PIX_FMT_YUV422P,</span><br><span class="line">                                                           AV_PIX_FMT_NONE &#125;,</span><br><span class="line"><span class="meta">    .capabilities</span>         = AV_CODEC_CAP_DELAY | AV_CODEC_CAP_SLICE_THREADS,</span><br><span class="line"><span class="meta">    .caps_internal</span>        = FF_CODEC_CAP_INIT_THREADSAFE | FF_CODEC_CAP_INIT_CLEANUP,</span><br><span class="line"><span class="meta">    .priv_class</span>           = &amp;mpeg2_class,</span><br><span class="line">&#125;<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>more: 见源码和官网</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ffmpeg/" rel="tag"># ffmpeg</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/03/ffmpeg-use/" rel="prev" title="ffmpeg_use">
      <i class="fa fa-chevron-left"></i> ffmpeg_use
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/04/04/webrtc-code/" rel="next" title="webrtc_code">
      webrtc_code <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#ffmpeg-%E6%BA%90%E7%A0%81%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">ffmpeg 源码简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ffmpeg%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="nav-number">2.</span> <span class="nav-text">ffmpeg源码结构图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ffmpeg-c%E5%88%86%E6%9E%90%EF%BC%9A"><span class="nav-number">3.</span> <span class="nav-text">ffmpeg.c分析：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E4%BD%93%EF%BC%9A"><span class="nav-number">3.1.</span> <span class="nav-text">总体：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90%E5%8F%82%E6%95%B0%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA"><span class="nav-number">3.2.</span> <span class="nav-text">解析参数，初始化输入输出</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BE%93%E5%85%A5%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="nav-number">3.2.1.</span> <span class="nav-text">初始化输入文件：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BE%93%E5%87%BA%EF%BC%9A"><span class="nav-number">3.2.2.</span> <span class="nav-text">初始化输出：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E4%B8%BB%E5%BE%AA%E7%8E%AF%EF%BC%9A"><span class="nav-number">3.3.</span> <span class="nav-text">分析主循环：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E8%BE%93%E5%85%A5url%E7%9A%84%E7%BB%93%E6%9E%84%E6%A1%86%E6%9E%B6%E6%9E%84%E5%BB%BA%EF%BC%9A"><span class="nav-number">4.</span> <span class="nav-text">分析输入url的结构框架构建：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%AE%B9%E5%99%A8%E6%A0%BC%E5%BC%8F%E6%A1%86%E6%9E%B6%EF%BC%9A"><span class="nav-number">5.</span> <span class="nav-text">分析读取文件解析容器格式框架：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BB%E6%89%BE%E8%A7%A3%E7%A0%81%E5%99%A8%E7%9A%84%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="nav-number">6.</span> <span class="nav-text">寻找解码器的过程：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E7%BB%93%E6%9E%84%E8%A7%A3%E9%87%8A%EF%BC%9A"><span class="nav-number">6.1.</span> <span class="nav-text">一些结构解释：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E5%9C%BA%E6%99%AF%E4%BE%8B%E5%AD%90%EF%BC%9A"><span class="nav-number">7.</span> <span class="nav-text">一个场景例子：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E5%B0%81%E8%A3%85%EF%BC%8C%E6%9B%B4%E5%A4%9A%EF%BC%9A"><span class="nav-number">8.</span> <span class="nav-text">关于封装，更多：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%A7%A3%E7%A0%81%E6%9B%B4%E5%A4%9A%EF%BC%9A"><span class="nav-number">9.</span> <span class="nav-text">编解码更多：</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="小兴"
      src="/images/headicon2.jpg">
  <p class="site-author-name" itemprop="name">小兴</p>
  <div class="site-description" itemprop="description">始于歧路，愿归于征途</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">90</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xdksx/" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xdksx&#x2F;" rel="noopener" target="_blank"><i class="fa fa-fw fa-github-square"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/ksance@gmail.com" title="E-Mail → ksance@gmail.com"><i class="fa fa-fw fa-envelope"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/572897439" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;572897439" rel="noopener" target="_blank"><i class="fa fa-fw fa-facebook"></i></a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      friendly link
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://yoursite.com/" title="http:&#x2F;&#x2F;yoursite.com" rel="noopener" target="_blank">Title</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小兴</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v6.1.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '06e6b70d396f6928e45a',
      clientSecret: 'cd03b7c657d50a5d76a7fa682c4f8eb48cb15fc3',
      repo        : 'xdksx.github.io',
      owner       : 'xdksx',
      admin       : ['xdksx'],
      id          : '10598f5e5bb0aa0df7f410a720554eeb',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
